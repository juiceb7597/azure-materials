#제 5장 Azure Network Watcher

##개요
- Azure는 VM(가상 머신), VPN(가상 사설망) 게이트웨이, ExpressRoute 연결, 가상 네트워크, 애플리케이션 게이트웨이와 같은 IaaS 리소스에 대한 네트워크 문제를 모니터링하고 해결하는 데 사용할 수 있는 Azure Network Watcher 서비스의 도구 모음을 제공합니다. 등등. 이러한 도구는 특정 시점 검사를 수행하여 지속적인 문제를 분석 및 해결하거나 시간 경과에 따른 가용성 및 대기 시간 추세를 모니터링, 분석 및 표시하여 성능을 최적화할 수 있습니다.
- 도구는 지속적으로 모니터링하거나 문제를 해결해야 하는 Azure IaaS 환경에서 발생하는 다양한 네트워킹 시나리오를 처리하기 위해 시간이 지남에 따라 발전해 왔습니다. 이러한 시나리오 중 일부는 다음과 같습니다.
    - VM에 대한 인바운드 및 아웃바운드 네트워크 트래픽 필터링을 분석하고 문제를 해결합니다.
    - IaaS 워크로드에 영향을 미치는 네트워크 라우팅 문제를 분석하고 문제를 해결합니다.
    - 대기 시간(Latency), 가용성 및 진단을 위해 IaaS 엔드포인트 또는 IaaS와 비 Azure 엔드포인트 간의 트래픽을 모니터링합니다.
    - 네트워크 성능을 향상시키기 위해 IP 흐름 로그 분석을 수행합니다.
    - Azure 게이트웨이에 대한 VPN 연결 문제를 해결합니다.
- 이러한 각 목표를 달성하기 위해 Network Watcher는 다음과 같은 모니터링, 진단 및 로깅 도구가 포함된 도구 세트를 제공합니다.
    - 연결 모니터
    - 토폴로지 모니터
    - IP 흐름 확인
    - NSG 진단
    - 보안 규칙 분석기(Security Rules Analyzer)
    - VPN 문제 해결사(Troubleshooter)
    - 패킷 캡처 도구
    - 연결 문제 해결사(Troubleshooter) 도구
    - NSG 흐름 로그 캡처

##주요 특징들
연결 모니터(Connection Monitor)
- 연결 모니터를 사용하면 Azure IaaS VM과 기타 Azure IaaS 워크로드 또는 끝점과 비 Azure 끝점 간의 통신을 정기적으로 모니터링하여 가용성, 대기 시간 및 성능 문제를 감지하고 진단할 수 있습니다. Azure 이외의 워크로드에는 다음이 포함될 수 있습니다.
    - Microsoft Log Analytics 에이전트가 배포된 서버
    - `portal.office.com`과 같은 FQDN(정규화된 도메인 이름)
    - `https://portal.azure.com`과 같은 URL(Uniform Resource Locator)
    - `23.11.197.159`와 같은 IPv4 주소(`www.microsoft.com`으로 확인됨)
- 정기적인 시간 간격으로 모니터링함으로써 연결 모니터는 작업 또는 서비스가 오프라인 상태가 되거나 연결할 수 없을 때 경고를 발행할 수 있습니다. 또한 연결 모니터는 여러 지역에서 대기 시간 정보를 수집하여 병목 현상을 식별하고 경고를 발행합니다. 이는 워크로드 호스팅 또는 마이그레이션을 위한 향후 계획에 도움이 될 수 있습니다.

토폴로지 모니터
- 토폴로지 모니터를 사용하면 가상 네트워크의 다양한 네트워크 구성 요소 간의 상호 연결을 시각적으로 표현할 수 있습니다. 이를 통해 네트워크 계층에서 다양한 서비스가 어떻게 연결되는지 더 잘 이해할 수 있습니다. 편집 및 공유 목적으로 SVG 형식으로 이 토폴로지를 쉽게 다운로드할 수 있습니다.
- 토폴로지 모니터를 사용하여 생성된 그림의 토폴로지 다이어그램은 세 개의 서브넷(기본값, SrcSubnet 및 DestSubnet)을 포함하는 가상 네트워크 VNET-01을 보여줍니다. 각 서브넷에는 단일 네트워크 인터페이스 카드(NIC)가 있는 하나의 VM이 있습니다. 그리고 각각에 연결된 단일 네트워크 보안 그룹(NSG)이 있습니다.

<img src="https://drive.google.com/uc?id=1l42WCOLaqKOS_Qo31qn93sVHucqK_T7V">

IP 흐름 확인(Flow Verify)
- IP 흐름 확인을 사용하여 Azure VM과의 트래픽 제한을 진단할 수 있습니다. 이 도구를 사용하여 트래픽 흐름을 분석하고 제한 사항을 식별하려면 다음 6개의 매개변수를 제공해야 합니다.
    - **프로토콜**: TCP 또는 UDP입니다.
    - **트래픽 방향**: 인바운드 또는 아웃바운드입니다.
    - **로컬 IP 주소**: 인바운드 테스트의 소스 또는 아웃바운드 테스트의 대상으로 사용할 로컬 IPv4 또는 IPv6 주소입니다.
    - **로컬 포트**: 범위는 0~65535입니다. 단일 정수 값이 필요합니다.
    - **원격 IP 주소**: 인바운드 테스트의 대상 또는 아웃바운드 테스트의 소스로 사용할 원격 IPv4 또는 IPv6 주소입니다.
    - **원격 포트**: 범위는 0~65535입니다. 단일 정수 값이 필요합니다.

NSG 진단
- NSG 진단 도구는 Azure 네트워크의 VM, VMSS 또는 애플리케이션 게이트웨이에 대한 보안 구성 문제를 진단하는 데 사용할 수 있습니다. 이 도구에는 VM 간 트래픽에서 발생하는 모든 NSG 규칙을 평가하는 데 사용되는 프로토콜, 트래픽 방향, 원본 및 대상 IP, 포트 세부 정보 등의 매개 변수 집합이 필요합니다.
- 각 규칙의 결과와 트래픽 허용 또는 거부 여부를 포함하여 이러한 규칙에 대한 자세한 분석을 제공합니다. 이를 통해 두 끝점 사이를 이동하는 트래픽 문제를 해결하고 해결 속도를 높이는 데 도움이 될 수 있습니다.

다음 홉
- 다음 홉은 대상 엔드포인트에 대한 트래픽 경로를 식별합니다. 예를 들어 트래픽을 인터넷 게이트웨이로 잘못 라우팅하는 대신 가상 네트워크 게이트웨이 또는 어플라이언스를 통해 라우팅하려는 경우 트래픽 라우팅 문제를 정확히 찾아내는 데 도움이 될 수 있습니다.
- 다음 홉은 엔드포인트와 연결된 라우팅 테이블도 식별합니다. 이 경로 테이블에는 시스템 경로 또는 특정 사용자 정의 경로에 관한 경로 세부 정보가 포함되어 있습니다.

효과적인 보안 규칙(Effective Security Rules)
- 서브넷 수준 및 NIC(네트워크 인터페이스 카드) 수준에서 NSG를 적용할 수 있습니다. 그러나 그렇게 하면 보안 규칙이 충돌하여 원치 않는 트래픽 제한이 발생할 수 있습니다. 효과적인 보안 규칙 도구는 특정 VM에 대해 연결된 모든 NSG에서 모든 보안 규칙을 식별하는 데 도움이 될 수 있습니다. 이는 필요에 따라 충돌하는 규칙을 식별하고 해결하는 데 도움이 될 수 있습니다. 효과적인 보안 규칙으로 식별된 각 트래픽 규칙에 대해 드릴다운하여 영향을 받는 소스 및 대상 IP 범위를 명확하게 식별할 수 있습니다.

VPN 문제 해결(Troubleshoot)
- VPN 게이트웨이를 배포하여 Azure 환경을 온-프레미스 환경이나 다른 클라우드 또는 다른 Azure 클래식 구독에서 호스팅되는 외부 환경과 연결할 수 있습니다. VPN 문제 해결을 사용하면 Azure 환경에서 VPN 게이트웨이를 사용하여 설정한 VPN 연결을 테스트하여 끊어지거나 실패한 연결을 식별할 수 있습니다. VPN 문제 해결이 작동하려면 각 연결에 대한 로그를 저장할 스토리지 계정을 정의해야 합니다. 그런 다음 스토리지 계정에서 로그를 다운로드하여 전체 트래픽 교환을 분석하고 통신 실패의 근본 원인을 식별할 수 있습니다.
- 현재 Azure에서는 단일 구독에 대해 한 번에 하나의 문제 해결 작업만 실행하도록 제한합니다.

패킷 캡처
- 트래픽 패턴을 분석하고, 네트워크 통계를 수집하고, 네트워크 침입을 식별하고, 네트워크 통신 이상 또는 문제를 해결하기 위해 VM과 주고받는 트래픽 요청 또는 패킷(모든 패킷 또는 특정 패킷)을 캡처해야 하는 경우가 있습니다. 패킷 캡처는 사용자가 지정한 패킷을 캡처하고 SIEM 또는 로그 모니터링 도구를 사용하여 분석하기 위해 Azure Storage 계정 또는 로컬 디바이스에 저장합니다. 패킷 캡처를 사용하려면 기록하려는 패킷을 식별하기 위해 특정 매개변수를 정의해야 합니다. 여기에는 다음이 포함됩니다.
    - 대상 VM
    - 로그 저장 위치
    - 패킷당 최대 바이트
    - 세션당 최대 바이트
    - 시간 제한(초)
- Packet Capture에는 Windows 및 Linux VM 모두에서 VM 확장인 AzureNetworkWatcherExtension이 필요합니다. Azure PowerShell, Azure CLI 및 JSON 템플릿을 사용하여 확장을 배포할 수 있습니다.

연결 문제 해결(Connection Troubleshoot)
- 연결 문제 해결을 사용하여 Azure VM, 애플리케이션 게이트웨이 또는 Bastion 호스트에서 다른 Azure VM, FQDN, URI 또는 IPv4 엔드포인트로의 직접 TCP 또는 ICMP 연결을 테스트할 수 있습니다. 연결 분석 외에도 연결 문제 해결은 분석 후 다음과 같은 특정 오류 정보를 제공합니다.
    - 높은 CPU 활용도
    - 높은 메모리 활용도
    - 잘못된 게스트 VM 방화벽 구성으로 인해 트래픽이 차단되었습니다.
    - DNS 이름 확인 문제
    - 규칙 이름과 함께 NSG 규칙으로 인해 차단된 트래픽
    - 시스템 정의(기본값) 또는 사용자 정의 라우팅으로 인해 트래픽이 삭제되었습니다.
- 연결 문제 해결을 통해 연결 문제의 근본 원인을 명확하게 파악함으로써 문제를 보다 신속하게 해결할 수 있습니다.
- 연결 모니터와 달리 연결 문제 해결은 진행 중인 문제에 대한 특정 시점 정보를 제공하므로 기록 추적보다는 이러한 시나리오에서 사용해야 합니다.
- 소스가 Windows 또는 Linux인지 여부에 관계없이 Azure VM인 경우 연결 문제 해결에서 테스트를 위해 VM에 액세스할 수 있도록 AzureNetworkWatcherExtension 가상 머신 확장을 배포해야 합니다.

NSG 흐름 로그
- Azure Network Watcher에는 환경 내의 모든 NSG 또는 서브넷을 통해 흐르는 네트워크 트래픽에 대한 정보를 기록하는 NSG 흐름 로그가 포함되어 있습니다. 시각화 도구(예: Power BI), SIEM 도구 또는 IDS를 사용하여 이 로그 데이터를 분석하여 성능 병목 현상, 침입 및 손상된 시스템을 식별할 수 있습니다.
- NSG 흐름 로그는 규정 준수를 위해 중요합니다. 이는 네트워크 내의 트래픽이 필요에 따라 격리되고 기업의 규정 준수 정책 및 지침을 준수하는지 확인하는 데 도움이 될 수 있습니다.
- NSG 흐름 로그는 OSI 모델의 전송 계층에서 작동하여 1분 간격으로 로그를 수집합니다. 이러한 로그에는 프로토콜, 원본 IP, 원본 포트, 대상 IP, 대상 포트, NIC 세부 정보, 패킷 허용 또는 거부에 대한 트래픽 결정, 처리량 정보 등 대상 NSG를 통과하는 트래픽에 대한 자세한 정보가 포함되어 있습니다. Azure 범용 v2 스토리지 계정을 사용하면 이러한 로그를 최대 1년 동안 보관할 수 있습니다.
- 중요한 워크로드를 호스팅하는 VM 또는 서브넷에 적용되는 모든 NSG에서 NSG 흐름 로그를 활성화하는 것이 좋습니다. NSG 흐름 로그는 워크로드로 이동하는 트래픽과 직접 상호 작용하지 않고 Azure 플랫폼에서 로깅 정보를 수집하므로 워크로드의 네트워크 성능에 영향을 주지 않습니다.
- NSG 흐름 로그는 긴 파일 이름을 자르므로 로그 정보가 사용자 환경과 정확하게 일치하지 않기 때문에 이벤트를 연관시키기가 어렵습니다. 이를 방지하려면 NSG 이름을 80자 미만으로 유지하세요.

진단 로그
- 진단 로그 도구는 VM NIC, 애플리케이션 게이트웨이, NSG 등을 포함하여 구독 내의 모든 네트워크 리소스에 대한 진단 로깅을 쉽게 활성화하거나 비활성화할 수 있는 단일 창을 제공합니다. 결과 로그를 Azure Storage 계정에 저장하거나, 이벤트 허브로 스트리밍하거나, 심층 분석을 위해 Log Analytics 작업 영역으로 보낼 수 있습니다. Power BI와 같은 도구를 사용하여 Azure Storage 계정에 저장된 로그를 분석할 수 있습니다.

#제6장 Azure Portal

##주요 특징들
- **GUI 기반 환경**: Azure Portal은 Azure 리소스를 구축하고 관리할 수 있는 중앙 집중식 GUI 웹 콘솔을 제공합니다.
- **안전한 SSL 기반 웹 포털**: Azure Portal은 포트 443 및 SSL을 통해 작동하여 모든 통신의 보안을 보장합니다.
- **탄력적인 설계**: Azure Portal은 모든 Azure 데이터 센터에 배포됩니다. 이렇게 하면 지역 중단으로 인해 전체 서비스가 오프라인 상태가 되는 일이 발생하지 않습니다. 서비스 업데이트는 지속적이며 가동 중지 시간 없이 작동하도록 설계되었습니다.
- **최신 브라우저 지원**: Azure 포털은 최신 버전의 Microsoft Edge, Google Chrome, Mozilla Firefox 및 Apple Safari를 포함한 모든 최신 브라우저를 사용하여 액세스할 수 있습니다.
- **모든 Azure 서비스 관리 지원**: Azure Portal은 모든 Azure 서비스의 전체 수명주기 관리를 지원합니다. 이는 대부분의 Azure 설계자 및 관리자를 위한 기본 액세스 방법입니다.
- **Cloud Shell 통합**: Cloud Shell은 Azure Portal 인터페이스 내부에 직접 통합되어 스크립트, bash 명령 및 자동화된 활동을 실행하기 위한 세션을 쉽게 시작할 수 있습니다.
- **액세스 관리를 위한 RBAC(역할 기반 액세스 제어)**: Azure Portal은 Azure Active Directory를 사용하여 Azure 서비스에 대한 세분화된 액세스를 제공하기 위해 RBAC를 제공합니다.
- **사용자 정의 가능한 대시보드**: Azure Portal을 통해 각 사용자는 자신의 필요에 따라 자신에게만 표시되는 대시보드를 생성하고 자신에게 가장 중요한 서비스를 모니터링할 수 있습니다. 또한 이러한 대시보드를 게시하고 공유하여 환경 전반에 걸쳐 일관된 보기를 제공할 수도 있습니다. 이러한 유연성은 생산성을 극대화합니다.
- **서비스 및 지역의 전역 보기**: Azure Portal은 모든 Azure 지역 및 서비스 전반에 걸쳐 서비스 상태에 대한 전역 보기를 제공합니다. 보기는 개별적으로 사용자 정의할 수 있습니다.
- **Azure Marketplace와의 통합**: Azure Portal은 Azure에서 타사 솔루션의 조달 및 배포를 지원하는 Azure Marketplace와 긴밀하게 통합됩니다.

Azure URL 허용 목록
- Azure 포털에는 서비스에 대한 성능과 연결이 영향을 받지 않도록 방화벽, 프록시 서버 및 이러한 서비스에 대한 트래픽을 처리하는 기타 중간 장치에 허용 목록에 추가해야 하는 다양한 URL이 있습니다. 이러한 URL에는 다음이 포함됩니다.
    - `*.aadcdn.microsoftonline-p.com`
    - `*.aka.ms`
    - `*.applicationinsights.io`
    - `*.azure.com`
    - `*.azure.net`
    - `*.azure-api.net`
    - `*.azuredatalakestore.net`
    - `*.azureedge.net`
    - `*.loganalytics.io`
    - `*.microsoft.com`
    - `*.microsoftonline.com`
    - `*.microsoftonline-p.com`
    - `*.msauth.net`
    - `*.msftauth.net`
    - `*.trafficmanager.net`
    - `*.visualstudio.com`
    - `*.asazure.windows.net`
    - `*.core.windows.net`
    - `*.database.windows.net`
    - `*.graph.windows.net`
    - `*.kusto.windows.net`
    - `*.search.windows.net`
    - `*.servicebus.windows.net`

##사용자 정의 및 유용성 개념과 고려 사항
Azure 포털 설정
- Azure 포털은 기본 보기 설정, 보고 관리하려는 구독 선택, 언어 및 지역 설정 지정, 프로필 정보 입력, 시간 초과 및 알림 제어를 위한 세션 기본 설정 설정을 위한 설정을 제공합니다. 이러한 설정을 통해 각 관리자는 Azure Portal을 사용할 때 기본 환경을 설정할 수 있습니다. Azure Portal 사용을 시작할 때 이러한 사항을 한 번 이상 검토하고 필요에 따라 조정하는 것이 좋습니다.

맞춤형 대시보드
- Azure Portal을 사용하면 사용자 지정 대시보드를 만들 수 있습니다. 여기에는 리소스 보기, 빠른 링크, 일상적인 작업에 대한 바로 가기, 중요한 메트릭, Azure 환경의 전반적인 상태에 대한 정보가 혼합되어 있을 수 있습니다.
- 각 관리자는 사용자 정의 대시보드를 생성하여 일상 업무에 가장 중요한 서비스, 리소스 및 정보를 볼 수 있습니다. 사용자 정의 대시보드는 팀 구성원 간에 공유할 수 있습니다. 공유 대시보드에 대한 업데이트는 해당 대시보드를 구독하는 모든 관리자가 사용할 수 있습니다.

Azure 마켓플레이스
- Azure Marketplace는 ISVs(Independent Software Vendors, 독립 소프트웨어 공급업체)로 알려진 타사 공급업체가 제공하는 수천 개의 IT 애플리케이션, 서비스 및 솔루션이 포함된 스토어입니다. 조직의 요구 사항에 따라 이러한 솔루션을 사용해 보고 구입할 수 있습니다. 사용 가능한 애플리케이션과 서비스는 Azure 리소스를 백업하는 소프트웨어 제품부터 이를 모니터링하고 관리하는 서비스까지 다양합니다.

도움말 및 지원(Help and support)
- Azure Portal에는 지원 계획을 구입하고, 지원 티켓을 인상하고, 서비스 상태를 모니터링하고, Azure Advisor 권장 사항을 검토하고, 무료 안내 및 지원을 위해 Azure 커뮤니티를 방문하고, 기타 많은 도움이 되는 리소스를 액세스하여 Azure에 대한 지식을 향상시킬 수 있는 도움말 및 지원 섹션이 있습니다

##모범 사례
- **RBAC 및 MFA를 사용하여 Azure Portal에 대한 액세스를 보호**: 제공된 RBAC 옵션을 사용하여 Azure Portal에 대한 액세스를 설정하는 것이 중요합니다. 개별 요구 사항에 따라 사용자의 액세스를 제한하는 여러 가지 기본 제공 그룹이 있습니다. 표준 기본 제공 그룹이 요구 사항을 충족하지 못하는 경우 사용자 지정 그룹을 만들 수도 있습니다. Azure Portal에 액세스하는 모든 사용자에 대해 MFA를 활성화해야 합니다. Azure MFA는 무료로 제공됩니다. 이 서비스를 사용하면 암호 위반으로 인해 Azure 환경에 대한 액세스가 열리지 않도록 할 수 있습니다.
- **필수 지역 또는 알려진 IP를 기반으로 액세스를 제한**: 다음 기준에 따라 Azure Portal에 대한 액세스를 제한하여 무차별 대입 공격으로부터 보호합니다.
    - 알려진 IP에서만 액세스를 허용합니다. 관리자가 알려진 허용 목록에 있는 IP만 사용하여 중앙에서 로그인하도록 합니다.
    - 알려진 봇넷 및 악성 IP로부터의 액세스를 차단합니다.
    - 관리자가 기반으로 있거나 환경에 액세스하는 지리적 위치에서만 액세스를 허용하십시오.
    - Azure Portal 로그에 따라 무차별 대입 공격을 시도하는 지리적 위치에서의 액세스를 차단합니다.
- 조직의 요구 사항에 따라 조건부 액세스를 사용하여 이를 수행할 수 있습니다.
    - **관리되는 장치의 액세스를 제한**: 직접적이고 완전한 관리, 모니터링 및 제어를 받는 장치로 Azure Portal에 대한 액세스를 제한하세요. 이는 Microsoft Intune 또는 Microsoft SCCM과 같은 MDM 솔루션으로 관리되는 장치일 수 있습니다. 조건부 액세스를 사용하면 관리되지 않는 장치에서 액세스를 시도하는지 여부를 식별하고 차단할 수 있습니다.
    - **정기 액세스 감사 수행**: 정기적인 내부 감사 프로세스를 구현하여 Azure Portal에 할당된 모든 관리자 액세스를 추적하고 검토합니다. 조직의 규모와 복잡성에 따라 월별, 분기별 또는 반기별 프로세스를 사용하면 더 이상 필요하지 않은 임시 액세스 권한을 제거하는 데 도움이 될 수 있습니다. 액세스 관리를 위한 자동화된 감사 솔루션을 사용하면 이 프로세스를 더 빠르고 정확하게 만들 수 있습니다.
    - **장기 로그 보존 설정**: Azure Portal 액세스 및 활동 로그는 90~180일 사이의 짧은 기간 동안 보존됩니다. 감사 및 규정 준수 검토를 위해 장기간 로그를 보관하려면 장기 로그 보관을 설정하세요.
    - **SIEM(보안 정보 및 이벤트 관리) 도구를 사용하여 액세스 및 활동을 모니터링**: SIEM 도구를 사용하여 Azure Portal에 대한 지속적인 공격 또는 원치 않는 액세스를 나타내는 패턴을 분석하고 식별합니다. Azure Sentinel은 Azure에서 제공되는 도구 중 하나입니다. 이를 달성하기 위해 다른 타사 서비스를 사용할 수도 있습니다.
