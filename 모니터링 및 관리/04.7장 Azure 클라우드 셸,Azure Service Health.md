#제 7장 Azure Cloud Shell

##개요
- 2017년 11월, Microsoft는 bash가 포함된 Azure Cloud Shell을 일반 공급하게 되었고, 2018년 10월에는 PowerShell 모듈을 일반 공급하게 되었습니다. Azure Cloud Shell은 bash를 실행하기 위한 브라우저 기반 셸과 Azure 리소스를 관리하기 위한 PowerShell cmdlet 및 스크립트를 제공합니다.
- Azure Cloud Shell은 RBAC(역할 기반 액세스 제어)를 사용하여 권한에 따른 액세스를 제공하는 대화형 환경을 제공합니다. 이는 사용자에게 전 세계 어디서나 모든 장치에서 클라우드 기반 명령줄 환경을 제공합니다. 백엔드에서 Microsoft는 Cloud Shell을 실행하는 각 사용자에게 무료 VM을 할당합니다. 이 동일한 VM은 서비스에 액세스하는 데 사용하는 도구를 통해 사용자에게 제공됩니다.

##주요 특징들
- **인증되고 안전한 액세스**: Cloud Shell은 Azure AD 서비스와 통합되므로 권한 수준에 따라 인증된 사용자에게 안전한 액세스를 제공할 수 있습니다.
- **bash 및 PowerShell 지원**: Cloud Shell은 bash와 PowerShell을 모두 지원하므로 조직이 스크립팅 및 자동화에 선호하는 언어를 더 쉽게 사용할 수 있습니다.
- **대부분의 최신 브라우저와 호환**: Cloud Shell은 최신 버전의 Microsoft Edge, Microsoft Internet Explorer, Apple Safari, Google Chrome, Firefox 등 가장 널리 사용되는 최신 브라우저와 호환됩니다.
- **통합 편집기(Integrated editor)**:Cloud Shell에는 오픈 소스 Monaco 편집기를 기반으로 하는 통합 그래픽 편집기가 있어 코드에서 스크립트를 쉽게 만들고 편집할 수 있습니다.
- **여러 서비스 연결 지점(Connection points)**: Cloud Shell은 Portal.azure.com, shell.azure.com, Azure PowerShell 연결 URL, Azure CLI 연결 URL 및 Visual Studio와 같은 다양한 연결 액세스 지점을 사용하여 액세스할 수 있습니다.
- **오픈 소스 도구 통합**: Cloud Shell은 Ansible, Chef, Terraform과 같은 오픈 소스 도구와 긴밀하게 통합되어 있습니다.
- **파일 지속성**: Cloud Shell은 Azure 파일 공유를 사용하여 세션 전체에서 파일 지속성을 지원합니다. 파일 공유 및 관련 연결을 한 번만 설정해야 하며 앞으로 매번 자동으로 다시 매핑됩니다.
- **무료 사용**: Microsoft는 Cloud Shell을 실행하는 각 사용자에게 백엔드의 무료 VM을 할당합니다.
- **저장 시 암호화**: Microsoft는 대부분의 조직의 규정 준수 요구 사항을 충족할 수 있도록 저장 시 이중 암호화로 모든 Cloud Shell 인프라를 암호화합니다.
- **여러 프로그래밍 언어 지원**: Cloud Shell은 .NET Core, Go, Java, Node.js, PowerShell, Python과 같은 여러 프로그래밍 언어의 사용을 지원합니다.

##사용 개념 및 고려 사항
- Azure Cloud Shell은 bash 또는 PowerShell 명령을 사용하여 Azure 서비스 배포 및 관리 작업을 자동화하는 데 도움이 됩니다. 서비스에 액세스하는 가장 쉬운 방법 중 하나는 Azure Portal을 이용하는 것입니다(테넌트에 로그인했다고 가정).
- 서비스 이용 시 주의사항은 다음과 같습니다.
    - 20분 동안 활동이 없으면 세션 시간이 초과됩니다.
    - Azure 파일 공유를 처음 사용할 때 탑재해야 합니다. Cloud Share는 앞으로도 해당 구성을 유지합니다. Bash 및 PowerShell 세션 모두에 동일한 공유가 사용됩니다.
    - `$HOME`은 셸에 연결된 Azure 파일 공유 내부에 탑재된 5GB 이미지로 유지됩니다. 이는 세션 중에 사용자가 저장한 파일 및 자격 증명을 포함하여 모든 사용자 데이터가 저장되는 홈 드라이브입니다.
    - bash 쉘을 사용할 때 사용자 권한은 일반 Linux 사용자로 설정됩니다.

Azure 파일 공유
- 파일, 액세스 토큰 및 자격 증명을 포함할 수 있는 홈 디렉터리를 저장하기 위해 각 Cloud Shell 사용자는 자신의 세션을 신규 또는 기존 Azure 파일 공유 스토리지 계정과 연결할 수 있습니다. 이렇게 하면 데이터가 한 세션에서 다른 세션으로 전달되므로 관리자가 세션 전반에 걸쳐 셸에서 활동을 더 쉽게 계속할 수 있습니다. LRS, ZRS 또는 GRS 스토리지 계정을 사용하여 이 데이터를 저장할 수 있습니다. 중복성을 위해 ZRS 또는 GRS 스토리지 계정을 사용하는 것이 좋습니다. 그러면 지역 중단 시 홈 디렉터리와 여기에 저장된 모든 파일을 사용할 수 있습니다.
- 모든 Azure 구독은 RBAC 및 권한 상속을 사용하기 때문에 관리자는 리소스 그룹 또는 구독 수준에 대한 권한을 할당받아 다른 관리자가 저장한 액세스 토큰 및 자격 증명 파일이 포함된 계정을 포함하여 모든 스토리지 계정에 대한 액세스 권한을 얻을 수 있습니다. 위반을 방지하려면 각 관리자 또는 Cloud Shell 사용자가 Azure에서 자신의 스토리지 계정을 설정하고 해당 스토리지 계정에 대한 RBAC 권한을 필요한 관리자에게만 액세스를 허용하도록 업데이트하는 것이 중요합니다.

Azure 드라이브
- Azure Cloud Shell에서 PowerShell 모듈을 사용하면 구독에 프로비저닝된 모든 Azure 리소스를 검색하고 탐색할 수 있습니다. 이렇게 하려면 cd Azure: 명령을 사용하여 셸을 Azure 드라이브로 전환해야 합니다. 홈 드라이브(`cd ~`)를 포함한 모든 셸 드라이브에서 표준 PowerShell cmdlet을 사용하여 리소스를 관리할 수 있습니다. 그러나 리소스 볼륨을 찾아볼 수 있으려면 먼저 Azure 드라이브로 전환해야 합니다.

Cloud Shell 편집자(Editor)
- Azure Cloud Shell 개발 팀은 오픈 소스 Monaco 프로젝트의 일환으로 Visual Studio Code 팀과 긴밀히 협력하여 Monaco Editor를 Cloud Shell에 통합했습니다. 이 웹 표준 기반 편집기를 사용하면 자동 완성, 코드 조각, 구문 색상 지정 등과 같은 Visual Studio Code 기능에 익숙한 관리자가 Cloud Shell 내에서 동일한 기능을 쉽게 사용할 수 있습니다. Cloud Shell에는 Cloud Shell 파일 시스템을 쉽게 탐색할 수 있는 파일 탐색기가 포함되어 있습니다.
- `vi`, `emacs`, `nano`를 사용하여 Cloud Shell의 파일과 `code .`를 편집할 수 있습니다. 웹 브라우저를 통해 Cloud Shell에 액세스할 때 파일 탐색기를 여는 cmdlet입니다.

Cloud Shell 삽입
- Microsoft에서 제공하는 표준 코드를 사용하여 웹 사이트의 HTML 코드에 Cloud Shell URL shell.azure.com을 포함할 수 있습니다. 이를 통해 서비스를 사용해야 하는 관리자와 사용자가 보다 쉽게 서비스에 액세스할 수 있습니다.
- 웹 페이지에서 JavaScript 기반 실행 버튼을 활성화하려면 HTML에 다음 코드를 삽입하면 됩니다. 이 버튼을 클릭하면 팝업 창에서 Cloud Shell이 실행됩니다.

```
<a style="cursor:pointer" onclick='javascript:window.open("https://shell.azure.com", "_blank", "toolbar=no,scrollbars=yes,resizable=yes,menubar=no,location=no,status=no")'><img alt="Launch Azure Cloud Shell" src="https://shell.azure.com/images/launchcloudshell.png"></a>
```
- 사용자가 Cloud Shell의 bash 또는 PowerShell 버전을 사용하도록 강제하려면 적용 요구 사항에 따라 코드의 URL을 다음 중 하나로 변경할 수 있습니다.
    - Bash: `https://shell.azure.com/bash`
    - PowerShell: `https://shell.azure.com/powershell`

vNET에서 Cloud Shell 배포
- 기본적으로 Cloud Shell은 Azure의 특정 프라이빗 가상 네트워크를 통해서만 액세스할 수 있도록 설정된 리소스에 액세스할 수 없습니다. 예를 들어, Cloud Shell이 동일한 가상 네트워크 내에 통합되지 않으면 kubectl을 사용하여 잠긴 Kubernetes 클러스터에 액세스할 수 없습니다. 그러나 일부 시나리오에서는 Cloud Shell을 사용하여 이러한 비공개 리소스에 액세스할 수 있습니다.
- Cloud Shell 통합의 경우 가상 네트워크의 서브넷을 ACI(Azure Container Instances) 서비스 전용으로 지정해야 합니다. 사용자가 Cloud Shell 세션 생성을 요청하면 ACI는 해당 서브넷에 컨테이너를 배포하여 Cloud Shell을 호스팅합니다.
- Cloud Shell 서비스에 액세스하는 데 사용할 수 있는 공용 네트워크 또는 개인 네트워크를 제어하려면 그림 에 표시된 것처럼 가상 네트워크의 전용 서브넷과 함께 Azure Relay 서비스가 필요합니다. 이는 무료 서비스가 아니므로 배포를 계획할 때 서비스 비용을 고려해야 합니다.
- 이러한 추가 리소스를 배포하기 위해 Microsoft는 온라인으로 무료 템플릿을 제공하고 유지 관리합니다. Cloud Shell을 가상 네트워크에 통합하기 전에 이 템플릿을 사용하여 필요한 리소스를 배포합니다.

<img src="https://drive.google.com/uc?id=17a9hlzaX5oPPmUohP5QRaq5MtjqdbPO0">

##모범 사례
- **RBAC 및 MFA를 사용하여 Cloud Shell에 대한 액세스 보호**: Cloud Shell을 사용할 수 있는 관리자와 이들이 액세스할 수 있는 리소스 및 권한을 검토하여 환경에서 역할 및 권한을 명확하게 구분합니다. Azure AD에서 제공되는 RBAC 역할을 활용하거나 이를 달성하기 위해 조직의 요구 사항에 따라 사용자 지정 역할을 만듭니다. 모든 관리자 계정이 Azure에서 무료로 제공되는 Azure MFA로 설정되었는지 확인하세요. 이를 통해 비밀번호가 유출된 경우에도 환경에 대한 원치 않는 액세스를 방지할 수 있습니다.
- **Azure Key Vault를 사용하여 비밀 저장**: Cloud Shell 또는 연결된 파일 공유 내부에 코드와 자격 증명을 저장할 수 있으므로 일반 텍스트로 저장하면 자격 증명이 노출될 가능성이 있습니다. Microsoft에서 제공하는 자격 증명 스캐너와 같은 도구를 사용하여 이러한 자격 증명을 찾고 바람직하게는 Azure Key Vault 또는 기타 보안 자격 증명 저장소 솔루션으로 이동할 수 있습니다.
- **Cloud Shell에 대한 액세스 제한**: Cloud Shell을 사용하면 Azure 서비스에 대해 스크립트와 코드를 쉽게 실행할 수 있으므로 Cloud 조건부 액세스를 사용하여 특정 보안 워크스테이션에서 Cloud Shell에 대한 액세스를 보호하는 것이 좋습니다. `ux.console.azure.com` 및 `ux.console.azure.us`(예: `ux.console.azure.com` 및 `ux.console.azure.us`)와 같은 서비스와 연결된 URL을 대상으로 하는 조건부 액세스와 방화벽 정책의 조합을 사용하여 모든 환경에서 Cloud Shell에 대한 액세스를 완전히 제한할 수 있습니다. (Azure 정부(Government) 클라우드). 이러한 액세스를 방지해야 하는 경우 이러한 URL을 대상으로 하는 정책을 설정하여 특정 위치, IP 또는 워크스테이션을 제외한 액세스를 방지할 수 있습니다.
- `Azure Policy를 사용하여 액세스 제한`: Azure Policy를 사용하고 특정 관리자만 스토리지 계정을 생성하도록 허용하여 Cloud Shell에 대한 액세스를 방지할 수 있습니다. 이러한 액세스 권한이 없는 관리자는 쓰기 작업을 위해 액세스할 수 있는 기존 스토리지 계정을 선택하거나, 존재하지 않는 경우 액세스가 거부될 수 있습니다.

#제 8장 Azure Service Health


##개요
- Azure는 사용 중인 Azure 클라우드 서비스의 상태를 모니터링하는 데 도움이 되는 도구 세트를 제공합니다. 워크로드 수준을 모니터링하는 데 사용할 수 있는 Azure Monitor 외에도 서비스 계층의 리소스를 모니터링하고 환경 상태에 영향을 줄 수 있는 서비스 문제를 경고하는 도구가 있습니다. 또한 이러한 도구는 클라우드 리소스에 서비스 가용성 문제를 일으킬 수 있는 계획되거나 계획되지 않은 지속적인 유지 관리 활동에 대한 정보와 경고를 전달합니다. 이 장에서는 다음 세 가지 도구를 다룹니다.
    - **Azure 상태(Status)**: 이 도구는 모든 Azure 지역의 Azure 서비스 중단에 대한 정보를 제공합니다. 이 도구는 리소스를 호스팅하는 지역뿐만 아니라 모든 지역의 중단에 대한 정보를 제공하므로 지역 간 서비스에 영향을 줄 수 있는 광범위한 중단이 있을 때 사용하는 것이 가장 좋습니다.
    - **서비스 상태(Service Health)**: 이 도구는 구독에서 사용 중인 지역 및 서비스에만 초점을 맞춰 Azure 서비스의 상태에 대한 보다 간결한 보기를 제공합니다. 이는 구독에 배포한 서비스를 모니터링하여 보다 개인화된 대시보드를 제공하고 중단, 계획된 유지 관리 활동 또는 해당 서비스 및 지역에만 관련된 권고에 대해 경고합니다.
    - **리소스 상태(Resource Health)**: 이 도구는 한 단계 더 나아갑니다. 구독에 배포된 개별 클라우드 리소스의 상태를 모니터링하고 해당 리소스에 영향을 미치는 모든 문제에 대해 경고합니다. Resource Health는 Azure Monitor와 함께 작동하여 리소스 상태에 중요한 경고를 제공합니다.

##Azure 상태(Status)
- Azure 상태는 모든 Azure 지역의 전반적인 서비스 상태를 모니터링하고 모든 지역의 서비스 수준 문제에 대한 업데이트를 제공합니다. `https://status.azure.com`에서 모든 사람에게 공개적으로 상태를 제공하는 인증되지 않은 서비스입니다.

<img src="https://drive.google.com/uc?id=1gf_PeWinvAI4pKsiOHT2Xd0w1xtFlTGz">

- Azure 상태 페이지의 유일한 구성 옵션은 다음과 같습니다.
    - **새로 고침 간격 드롭다운 목록**: 이 드롭다운 목록을 사용하여 새로 고침 간격을 변경합니다.
    - **지역 탭**: 지역별 세부 정보를 보려면 환경과 관련된 지역 탭을 클릭하세요.
    - **Azure 상태 기록(Status History)**: 중단에 대한 기록 보기를 가져옵니다.
- Azure 상태 기록 페이지에는 기본적으로 지난 5년 동안(2019년 11월 20일부터) 발생한 모든 사건의 기록이 보관됩니다. 서비스, 지역, 날짜 범위별로 이 정보를 필터링하여 필요에 맞는 사건만 볼 수 있습니다.
- Azure 상태는 모든 지역의 서비스에 영향을 미치는 주요 중단 또는 계획된 활동에 대한 높은 수준의 보기를 제공하므로 이를 사용하여 환경의 특정 리소스 또는 워크로드와 관련된 문제를 식별하기가 어렵습니다. Service Health 및 Resource Health는 이러한 시나리오를 해결하는 더 나은 도구입니다.

<img src="https://drive.google.com/uc?id=1NLJUchZ5Yl4AzRow3y8KYhFe-BEmwBfQ">

서비스 상태(Service Health)
- Service Health는 Azure 서비스의 상태와 해당 서비스가 배포된 지역을 추적하는 Azure에서 제공되는 무료 대시보드입니다. 이 도구는 Azure 서비스 상태의 변화를 나타내는 다양한 서비스 이벤트를 추적합니다. 이러한 이벤트에는 다음이 포함됩니다.
    - **계획된 유지 관리 활동**: 배포된 지역에서 사용 중인 서비스에 대해 계획된 유지 관리 활동입니다.
    - **서비스 문제**: 배포된 지역에서 사용 중인 서비스에 대한 지속적인 상태 문제로, 환경에 영향을 미칠 수 있습니다.
    - **보안 권고 사항(Security advisories)**: 서비스에 영향을 미칠 수 있는 보안 위반 또는 지속적인 보안 문제와 관련된 권고 사항입니다.
    - **상태 권고 사항(Health advisories)**:은 서비스 기능의 지원 중단이나 지속적인 지원을 위해 업그레이드가 필요한 기능이나 서비스와 관련된 권고 사항입니다.
- Service Health는 이러한 이벤트의 기록을 90일 동안 저장합니다. 문제를 모니터링하여 즉시 조치를 취할 수 있도록 경고를 설정할 수 있습니다.
- 그림은 서로 다른 두 Azure 구독에 대한 서비스 상태 기록을 보여줍니다. 보시다시피 기본적으로 상태 기록은 구독에 호스팅된 리소스가 있는 지역으로만 보기를 필터링합니다. 글로벌 수준에서 발생한 몇 가지 이벤트는 두 보기 모두에서 볼 수 있습니다. 그러나 미국 중부 지역에서 발생한 특정 사건은 하나의 이미지에서만 볼 수 있습니다.

<img src="https://drive.google.com/uc?id=18mthgtz0m3ymcL9r079mn4IUbdAPMhB9">

<img src="https://drive.google.com/uc?id=1TuHI7pDRH57jZmS5d8mCahZlGI4sFXns">

##리소스 상태
- Resource Health를 사용하면 Azure 환경에 배포된 리소스의 상태를 면밀히 모니터링할 수 있습니다. 문제가 발생할 때 조치를 취할 수 있도록 Resource Health에서 경고를 설정할 수 있습니다. 이는 문제의 근본 원인을 진단하는 데에도 도움이 될 수 있습니다. Resource Health는 모든 Azure 고객에게 무료로 제공됩니다.
- Resource Health는 다양한 Azure 서비스의 다양한 신호를 해석하여 리소스가 정상인지 여부를 확인합니다. 리소스가 비정상으로 간주되면 서비스는 문제의 원인을 확인하기 위해 추가 정보를 수집합니다. 예를 들어 VM(가상 머신)이 비정상으로 간주되면 서비스는 다음 검사를 수행합니다.
    - 이 VM을 호스팅하는 서버가 작동 중입니까?
    - 호스트 OS 부팅이 완료되었나요?
    - VM 컨테이너가 프로비저닝되고 전원이 켜져 있습니까?
    - 호스트와 스토리지 계정 간에 네트워크 연결이 있습니까?
    - 게스트 OS 부팅이 완료되었나요?
    - 진행 중인 계획된 유지 관리가 있습니까?
    - 호스트 하드웨어의 성능이 저하되어 곧 실패할 것으로 예상됩니까?
- 반면에 웹사이트가 건강하지 않은 것으로 간주되면 다음 검사가 수행됩니다.
    - 호스트 서버가 작동 중입니까?
    - 인터넷 정보 서버(Internet Information Server)가 실행 중입니까?
    - 로드 밸런서가 실행 중입니까?
    - 데이터 센터 내에서 웹 앱에 접근할 수 있나요?
    - 사이트 콘텐츠를 호스팅하는 스토리지 계정을 사용할 수 있나요?
- 검사(Checks)는 각 경우마다 매우 다르며 서비스 기능에 따라 달라집니다. Resource Health는 비정상으로 간주되는 개별 리소스 인스턴스에 대해 이러한 검사를 수행하므로 환경의 문제를 드러낼 수 있으므로 Resource Health 경고 및 작업을 모니터링하는 것이 중요합니다.
- 리소스 상태를 보여주는 개인화된 대시보드를 설정할 수 있습니다. Resource Health에서 캡처한 상태 데이터는 기록 참조 및 비교를 위해 30일 동안 유지됩니다. 또한 VM 워크로드의 경우 상태 문제가 해결되면 72시간 이내에 VM 리소스에 대한 근본 원인 분석 정보가 게시됩니다.

Health status indicators
- Resource Health는 다양한 상태 표시기를 표시합니다. 가능한 상태 값은 다음과 같습니다.
    - **사용 가능(Available)**: 리소스가 예상대로 작동하고 있으며 지난 24시간 동안 진행 중인 문제가 없었습니다. 지난 24시간 동안 문제가 해결된 경우 서비스에 이 내용도 표시됩니다.
    - **사용할 수 없음(Unavailable)**: 리소스 상태에 영향을 미치는 문제가 감지되었습니다. 이는 플랫폼 문제일 수도 있고 플랫폼이 아닌 문제일 수도 있습니다. 플랫폼 문제는 서비스 중단, 계획된 유지 관리, 계획되지 않은 리소스 다시 시작 또는 호스트 다시 시작과 같은 Azure 인프라 관련 문제입니다. 비플랫폼 문제에는 리소스 다시 시작 또는 종료와 같은 사용자 작업으로 인해 발생하는 문제가 포함됩니다.
    - **알 수 없음(Unknown)**: 지난 10분 동안 리소스 상태를 확인할 수 없습니다. 이는 리소스가 오프라인이기 때문에 상태 정보를 브로드캐스트하지 않았거나 기본 서비스 문제로 인한 것일 수 있습니다.
    - **성능 저하(Degraded)**: 서비스가 리소스 성능에 영향을 미치는 지속적인 문제를 감지하고 있습니다. 리소스 유형에 따라 성능 저하 상태의 원인이 다릅니다. 예를 들어 스토리지 계정은 기본 하드웨어가 손상을 감지하는 경우 저하된 상태를 나타낼 수 있는 반면 트래픽 관리자 서비스는 서비스를 제공하는 일부 지역이 오프라인인 경우 저하된 상태를 나타낼 수 있습니다.
- Health status indicators를 기반으로 Resource Health는 문제를 최대한 빨리 해결하여 가동 중지 시간을 줄이는 데 도움이 되는 일련의 권장 사항과 다음 단계를 제공합니다. 이러한 권장 사항은 모든 Azure 고객의 유사한 이벤트에 대한 일반적인 솔루션의 기록 분석을 기반으로 합니다.

##모범 사례
- **정기적인 모니터링을 위한 Service Health 경고 설정**: 진행 중인 서비스 문제를 사전에 식별하고 가능한 경우 해결하려면 모든 활성 Azure 지역에서 사용하는 모든 서비스에 대해 Service Health 경고를 설정하는 것이 좋습니다. 일부 서비스 상태 문제는 해결되지 않을 수 있습니다. 하지만 이를 알고 있으면 내부 사용자 통신, 향후 서비스 중복 옵션 계획, 해당 옵션이 이미 있는 경우 서비스 장애 조치에 도움이 될 수 있습니다.
- **중요한 리소스에 대한 Resource Health 경고 설정**:  진행 중인 문제를 사전에 식별하고 해결하려면 모든 리소스(또는 최소한 조직에 가장 중요한 리소스)에 대해 Resource Health 경고를 설정하는 것이 좋습니다. 이러한 경고는 연중무휴 24시간 모니터링되는 사서함(mailbox)으로 전송되어야 합니다.
- **사용자 정의 대시보드 설정**: 대시보드를 설정하여 다양한 서비스 및 리소스의 상태를 지속적으로 모니터링하여 SLA 요구 사항에 따라 온라인 상태인지 확인하세요.
- **가능한 경우 자동화된 작업을 설정**: 워크플로 또는 Runbook을 트리거하여 상태 문제를 해결하거나 동일한 지역 또는 다른 지역의 리소스를 참여시켜 문제가 발생한 리소스의 로드를 인계하도록 자동화된 작업을 설정합니다.
