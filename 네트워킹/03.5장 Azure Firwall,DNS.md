#제 5장 Azure 방화벽

##개요
- Azure Firewall은 Azure 서비스로 제공되는 완전 관리형, 고가용성, 확장성이 뛰어난 상태 저장 방화벽입니다. 이를 통해 네트워크 및 애플리케이션 로깅을 중앙에서 정의하고 여러 구독에서 Azure vNET(가상 네트워크) 리소스를 보호하는 정책을 시행할 수 있습니다. 서비스는 SOC(서비스 조직 통제), ISO(국제 표준화 기구) 표준, PCI DSS(지불 카드 산업 데이터 보안 표준), Health Information Trust Alliance Common 등 대부분의 국제 표준을 준수합니다. 보안 프레임워크(HITRUST CSF) 및 기타.

<img src="https://drive.google.com/uc?id=1W4gIwyiDv7OtGiEp1Hu3pWjicfEEBtHA">


##Azure 방화벽 기능
- **설계에 따른 고가용성**: Azure Firewall은 설계에 따라 가용성이 높습니다. 서비스 가동시간 기준은 99.95%입니다. 조직에서는 고가용성을 달성하기 위해 추가 설정이나 구성을 수행할 필요가 없습니다.
- **무제한 확장 기능**: Azure Firewall에는 필요에 따라 더 많은 양의 트래픽을 처리할 수 있는 무제한 확장 기능이 있습니다. 따라서 조직은 최대 부하를 처리하기 위해 방화벽을 계획하거나 수동으로 확장할 필요가 없습니다.
- **가용성 영역 지원**: Azure Firewall은 여러 가용성 영역에 걸친 배포를 지원하여 99.99% 가동 시간을 허용합니다. Azure Firewall 비용은 가용성 영역 구성에 관계없이 동일하게 유지됩니다. 방화벽이 여러 가용성 영역에 걸쳐 있는 경우 가용성 영역 간의 인바운드 및 아웃바운드 데이터 전송과 관련된 추가 요금이 발생합니다.
- **완전 상태 저장 서비스**: Azure Firewall은 계층 3 및 4 모니터링 및 필터링 기능을 제공하는 완전 상태 저장 서비스입니다. 원본, 대상 IP, 프로토콜 또는 포트를 기반으로 허용하거나 거부해야 하는 트래픽에 대한 규칙을 정의하면 여러 Azure 구독 및 vNET에 분산된 리소스를 보호할 수 있습니다.
- **중앙 집중식 관리**: Azure Firewall을 사용하면 Azure Firewall Manager를 사용하여 중앙 집중식 관리가 가능합니다. 이를 통해 단일 위치에서 여러 Azure Firewall을 쉽게 구성하고 관리할 수 있습니다.
- **위협 인텔리전스**: Azure Firewall은 Microsoft 위협 인텔리전스 피드를 기반으로 알려진 악성 IP 및 소스의 트래픽 자동 차단을 지원합니다. 조직에서 필요한 경우 이 기능을 쉽게 활성화할 수 있습니다.
- **NAT 지원**: Azure Firewall 서비스는 인바운드 및 아웃바운드 NAT(네트워크 주소 변환) 기능을 모두 제공하므로 중요한 서비스를 공개적으로 노출하지 않고도 트래픽을 내부 리소스로 안전하게 라우팅할 수 있습니다.
- **여러 IP 주소 지원**: 최대 250개의 IP 주소를 Azure Firewall에 할당할 수 있습니다. 따라서 서로 다른 IP 주소를 사용하여 동일한 포트의 여러 가상 리소스에 대해 인바운드 및 아웃바운드 NAT를 구성할 수 있습니다.
- **중앙 집중식 로깅**: Azure Firewall은 Azure Monitor에 대한 중앙 집중식 로깅을 지원하므로 분석 및 경고를 위해 방화벽과 트래픽 로그를 장기간 보존할 수 있습니다.
- **다양한 배포 방법**: Azure Portal 및 Azure PowerShell을 사용하여 Azure Firewall을 배포하고 관리할 수 있습니다. ARM 템플릿을 사용하여 Azure Firewall을 배포할 수도 있습니다.

##설계 개념 및 배포 고려 사항
가용성 영역 지원
- 방화벽을 만들 때 한 지역의 여러 가용성 영역에 Azure Firewall을 배포할 수 있지만 방화벽을 만든 후에는 배포할 수 없습니다. 가용성 영역의 일부가 되어야 하는 이미 생성한 모든 방화벽은 삭제하고 가용성 영역에서 다시 생성해야 합니다.
- 방화벽 비용은 가용성 영역 내에 있든 없든 동일합니다. 그러나 방화벽이 여러 가용성 영역에 걸쳐 있는 경우 가용성 영역 전체의 인바운드 및 아웃바운드 데이터 전송에 대해 추가 요금이 적용됩니다.
- 두 개 이상의 가용성 영역에 걸쳐 있는 Azure Firewall을 만드는 경우 서비스 SLA는 가동 시간 99.95%에서 가동 시간 99.99%로 향상됩니다.

인바운드 DNAT
- Azure Firewall은 DNAT를 지원합니다. 이를 통해 방화벽은 방화벽과 연결된 특정 공용 IP에 대한 수신 트래픽을 내부 서비스로 라우팅할 수 있습니다. 이를 통해 공용 인터넷을 통해 내부 서비스를 안전하게 게시할 수 있습니다.
- DNAT를 사용하면 표준 공용 포트에서 비표준 내부 포트로 트래픽을 라우팅하여 내부 애플리케이션 포트를 모호하게 할 수 있습니다. 애플리케이션 프런트 엔드가 악의적인 공격에 노출될 염려 없이 내부 애플리케이션을 안전하게 노출할 수 있습니다.
- Azure Firewall에 최대 250개의 공용 IP 주소를 설정할 수 있으므로 다양한 공용 IP를 다양한 내부 서비스와 연결할 수 있습니다. 이렇게 하면 필요한 경우 여러 내부 애플리케이션에 동일한 포트를 더 쉽게 사용할 수 있습니다.

아웃바운드 SNAT
- Azure Firewall은 네트워크 내부 리소스에서 발생하는 아웃바운드 트래픽에 대한 SNAT(소스 네트워크 주소 변환)도 지원합니다. SNAT를 사용하면 공용 인터넷으로 이동하는 트래픽을 특정 공용 IP 또는 공용 IP 세트로 마스킹할 수 있습니다. 이를 통해 사람들(예: 원격 직원)이 공용 인터넷을 통해 리소스에 액세스할 수 있습니다. 또한 고정 IP 연결이 필요한 알려진 파트너 또는 타사 네트워크에 대한 특정 SNAT 구성 액세스를 활성화하는 라우팅 규칙을 설정할 수도 있습니다.
- IANA RFC 1918에 따라 대상 IP가 개인 IP 범위인 경우 Azure Firewall은 SNAT를 수행하지 않습니다. SNAT 트래픽은 방화벽에서 제공하는 메트릭을 사용하여 모니터링할 수 있습니다.
- SNAT는 여러 공용 IP를 사용하여 단일 공용 IP에 대한 포트 소진의 영향을 제한함으로써 Azure Firewall의 다중 IP 지원을 활용할 수 있습니다. 방화벽과 연결된 모든 공용 IP는 SNAT 시 무작위로 선택됩니다. 따라서 다운스트림으로 필터링을 수행하려면 이 필터링을 사용하는 모든 서비스에 대해 연결된 모든 공용 IP 또는 공용 IP 접두사가 허용되어야 합니다.

트래픽 필터링
- Azure Firewall을 사용하면 다양한 유형의 트래픽 필터링 규칙을 만들어 환경과 백엔드 서비스를 보호할 수 있습니다. 다양한 방법으로 트래픽 필터링을 수행할 수 있습니다.
    - 수신 네트워크 패킷 세부 정보를 사용한 네트워크 트래픽 필터링 규칙
    - 웹 카테고리를 사용한 웹 트래픽 필터링 규칙
    - 미리 정의된 Microsoft 관리 애플리케이션 FQDN에 대한 아웃바운드 트래픽을 보호하기 위한 애플리케이션 FQDN 트래픽 필터링 규칙

네트워크 트래픽 필터링
- Azure Firewall은 원본 IP, 대상 IP, 포트 또는 프로토콜을 기반으로 트래픽을 허용하거나 거부하는 규칙을 생성하여 네트워크 트래픽을 필터링할 수 있습니다. Azure Firewall은 계층 3 및 계층 4 트래픽을 모니터링하고 필터링할 수 있는 완전한 상태 저장 서비스이므로 방화벽을 통과하는 트래픽 및 데이터 패킷의 컨텍스트를 지속적으로 분석할 수 있습니다. 이를 통해 소스 및 대상 IP뿐만 아니라 포트 및 프로토콜을 기준으로 필터링할 수 있으므로 네트워크 안팎으로 허용되는 네트워크 트래픽을 더 효과적으로 제어할 수 있습니다.

웹 트래픽 필터링
- Azure Firewall은 웹 트래픽 필터링을 지원하여 소셜 미디어, 검색 엔진, 종교, 스포츠 등 미리 정의된 범주를 기반으로 트래픽을 허용하거나 제한합니다.
- 표준 Azure Firewall은 웹 요청의 기본 도메인 수준까지만 분류 및 필터링을 지원합니다. 예를 들어, `www.bing.com` 및 `www.bing.com/news`에 대한 웹 요청은 두 경우 모두 기본 도메인(`bing.com`)이 검색 엔진이기 때문에 검색 엔진 아래로 분류됩니다.

애플리케이션 FQDN 트래픽 필터링
- Azure Firewall을 사용하면 아웃바운드 HTTP, HTTPS 및 Azure SQL 트래픽을 미리 정의된 FQDN(정규화된 도메인 이름) 집합으로 제한할 수 있습니다. 여기에는 Microsoft에서 관리하는 FQDN에 대한 와일드카드 기반 트래픽을 허용하는 기능이 포함됩니다.

그룹화
- Azure는 잘 알려진 서비스 그룹화를 단순화하는 다양한 방법을 제공합니다. 이는 필터링 규칙에서 효과적으로 사용될 수 있도록 IP 범위, 인프라 서비스 및 웹 사이트 범주에 자주 사용됩니다.

태그
- 태그를 사용하면 리소스, 서비스 또는 개체를 더 쉽게 그룹화하여 특정 작업을 적용할 수 있습니다. Azure Firewall 서비스에 사용할 수 있는 태그에는 FQDN(정규화된 도메인 이름) 태그와 서비스 태그라는 두 가지 유형이 있습니다.

FQDN 태그
- FQDN 태그는 미리 정의된 잘 알려진 Azure 서비스 집합에 적용되어 해당 서비스에 대한 트래픽을 쉽게 허용합니다. 예를 들어 Windows 진단 FQDN 태그는 모든 Windows 진단 끝점에 적용됩니다. 트래픽을 허용하도록 이 서비스와 연결된 모든 IP를 설정하는 대신 이 태그를 활성화하여 Windows 진단 서비스에 대한 트래픽을 허용할 수 있습니다.
- FQDN 태그는 Microsoft에서 관리하고 유지 관리합니다. FQDN 태그를 변경하거나 새 태그를 만들 수 없습니다.
- 현재 Azure에서 사용할 수 있는 FQDN 태그에는 다음이 포함됩니다. Microsoft는 향후 필요에 따라 더 많은 FQDN 태그를 추가할 예정입니다.
    - **Windows 업데이트**: 이 FQDN 태그를 사용하면 모든 Microsoft 업데이트 끝점에 액세스할 수 있습니다.
    - **Windows 진단**: 이 FQDN 태그를 사용하면 모든 Windows 진단 끝점에 액세스할 수 있습니다.
    - **Microsoft Active Protection Service(MAPS)**: 이 FQDN 태그는 모든 MAPS 끝점에 대한 액세스를 허용합니다.
    - **ASE(App Service Environment)**: 이 FQDN 태그를 사용하면 ASE 플랫폼 트래픽에 액세스할 수 있습니다. 그러나 이 태그는 ASE에서 생성된 고객별 스토리지 및 SQL 엔드포인트를 다루지 않습니다. 서비스 엔드포인트를 통해 활성화하거나 수동으로 추가해야 합니다.
- 이러한 태그를 적용하면 각 엔드포인트 또는 서비스와 연결된 해당 액세스가 허용됩니다.

서비스 태그
- 서비스 태그는 특정 Azure 서비스와 연결된 IP 주소 접두사 그룹을 관리하기 위해 Microsoft에서 생성됩니다. 예를 들어 AppService 서비스 태그는 Azure App Service에 적용되며, 이 태그를 사용하도록 설정된 모든 규칙은 해당 서비스의 모든 인스턴스에 적용됩니다.
- 기타 서비스 태그에는 다음이 포함됩니다.
    - **스토리지**: 이는 Azure Storage 서비스에 적용됩니다.
    - **SQL**: 이는 Azure SQL 서비스에 적용됩니다.
    - **AzureActiveDirectory**: 이는 Azure Active Directory 서비스에 적용됩니다.
- Microsoft만이 서비스 태그를 생성하고 관리할 수 있습니다. 새로운 서비스 태그는 일반적으로 새로운 서비스가 온라인 상태가 될 때 생성됩니다.

인프라 FQDN
- 모든 Azure Firewall 인스턴스에는 다양한 Azure 서비스에 대한 트래픽을 허용하도록 설정되고 기본적으로 활성화되는 인프라 FQDN에 대한 기본 제공 규칙 컬렉션이 포함되어 있습니다. 다음 서비스는 이러한 FQDN에 포함되어 있으며 특히 Azure 플랫폼용이며 다른 이유로는 사용할 수 없습니다.
    - 스토리지 플랫폼 이미지 저장소(PIR)에 대한 컴퓨팅 액세스
    - 관리 디스크 상태 스토리지 액세스
    - Azure 진단 및 로깅(MDS)
- 방화벽 규칙 목록 끝에 모든 애플리케이션 규칙 거부 컬렉션을 추가하여 이 기본 제공 규칙 컬렉션을 재정의할 수 있습니다.

IP 그룹
- IP 그룹을 사용하여 Azure Firewall 규칙에 사용할 다양한 IP 주소 또는 IP 범위를 조합할 수 있습니다. IP 그룹은 네트워크 트래픽 규칙에서 소스 주소 또는 대상 주소로 사용되거나 DNAT 또는 애플리케이션 규칙에서 소스 주소로 사용될 수 있습니다.
- 동일한 IP 그룹을 여러 규칙에서 사용할 수 있습니다. 이를 통해 유지 관리가 더 쉬워지고 관리 오버헤드가 줄어듭니다. 각 IP 그룹에는 단일 IP 주소, 여러 IP 주소 또는 IP 주소 범위가 포함될 수 있습니다.

웹 카테고리
- 웹 카테고리는 콘텐츠나 목적에 따라 관련된 웹사이트 목록을 포함하는 사전 정의된 카테고리 세트입니다. 이러한 범주를 사용하면 관리자가 조직 정책에 따라 트래픽을 쉽게 허용하거나 거부할 수 있습니다. 카테고리의 특정 웹사이트에 대한 예외 또는 제외를 설정하여 해당 카테고리에 대한 조직의 정책을 재정의할 수 있습니다.

강제(Forced) 터널링
- 강제 터널링에는 기본 인터넷 게이트웨이 대신 지정된 에지 장치 또는 네트워크 가상 어플라이언스를 통해 모든 아웃바운드 인터넷 트래픽을 라우팅하는 작업이 포함됩니다. 이를 통해 조직은 아웃바운드 트래픽을 인터넷으로 보내기 전에 규정 준수, 감사 또는 보안상의 이유로 처리할 수 있습니다.
- Azure Firewall 인스턴스를 만들 때만 강제 터널링을 설정할 수 있습니다. 강제 터널링을 사용하도록 기존 Azure Firewall 인스턴스를 구성하려면 해당 인스턴스를 삭제하고 강제 터널링을 활성화하여 다시 만들어야 합니다. 마찬가지로, Azure Firewall 인스턴스에 대해 강제 터널링을 비활성화하려면 인스턴스를 삭제하고 해당 설정을 비활성화하여 다시 만들어야 합니다.
- 서비스에 대한 운영 활동이 중단 없이 계속되도록 하려면 방화벽 서비스를 관리하는 트래픽을 클라이언트 트래픽과 분리해야 합니다. 최소 서브넷 크기가 /26인 전용 서브넷인 AzureFirewallManagementSubnet을 사용해야 합니다. 이 서브넷에는 전용 공용 IP 주소가 필요합니다. 이 구성이 완료되면 필요에 따라 처리하기 위해 모든 트래픽을 온-프레미스 또는 전용 어플라이언스로 라우팅하도록 AzureFirewallSubnet을 설정할 수 있습니다.

위협(Threat) 인텔리전스
- 위협 인텔리전스 기반 필터링은 Microsoft 위협 인텔리전스 피드에서 악성 IP 및 도메인에 대한 정보를 제공하는 Azure Firewall에서 사용할 수 있는 고급 보안 기능입니다. 이 기능은 경고 전용(alert-only) 모드에서 기본적으로 활성화되어 있지만 경고 및 거부(alert-and-deny) 모드로 설정하여 잠재적인 위협에 대해 경고하고 필요한 경우 해당 위협을 차단할 수 있습니다.
- 경고 및 거부(alert-and-deny) 모드가 활성화되면 다른 네트워크 또는 애플리케이션 필터링 규칙이 무시됩니다. 이는 이 설정이 활성화되면 Azure Firewall이 항상 들어오거나 나가는 트래픽에 대한 위협 인텔리전스 규칙을 먼저 분석하기 때문입니다. 이 작업 순서는 변경할 수 없습니다.
- 이와 대조적으로 경고(alert) 모드에서는 Azure Firewall도 트래픽을 먼저 분석하지만 서비스에서는 경고만 발생시키면 나머지 네트워크 및 애플리케이션 트래픽 필터링 규칙은 해당 트래픽에 계속 적용됩니다.

Azure 방화벽 관리자
- Azure Firewall Manager는 중앙에서 정책을 구성하고 여러 구독 및 vNET에 배포된 Azure Firewall의 인스턴스를 라우팅 및 관리하는 데 사용할 수 있는 관리 계층 서비스입니다. 방화벽 관리를 위해 중앙 콘솔을 사용하는 데 익숙한 기업의 경우 Azure Firewall Manager는 Azure Firewall 인스턴스 관리를 위한 이상적인 솔루션입니다. 방화벽 정책을 사용하여 여러 Azure Firewall 인스턴스에 걸쳐 네트워크 및 애플리케이션 필터링 규칙을 중앙에서 생성, 배포 및 관리하는 데 사용할 수 있습니다.

기본(classic) 규칙과 방화벽 정책
- **클래식 규칙(Classic rules)**: 클래식 규칙은 개별 Azure Firewall 인스턴스에 대해 설정된 표준 애플리케이션 또는 네트워크 규칙입니다. 이는 표준 SKU에서만 사용할 수 있습니다. 최신 Azure Firewall 기능은 클래식 규칙을 지원하지 않습니다.
- **방화벽 정책(Firewall policies)**: 방화벽 정책은 글로벌 수준에 저장되고 여러 Azure Firewall 인스턴스에 배포될 수 있는 NAT 규칙, 네트워크 트래픽 규칙, 애플리케이션 필터링 규칙 및 위협 인텔리전스 설정의 컬렉션입니다. 이를 통해 정책 상속 및 시행을 사용하여 조직 전체에 표준을 더 쉽게 적용할 수 있습니다. 기존 정책을 기반으로 새로운 방화벽 정책을 생성할 수 있습니다. 또한 특정 시나리오에 대한 로컬 정책을 만들고 이를 개별 Azure Firewall 인스턴스에 적용할 수 있습니다. 방화벽 정책을 만들고 관리하려면 Azure Firewall Manager, Azure PowerShell, Azure CLI, REST API 또는 ARM 템플릿을 사용합니다.
- Microsoft는 0개 또는 1개의 방화벽과 관련된 방화벽 정책에 대해 비용을 청구하지 않습니다. 방화벽 연결이 여러 개인 경우에만 고정 요금이 부과됩니다.
- 기존 규칙에서 방화벽 정책으로 마이그레이션하는 것이 좋습니다. 이를 수행하는 쉬운 방법 중 하나는 Azure Portal에서 방화벽 정책으로 마이그레이션 옵션을 선택하는 것입니다.

방화벽 규칙 처리
- Azure Firewall은 들어오고 나가는 트래픽을 지정하기 위해 일부 규칙이 정의될 때까지 모든 트래픽을 거부합니다.

인바운드 트래픽
- 들어오는 트래픽의 경우 규칙이 처리되는 순서는 방화벽 관리 유형에 따라 달라집니다.
- 클래식 규칙으로 설정된 방화벽의 경우 순서는 다음과 같습니다.
    1. 위협 인텔리전스 규칙.
    2. NAT 규칙.
    3. 네트워크 규칙은 우선순위(가장 낮은 숫자에서 가장 높은 숫자 순)입니다.
- 방화벽 정책으로 설정된 방화벽의 경우 순서는 다음과 같습니다.
    1. 위협 인텔리전스 규칙.
    2. NAT 규칙.
    3. 우선순위에 따른 규칙 컬렉션 또는 규칙 컬렉션 그룹입니다(가장 낮은 번호부터 가장 높은 번호까지). 각 규칙 컬렉션 또는 규칙 컬렉션 그룹 내에서 네트워크 규칙은 동일한 논리(가장 낮은 숫자부터 가장 높은 숫자까지)를 사용하여 처리됩니다.
- 이 논리에는 한 가지 예외가 있습니다. 즉, 하위 규칙 컬렉션이나 하위 규칙 컬렉션 그룹에 설정된 우선순위에 관계없이 상위 정책에서 상속된 규칙 컬렉션 그룹이 항상 먼저 적용됩니다.
- Azure Firewall은 이 기능을 지원하지 않으므로 애플리케이션 규칙은 들어오는 트래픽에 적용되지 않습니다. 애플리케이션 규칙 필터링의 경우 Azure Web Application Firewall 또는 Azure Front Door를 사용해야 합니다.

아웃바운드 트래픽
- 인바운드 트래픽과 마찬가지로 아웃바운드 트래픽에 대한 규칙이 적용되는 순서는 방화벽 관리 유형에 따라 다릅니다. 각 수준에서 트래픽을 거부하는 일치 항목이 있으면 추가 규칙이 적용되지 않습니다.
    - 애플리케이션 규칙은 네트워크 규칙과 일치하는 항목이 없는 경우에만 분석됩니다.
    - 애플리케이션 규칙과 일치하는 항목이 없는 경우에만 인프라 규칙이 분석됩니다.
    - 인프라 규칙과 일치하는 항목이 없으면 트래픽이 거부됩니다.
- 클래식 규칙으로 설정된 방화벽의 경우 순서는 다음과 같습니다.
    1. 위협 인텔리전스 규칙.
    2. NAT 규칙.
    3. 네트워크 규칙은 우선순위(가장 낮은 숫자에서 가장 높은 숫자 순)입니다.
    4. 우선순위(가장 낮은 번호부터 가장 높은 번호까지)에 따라 적용 규칙을 정합니다.
    5. 인프라 규칙 컬렉션.
- 방화벽 정책으로 설정된 방화벽의 경우 순서는 다음과 같습니다.
    1. 위협 인텔리전스 규칙.
    2. NAT 규칙.
    3. 우선순위에 따른 규칙 컬렉션 또는 규칙 컬렉션 그룹입니다(가장 낮은 번호부터 가장 높은 번호까지). 각 규칙 컬렉션 또는 규칙 컬렉션 그룹 내에서 네트워크 및 애플리케이션 규칙은 동일한 논리(가장 낮은 숫자에서 가장 높은 숫자까지)를 사용하여 처리됩니다.
    4. 인프라 규칙 컬렉션.
- 이 논리에는 한 가지 예외가 있습니다. 즉, 하위 규칙 컬렉션이나 하위 규칙 컬렉션 그룹에 설정된 우선순위에 관계없이 상위 정책에서 상속된 규칙 컬렉션 그룹이 항상 먼저 적용됩니다. 또한 애플리케이션 규칙은 트래픽이 HTTP, HTTPS 또는 MSSQL 프로토콜을 사용하는 경우에만 처리됩니다.

DNS 프록시
- Azure Firewall을 DNS 프록시로 구성하여 인증된 DNS 서버의 도움을 받아 중개자로서 클라이언트 DNS 요청을 확인할 수 있습니다.

활성(Active) FTP 지원
- Azure Firewall은 활성 FTP를 지원합니다. 활성 FTP에 대한 지원은 FTP 반송 공격으로부터 보호하기 위해 기본적으로 비활성화되어 있지만 Azure PowerShell, Azure CLI 또는 ARM 템플릿을 사용하여 방화벽을 배포하는 경우 활성화할 수 있습니다.

Azure Monitor 로깅
- Azure Firewall을 Azure Monitor와 통합할 수 있습니다. 또한 이 통합은 이벤트 로깅, 장기 보존을 위해 스토리지 계정에 로그 보관, Log Analytics로 로그 전송 및 Event Hub로 이벤트 스트리밍에 대한 지원을 제공합니다.
- Microsoft는 방화벽 데이터를 분석하고 보고 목적으로 시각화를 만드는 데 사용할 수 있는 Azure Firewall 통합 문서라는 미리 작성된 Azure Monitor용 템플릿을 제공합니다. 또한 방화벽 성능 및 지속적인 문제에 대한 심층 분석을 위해 모니터링 솔루션에 통합할 수 있는 다양한 방화벽 지표, 활동 로그 및 진단 로그가 있습니다.

방화벽 지표
- Azure Monitor에는 서비스 관련 정보를 수집하고 문제가 감지되면 경고를 발생시키는 Azure Firewall 관련 메트릭이 포함되어 있습니다. 주요 측정항목은 다음과 같습니다.
    - **방화벽 상태**: SNAT 포트 가용성을 기반으로 방화벽 상태를 측정합니다.
    - **처리된 데이터**: 다양한 기간에 방화벽을 통과하는 총 데이터 양을 추적합니다.
    - **처리량(Throughput)**: 데이터가 방화벽을 통과하는 초당 속도를 나타냅니다.
    - **애플리케이션 규칙 적중 횟수**: 요청에 의해 애플리케이션 규칙이 트리거된 횟수를 측정합니다.
    - **네트워크 규칙 적중 횟수**: 요청에 의해 네트워크 규칙이 트리거된 횟수를 추적합니다.
    - **SNAT 포트 활용도**: 방화벽에서 현재 사용 중인 SNAT 포트의 비율을 나타냅니다.

Azure 활동 로그
- Azure는 배포된 모든 서비스에 대한 활동 로그를 자동으로 수집합니다. 이러한 로그에는 특정 기간 동안 서비스에서 수행된 모든 변경 사항과 작업을 기록하는 운영 및 감사 데이터가 포함되어 있습니다. 이러한 로그를 수집하고 분석하여 시간 경과에 따른 변경 관리 활동이나 관리 작업을 추적할 수 있습니다.

진단 로그
- Azure Firewall에서 서비스의 다양한 기능을 모니터링하여 지속적인 문제를 식별하는 데 사용할 수 있는 다양한 유형의 진단 로그가 있습니다. 여기에는 다음이 포함됩니다.
    - **애플리케이션 규칙 로그**: 애플리케이션 규칙과 일치하는 모든 연결 요청을 기록합니다.
    - **네트워크 규칙 로그**: 네트워크 규칙과 일치하는 모든 연결 요청을 기록합니다.
    - **DNS 프록시 로그**: 방화벽에 구성된 DNS 프록시 서비스를 사용하여 DNS 서버로 전송된 모든 DNS 메시지를 기록합니다.
- 이러한 각 로그 유형은 다음 세 가지 방법 중 하나로 로그를 저장하도록 구성할 수 있습니다.
    - Azure Storage 계정에 저장
    - Azure Monitor로 보내기
    - Event Hubs로 스트리밍

##모범 사례
- **Azure Firewall을 Azure Monitor와 통합**: Azure Firewall을 Azure Monitor와 통합하여 방화벽 로그를 저장하고 분석할 수 있습니다. 방화벽 지표를 모니터링하여 성능을 측정하고 문제를 식별하려면 그렇게 하는 것이 좋습니다. 로그를 스토리지 계정에 저장하거나, Log Analytics로 보내거나, Event Hub로 스트리밍할 수 있습니다. 그런 다음 Log Analytics, Microsoft Excel, Microsoft Power BI와 같은 도구를 사용하여 분석할 수 있습니다. 또한 공격이나 성능 문제를 자동으로 식별하기 위해 다양한 지표에 대한 경고를 설정할 수도 있습니다.
- **100 단위로 규칙 우선순위 설정**: 새 규칙을 만들 때 우선 순위를 100으로 설정하는 것이 좋습니다. 그렇게 하면 시간이 지남에 따라 더 많은 규칙을 추가할 때 해당 규칙의 우선 순위를 수정할 필요 없이 기존 규칙 사이에 쉽게 삽입할 수 있습니다.
- **와일드카드를 DNAT의 소스로 사용하지 않기**: 가능하면 와일드카드를 사용하는 대신 들어오는 DNAT에 대한 소스 IP를 지정하는 것이 좋습니다. 이렇게 하면 지정한 소스의 트래픽만 허용되고 내부 애플리케이션으로 라우팅됩니다.
- **글로벌 피어링 고려**: Azure Firewall은 일반적으로 방화벽이 중앙 vNET에 배포되고 해당 지역의 다른 모든 vNET이 중앙 네트워크와 피어링되는 허브 앤 스포크 모델을 사용하여 배포됩니다. 이를 통해 각각에 방화벽을 배포할 필요 없이 피어링된 모든 vNET에 대한 트래픽을 중앙 집중식으로 제어할 수 있습니다. 이는 전 세계적으로 분산된 vNET에 적합하지만 트래픽이 최종 목적지에 도달하기 전에 다른 Azure 지역을 통과하는 경우 성능 또는 대기 시간 문제가 발생할 수 있습니다. 이 문제를 해결하려면 방화벽에만 글로벌 피어링을 사용하는 것이 좋습니다. 먼저 테스트하여 애플리케이션과 조직의 대기 시간 및 성능 요구 사항을 충족하는지 확인하세요.
- **NSG와 함께 Azure Firewall을 함께 사용**: Azure Firewall과 NSG는 상호 보완적인 방식으로 함께 작동하여 심층적인 네트워크 보안을 제공합니다. 모든 구독 및 vNET에서 리소스를 보호하기 위해 Azure Firewall을 배포하는 경우에도 NSG에서 제공하는 분산 네트워크 계층 트래픽 필터링을 활용하여 vNET 내의 리소스에 대한 트래픽을 제한해야 합니다.
- **Azure Security Center 사용**: Azure Security Center는 보안 상태 관리를 더욱 효율적으로 관리하고 특정 위협으로부터 보호해 줍니다. Azure Firewall과 관련된 네트워크 리소스를 보호하려면 Security Center에서 제공하는 네트워크 보호 권장 사항을 따르는 것이 좋습니다. Log Analytics 작업 영역과 결합하면 비정상적인 활동에 대한 모니터링 및 경고를 설정하여 적시에 위협에 대응할 수 있습니다.
- **위협 인텔리전스 활성화**: 위협 인텔리전스 기반 필터링은 잘 알려진 악성 IP 주소 및 도메인에서 발생하는 트래픽에 대해 경고하고 차단할 수 있습니다. 환경에 대한 보호를 강화하려면 이 기능을 사용하는 것이 좋습니다.
- **가능한 경우 관리 오버헤드 줄이기**: 가능하면 네트워크 보안 규칙을 설정할 때 IP 주소나 IP 범위 대신 서비스 태그, IP 그룹 및 FQDN 태그를 사용하십시오. 이를 통해 네트워크 구성의 관리 및 유지 관리는 물론 관리 오버헤드도 줄어듭니다.
- **보안 구성 표준화**: 조직의 보안 정책 구성을 표준화합니다. 그런 다음 Azure 서비스를 설정하여 효과적으로 유지 관리되도록 합니다. Azure Firewall Manager 및 Azure Blueprints는 이 목표를 달성하는 데 도움이 될 수 있습니다. Azure Firewall Manager는 보안 구성을 표준화하는 데 도움이 될 수 있지만 Azure Blueprints는 ARM 템플릿, Azure RBAC 컨트롤 및 정책과 같은 모든 아티팩트를 배포 시 보안 정책 표준을 모니터링하고 유지 관리할 수 있는 단일 정의로 패키징하여 훨씬 더 발전합니다.
- **자동화된 도구를 사용하여 네트워크 리소스 구성을 모니터링하고 변경 사항을 감지**: Azure 활동 로그는 Azure 리소스에 대한 모든 구성 변경 사항을 추적합니다. 중요한 리소스가 변경되면 트리거되도록 Azure Monitor에서 경고를 설정할 수 있고 설정해야 합니다.
- **고급 모니터링 요구 사항을 위해 Azure Sentinel을 고려**: 조직에서 중앙 집중식 리포지토리의 모든 보안, 진단 및 활동 로그를 모니터링해야 하는 경우(예: 변경 관리 작업을 모니터링 및 분석하거나 향후 문제를 해결하기 위해) Azure Sentinel 또는 타사 서비스를 사용하는 것이 좋습니다. 파티 SIEM 솔루션. 이를 사용하여 중앙 집중식 저장, 분석 및 검토에 필요한 모든 로그를 캡처할 수 있습니다.
- **조직의 규정 준수 요구 사항에 따라 보안 로그 저장소 보존을 구성**: 로그 데이터 보존과 관련된 조직의 규정 준수 요구 사항을 식별하고 환경 설계 시 이를 고려하는 것이 중요합니다. Log Analytics를 사용하면 최대 2년 동안 데이터를 저장할 수 있습니다. 그러나 더 오랫동안 로그를 저장하기 위한 두 가지 다른 옵션인 스토리지 계정과 SIEM 솔루션이 있습니다. 조직 요구 사항이 Log Analytics의 기능을 초과하는 경우 이를 사용하여 훨씬 더 오랜 기간 동안 로그를 저장할 수 있습니다. 또한 SIEM 솔루션은 조직의 요구 사항에 맞게 맞춤화될 수 있습니다.
- **정기적인 자동 백업**: Azure Firewall에는 백업 기능이 없습니다. 그러나 Azure Automation을 사용하여 방화벽 및 관련 리소스를 JSON 템플릿으로 내보내면 정기적인 자동 백업을 보장할 수 있습니다. Azure Portal의 템플릿 내보내기 기능을 사용하여 변경 관리 활동 전에 Azure Firewall 구성을 수동으로 내보낼 수도 있습니다.
- **잠금 활성화**: Azure Firewall 및 정책 리소스에 잠금을 활성화하여 실수로 삭제되지 않도록 할 수 있습니다. 방화벽은 모든 환경에서 중요한 리소스이며, 가동 중단이 발생하면 전체 환경이 오프라인 상태가 될 수 있다는 점을 고려하면 가능한 한 최선을 다해 보호하는 것이 좋습니다.

#제6장 Azure DNS

##개요
- Azure DNS는 DNS 서버의 Azure 글로벌 네트워크에서 호스팅되는 완전 관리형 서비스로, 100% SLA를 제공합니다. AnyCast 네트워킹을 사용합니다. 이를 통해 클라이언트는 사용 가능한 가장 가까운 Azure DNS 서버에서 이름 확인 서비스를 얻을 수 있으므로 DNS 쿼리의 대기 시간이 줄어듭니다.

##Azure DNS 기능
- **글로벌 규모 및 대기 시간 감소**: Azure DNS는 고객 DNS 도메인을 글로벌 DNS 이름 서버 네트워크에 저장합니다. 이렇게 하면 단일 지역의 중단으로 인해 고객을 위한 공용 DNS 서비스가 오프라인 상태가 되지 않습니다. Azure DNS는 AnyCast 네트워킹을 사용하여 DNS 쿼리 대기 시간을 줄이고 클라이언트 연결 성능을 향상시킵니다.
- **탁월한(Unbeatable) SLA**: DNS 도메인의 글로벌 중복성으로 인해 한 지역의 중단으로 인해 DNS 도메인이 글로벌 수준에서 오프라인 상태가 되지 않습니다. Azure DNS는 DNS 서버 중 하나 이상에서 유효한 DNS 요청 응답을 100% 보장합니다.
- **원활한(Seamless) 액세스 관리 및 모니터링**: Azure의 RBAC(역할 기반 액세스 제어)는 전체 관리 또는 특정 작업을 위해 Azure DNS에 대한 액세스를 제공합니다. DNS 서비스 구성 또는 DNS 레코드의 모든 변경 사항을 모니터링하고 추적하여 원치 않는 변경 사항을 감지합니다.
- **손쉬운 청구 관리**: Azure DNS 청구는 다른 모든 Azure 서비스에 대한 청구와 통합되어 공용 도메인 인프라와 관련된 비용을 더 쉽게 추적할 수 있습니다. 서비스 요금은 호스팅된 도메인 수와 수신된 DNS 쿼리 수를 기준으로 부과되며 종량제 기능을 제공합니다. 다른 타사 DNS 호스팅 서비스를 사용하면 서비스 가용성, 계약 갱신 및 청구에 대한 모니터링 및 관리와 관련하여 오버헤드가 추가될 수 있습니다.
- **개인 도메인 지원**: Azure DNS가 제공하는 주요 기능 중 하나는 개인 DNS 도메인 호스팅에 대한 지원입니다. 이를 통해 개인 가상 네트워크를 통합하고 DNS 서비스를 사용하여 통합을 통해 개인 사용자 지정 도메인을 호스팅할 수 있습니다.
- **별칭 레코드**: 별칭 레코드 세트는 Traffic Manager 프로필, Azure CDN 엔드포인트 및 Azure에서 호스팅되는 공용 IP 주소와 같은 Azure 리소스에 대한 참조를 만드는 데 도움이 됩니다. 별칭 레코드 세트는 Azure DNS를 사용하여 설정할 수 있으며 통합은 각 서비스에 대해 발생하는 모든 IP 주소 변경에 대한 자동 업데이트를 지원합니다.
- **프라이빗 DNS**: Azure DNS를 사용하면 Azure 가상 네트워크와 통합하여 프라이빗 DNS 영역을 호스팅할 수 있으며, 이를 통해 가상 네트워크에서 이름 확인 서비스를 제공할 수 있습니다. 또한 VM은 DNS 레코드를 자동으로 등록하고 업데이트하여 다른 DNS 서비스를 사용할 필요 없이 환경 내에서 이름 확인 서비스를 제공할 수 있습니다.

Azure DNS 제한 사항
- **DNSSEC** Azure DNS는 현재 DNSSEC를 지원하지 않습니다. DNSSEC가 필요한 조직을 위한 현재 지침은 Azure DNS 대신 타사 DNS 호스팅 서비스를 사용하는 것입니다.
- **도메인 이름 조달(procurement)**: Azure DNS를 사용하여 새 도메인 이름을 구입할 수 없습니다. 고객은 호스팅 서비스 및 기록 관리용으로만 Azure DNS를 사용하여 타사 도메인 이름 등록 기관에서 도메인 이름을 조달해야 합니다.
- **영역 전송(Zone Transfers)**: Azure DNS는 REST API를 사용하여 한 DNS 호스팅 공급자에서 다른 DNS 호스팅 공급자로 DNS 서비스를 마이그레이션할 수 있는 영역 전송을 지원하지 않습니다. 그러나 Azure CLI를 사용하여 DNS 레코드를 Azure DNS로 가져오거나 Azure Portal 또는 Azure PowerShell을 사용하여 항목을 만들 수 있습니다.
- **URL 리디렉션**: 일부 타사 DNS 공급자는 DNS 서비스의 일부로 URL 리디렉션을 제공합니다. 이를 통해 회사는 웹 애플리케이션에 대한 HTTP 리디렉션을 설정할 수 있습니다. 많은 조직에서 이 서비스를 유용하다고 생각하지만 리디렉션이 DNS가 아닌 HTTP 트래픽 계층에서 이루어지기 때문에 실제 DNS 기능으로 간주되지 않습니다. 따라서 이 단계에서는 URL 리디렉션이 Azure DNS 기능 세트의 일부로 제공되지 않습니다.

##설계 및 구성 고려 사항
DNS 영역 유형
- 공용 DNS 영역에서는 공개적으로 사용 가능한 도메인 이름(예: `contoso.com`)을 호스팅할 수 있습니다. 이 유형의 영역에는 일반적으로 웹 서버, 메일 서버 등과 같은 공용 서비스에 대한 DNS 레코드가 포함됩니다. 공용 DNS 영역을 사용하면 고객이나 공급업체의 외부 사용 및 직원의 내부 사용을 위해 조직에서 호스팅하는 DNS 레코드의 이름 확인을 위해 공용 인터넷을 통해 액세스할 수 있습니다. 공용 DNS 영역에 DNS 레코드가 설정될 수 있는 시나리오의 예는 다음과 같습니다.
    - 공개 웹사이트를 호스팅하는 조직은 공개 DNS 영역에 WWW DNS 주소(A) 레코드를 설정할 수 있습니다.
    - 이메일 서비스에 대한 액세스를 제공하기 위해 조직은 공용 DNS 영역에서 메일 서버 A 레코드를 호스팅할 수 있습니다.
    - 모든 조직은 다른 DNS 서버가 전자 메일을 식별하고 메일 서버로 라우팅할 수 있도록 공용 DNS 영역에 MX(메일 교환) 레코드를 설정합니다.
- 프라이빗 DNS 영역을 사용하면 Azure VM 리소스 간의 이름 확인에 필요한 내부 DNS 영역을 호스팅할 수 있습니다. 비공개 영역에는 다음 유형의 DNS 레코드가 포함될 수 있습니다.
    - WWW 웹 서버 및 웹 애플리케이션의 내부 IP가 포함된 DNS 레코드
    - 메일 서버용 내부 IP(사용 가능한 경우)가 포함된 DNS 레코드
    - 가상 네트워크 내에서 호스팅되는 VM에 대한 레코드
    - 가상 네트워크 내에서 호스팅되는 VM에 대한 PTR(Pointer) 레코드
- 영역은 가상 네트워크에 상호 연결되며 이름 확인은 링크가 있는 네트워크에 대해서만 작동합니다. 개인 DNS 영역의 인터넷 기반 이름 확인은 불가능합니다. 이는 사용자 지정 프라이빗 영역을 호스팅하기 위해 다른 DNS 솔루션을 설정할 필요 없이 가상 네트워크에서 호스팅되는 VM에 DNS 서비스를 제공하는 안전하고 안정적인 방법을 제공합니다.
- 동일한 도메인을 공용 DNS 영역과 개인 DNS 영역으로 호스팅할 수 있습니다. 이는 내부 및 외부 레코드가 다양한 동일한 서비스의 이름 확인을 위한 분할 수평 DNS 시나리오를 지원하여 내부 및 공용 네트워크를 통해 효율적으로 통신할 수 있도록 합니다.
- Azure DNS는 단일 레이블이 지정된 프라이빗 DNS 영역을 지원하지 않습니다. 모든 영역에는 점으로 구분된 두 개의 레이블(`contoso.com`)이 있어야 하며 최대 34개의 레이블이 있습니다.
- 영역 위임은 현재 지원되지 않으므로 하위 도메인을 별도의 프라이빗 DNS 영역으로 생성해야 합니다.

Azure 가상 네트워크와 연결
- 프라이빗 DNS 영역을 하나 이상의 Azure 가상 네트워크에 연결할 수 있습니다. 이를 통해 가상 네트워크에 호스팅된 VM이 Azure DNS를 사용하여 서비스에 호스팅된 프라이빗 DNS 영역의 이름을 확인할 수 있습니다.

<img src="https://drive.google.com/uc?id=1-8jzF5zMFm7VUWLRd25ryaz3eOgFuuXL">

역방향 DNS 조회
- Azure 프라이빗 DNS 영역은 연결된 가상 네트워크에서 호스팅되는 VM과 연결된 개인 IP 주소에 대해 역방향 DNS 조회 영역을 사용하여 역방향 DNS 조회를 지원합니다. 이는 애플리케이션이 확인 목적으로 역방향 조회를 요구하는 시나리오에서 도움이 될 수 있습니다.
- 역방향 DNS 영역을 사용하는 역방향 DNS 조회는 두 개의 FQDN을 반환합니다.
    - 기본 접미사가 `Internal.cloudapp.net`인 VM의 이름이 포함된 FQDN입니다 .
    - 자동 등록이 활성화된 경우 VM 이름과 프라이빗 DNS 도메인 이름의 접미사가 포함된 추가 FQDN.

##모범 사례
- **Azure RBAC(역할 기반 액세스 제어) 사용**: Azure DNS는 Azure RBAC를 지원하여 DNS 서비스에 대한 액세스를 제어합니다. RBAC를 사용하여 조직의 액세스 제어 요구 사항에 따라 서비스, 영역 또는 레코드 수준에서 DNS 서비스에 대한 액세스를 제한합니다. 잘못된 DNS 레코드로 인해 애플리케이션이 중단될 수 있으므로 DNS 서비스에 대한 부당한 변경을 방지하기 위해 액세스를 제어하는 것이 중요합니다.
- **DNS 영역 기여자(Contributor) 역할**: 사용 Azure는 DNS 영역 기여자라는 기본 제공 역할을 제공합니다. 이 역할을 가진 사용자는 DNS 리소스를 관리할 수 있지만 그게 전부입니다. 관리 목적으로만 DNS 서비스에 액세스해야 하는 개인이 조직에 있는 경우 이 역할을 사용하십시오.
- **사용자 지정 역할 사용**: DNS 영역 기여자 역할 외에도 특정 DNS 기능에 대한 액세스를 제한하는 사용자 지정 역할을 만들 수 있습니다. 예를 들어 A 레코드를 생성 및 수정하지만 다른 레코드 유형은 관리하지 않습니다. 필요한 역할을 식별하거나 생성한 후에는 필요한 수준에서만 액세스 권한이 할당되도록 할 수 있습니다. 사용 가능한 레벨은 다음과 같습니다.
    - **서비스 수준 Azure RBAC**: 권한은 Azure DNS 서비스 수준에 할당되므로 사용자는 서비스에서 호스팅되는 모든 영역을 관리할 수 있습니다.
    - **영역 수준 Azure RBAC**: 권한은 영역 수준에서 부여되므로 사용자는 해당 영역의 모든 레코드를 관리할 수 있습니다.
    - **레코드 집합 수준 Azure RBAC**: 권한은 레코드 집합 수준에서 할당되므로 사용자는 특정 레코드 집합을 관리할 수 있습니다.
- **리소스 잠금 사용**: 리소스 잠금 기능을 사용하여 DNS 영역 변경에 대한 액세스를 방지하거나 삭제를 위해 보호합니다. 귀하의 옵션은 다음과 같습니다:
    - **모든 변경 방지**: 읽기 전용 잠금을 생성하면 DNS 영역이 변경되지 않습니다. 이렇게 하면 DNS 쿼리에 응답할 수 있지만 잠금이 수정되거나 제거될 때까지 레코드가 더 이상 변경되지 않습니다.

<img src="https://drive.google.com/uc?id=1kCJfDbYJDsB6EcPzTgFTtkPHV8ZXCeII">

    - **개별 레코드 삭제 방지**: 레코드 세트 수준에서 리소스 잠금을 설정하여 개별 DNS 레코드의 변경 또는 삭제를 방지할 수 있습니다. 현재 Azure Portal이나 Azure CLI가 아닌 Azure PowerShell만 사용하여 레코드 세트 수준 리소스 잠금을 구성할 수 있습니다.
    - **전체 영역 삭제 방지**: 삭제 불가 잠금을 생성하면 DNS 영역이 우발적으로 또는 악의적으로 삭제되는 것을 방지할 수 있습니다.

<img src="https://drive.google.com/uc?id=1aslqhJUHEKrCJLH2QNbRhc0fArxQVO3l">

    - **모니터링 및 경고 설정**: Azure DNS는 호스팅된 DNS 영역의 성능을 모니터링하기 위한 메트릭을 제공합니다. 또한 Azure Monitor와 Azure DNS를 통합하여 주요 메트릭을 모니터링하여 성능을 측정하고 병목 현상을 식별할 수 있습니다. 일부 주요 지표에는 다음이 포함됩니다.
        - QueryVolume
        - RecordSetCount
        - RecordSetCapacityUtilization
    - 최소한 성능 매개변수 및 중요한 관리 작업에 대한 경고를 설정하는 것이 좋습니다.
    - **다른 Azure 서비스와 통합**: 필요한 경우 Azure DNS를 사용하여 환경에서 사용 중인 다른 Azure 서비스에 대한 사용자 지정 도메인 레코드를 게시할 수 있습니다. 여기에는 Azure Application Gateway, Azure Load Balancer, Azure Traffic Manager, Azure App Service, Azure Resource Manager VM 및 Azure Cloud Services가 포함됩니다. 각 서비스에 대해 IP 주소 구성을 기반으로 해당 DNS A 또는 CNAME 레코드를 생성할 수 있습니다. 동적으로 할당된 IP 주소를 사용하여 서비스에 대한 DNS CNAME 레코드를 생성할 수 있습니다. 고정 IP 주소를 사용하는 서비스의 경우 DNS A 레코드를 생성할 수 있습니다.
