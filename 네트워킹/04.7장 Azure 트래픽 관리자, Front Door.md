#제 7장 Azure 트래픽 관리자(Traffic Manager)

##개요
- Azure Traffic Manager는 인터넷 연결 엔드포인트로 들어오는 트래픽의 DNS 기반 부하 분산을 수행하는 서비스입니다. Traffic Manager 서비스는 다양한 Azure 지역에서 호스트되는 애플리케이션이나 클라이언트 환경 또는 기타 클라우드 서비스에서 호스트되는 외부 엔드포인트 간에 트래픽을 전 세계적으로 분산하는 것을 용이하게 합니다.
- Azure Traffic Manager의 가장 중요한 측면 중 하나는 서비스에 정의된 트래픽 라우팅 정책에 따라 DNS 기반 리디렉션을 수행한다는 것입니다. 애플리케이션 트래픽에 대한 프런트 엔드 게이트웨이 또는 프록시 역할을 하지 않습니다. 이는 애플리케이션 트래픽이 서비스를 통과하지 않음을 의미합니다. 단순히 지정된 엔드포인트로 리디렉션된 후 클라이언트가 지정된 애플리케이션 엔드포인트에 직접 연결됩니다. 또한 Traffic Manager가 OSI 모델의 계층 7에서 작동함을 보여줍니다.
- Traffic Manager와 함께 사용할 다양한 유형의 엔드포인트를 정의할 수 있습니다. 또한 조직의 고유한 가용성 요구 사항 및 애플리케이션 설계에 따라 들어오는 트래픽을 처리하기 위해 다양한 라우팅 알고리즘을 배포할 수도 있습니다.
- Microsoft는 탄력성이 매우 뛰어나도록 Traffic Manager를 설계했습니다. Azure 지역 오류가 발생하더라도 Microsoft는 이러한 유형의 시나리오를 처리하기 위해 서비스에 중복성을 구축했기 때문에 서비스를 오프라인으로 전환하지 않습니다.


##트래픽 관리자 기능
- Traffic Manager에는 클라이언트 애플리케이션의 가용성, 복원력 및 중복성을 향상시키는 여러 가지 주요 기능이 있습니다.
- **복잡한 요구 사항을 충족하는 여러 라우팅 알고리즘**: Traffic Manager는 클라이언트 환경의 요구 사항에 따라 단독으로 또는 조합하여 사용할 수 있는 다양한 트래픽 라우팅 알고리즘을 제공합니다. 각 유형의 알고리즘은 다양한 방식으로 애플리케이션의 중복성과 가용성을 향상시킵니다. 라우팅 방법을 결합하면 가장 복잡한 시나리오도 해결하는 데 도움이 될 수 있습니다.
- **향상된(Increased) 애플리케이션 복원력 및 가용성**: Traffic Manager는 지속적으로 애플리케이션 엔드포인트를 모니터링하고 엔드포인트 가용성에 따라 트래픽을 자동으로 라우팅합니다. 오프라인 엔드포인트에 대한 트래픽은 엔드포인트가 다시 온라인 상태가 될 때까지 자동으로 일시 중지됩니다.
- **향상된(Enhanced) 애플리케이션 성능**: 사용자 환경을 개선하기 위해 최종 클라이언트에 가장 짧은 대기 시간을 제공하는 엔드포인트로 트래픽을 라우팅하도록 Traffic Manager를 설정할 수 있습니다.
- **Azure 기반이 아닌 엔드포인트 지원**: Traffic Manager는 Azure 내부 및 외부(온-프레미스 환경, 기타 클라우드 서비스 등) 모두에서 호스팅되는 공용 엔드포인트의 사용을 지원합니다. 단일 Traffic Manager 라우팅 프로필에는 온-프레미스에서 Azure 클라우드로의 마이그레이션, IaaS에서 PaaS로의 마이그레이션, Azure로의 재해 복구 등과 같은 다양한 시나리오를 처리하기 위해 다양한 소스의 엔드포인트가 포함될 수 있습니다.
- **향상된(Improved)애플리케이션 확장성**: Traffic Manager는 조직이 기본 호스팅 위치에서 리소스 부족 문제가 발생할 경우 Azure 클라우드 용량을 사용하도록 버스트하여 애플리케이션에 확장 기능을 제공하는 데 도움이 될 수 있습니다.
- **유지 관리 기간 단축(Reduced maintenance windows）**: Traffic Manager는 유지 관리가 적용되지 않는 엔드포인트로 트래픽을 라우팅하여 애플리케이션 업그레이드 또는 보안 업데이트에 대한 유지 관리 기간을 줄이거나 없애는 데 도움이 될 수 있습니다.

##설계 개념 및 배포 고려 사항
Traffic Manager 엔드포인트
- Traffic Manager를 사용하면 트래픽 분산을 위해 다양한 엔드포인트 유형을 사용할 수 있습니다. Traffic Manager 프로필에 정의된 라우팅 방법에 따라 Traffic Manager는 엔드포인트 가용성을 평가하고 라우팅 알고리즘을 적용하여 트래픽을 라우팅할 엔드포인트를 결정합니다.
- **Azure 엔드포인트**: 이는 Azure 내부에서 호스팅되는 서비스입니다. 예를 들어 공용 애플리케이션을 실행하는 App Services 또는 VM(가상 머신)을 사용합니다.
- **외부(External) 엔드포인트**: 이는 온-프레미스 또는 다른 호스팅 공급자(다른 클라우드 공급자 포함)에 의해 Azure 외부에서 호스팅되는 서비스를 말합니다. Traffic Manager는 IPv4/IPv6 주소 또는 FQDN을 사용하여 이를 참조합니다.
- **중첩된(Nested) 엔드포인트**:는 여러 Traffic Manager 프로필을 결합하여 더 복잡한 트래픽 라우팅 구성을 만듭니다. 이는 대규모 배포의 요구 사항을 해결하는 데 도움이 됩니다.
- Traffic Manager 프로필을 설정할 때 각 Traffic Manager 프로필에서 구성할 수 있는 엔드포인트 수에는 제한이 없다는 점에 유의하세요. 또한 각 Traffic Manager 프로필에는 다양한 엔드포인트 유형이 혼합되어 포함될 수 있습니다.

Azure 엔드포인트
- Azure 호스팅 서비스는 Traffic Manager에서 Azure 엔드포인트로 설정됩니다. 다음을 포함하여 Traffic Manager와 함께 사용할 수 있는 다양한 Azure 서비스가 지원됩니다.
    - 웹 앱
    - 웹 앱 슬롯(slot)
    - VM-connected 공용 IP 주소
    - 로드 밸런서에 연결된 공용 IP 주소
    - PaaS 클라우드 서비스
- Azure 엔드포인트 사용의 주요 이점은 Azure가 Azure 웹 애플리케이션 서비스와 같은 서비스 상태를 감지하여 실행 중인지 중지되었는지 확인할 수 있다는 것입니다. 그런 다음 Azure는 백 엔드 엔드포인트가 중지되는 동안 Traffic Manager에 대한 청구를 자동으로 중지하고 다시 온라인 상태가 되면 재개할 수 있습니다. 공용 IP 주소 기반 엔드포인트에서는 해당 인스턴스에서 실제 리소스를 감지할 수 없으므로 이 기능은 지원되지 않습니다.

외부 엔드포인트
- 외부 엔드포인트은 공용 IPv4/IPv6 주소 또는 FQDN을 사용하여만 참조되거나 Azure 외부에서 호스팅되는 서비스입니다. 여기에는 온-프레미스 환경과 기타 호스팅되거나 Microsoft가 아닌 클라우드 환경에서 호스팅되는 애플리케이션이 포함됩니다. 또한 IPv4/IPv6 주소만 사용하여 게시해야 하는 Azure에서 호스팅되는 애플리케이션도 포함됩니다.
- Azure 웹 애플리케이션 서비스와 같은 일부 Azure 서비스의 경우 Traffic Manager 프로필은 지역당 하나의 엔드포인트만 Azure 엔드포인트로 참조할 수 있습니다. 그러나 웹 앱의 FQDN을 사용하여 외부 엔드포인트로 추가하면 이 제한을 극복할 수 있습니다.
- Azure 엔드포인트을 사용하면 오프라인 또는 비활성화된 Azure 호스팅 서비스에 대한 청구가 자동으로 해제될 수 있습니다. 그러나 외부 엔드포인트에는 동일하게 적용되지 않습니다. 외부 엔드포인트에 대한 청구를 해제하는 유일한 방법은 엔드포인트를 비활성화하거나 삭제하는 것입니다.
- 동일한 Traffic Manager 프로필에서 외부 엔드포인트와 Azure 엔드포인트를 결합할 수 있습니다. 예를 들어 애플리케이션의 FQDN은 온-프레미스 데이터 센터 및 Azure VM에서 호스팅되는 엔드포인트으로 라우팅될 수 있습니다. 그러나 이는 IPv4 또는 IPv6 주소를 사용하여 지정된 엔드포인트에는 적용되지 않습니다. 이는 외부 엔드포인트으로 개별적으로만 설정할 수 있습니다.
- Azure와 외부 엔드포인트가 단일 Traffic Manager 프로필에 결합되면 다양한 디자인 시나리오가 실행 가능해집니다.
    - Azure와 온-프레미스 또는 Azure와 기타 호스팅 공급자 관리 환경 간에 호스팅되는 애플리케이션에 대한 활성-활성 또는 활성-수동 장애 조치 옵션을 제공하여 탄력성을 높입니다.
    - 필요에 따라 확장할 수 있도록 Azure 클라우드에 용량을 제공하여 온프레미스 애플리케이션을 위한 리소스 버스트 기능을 제공합니다.
    - 사용자 지역에 더 가까운 애플리케이션 호스팅과 성능 기반 라우팅을 사용하여 대기 시간을 줄인 온프레미스 애플리케이션을 사용할 수 있도록 하여 애플리케이션 성능을 향상합니다.

중첩된 엔드포인트
- 중첩된 엔드포인트는 서로 다른 엔드포인트로 구성된 여러 Traffic Manager 프로필의 조합입니다. "상위(parent)" 프로필은 상위 프로필과 다른 엔드포인트를 포함하는 "하위(child)" 프로필을 가리키는 엔드포인트로 설정됩니다. 이러한 조합은 애플리케이션에 글로벌 확장성과 중복성을 제공하는 데 도움이 될 수 있는 복잡한 라우팅 논리를 생성합니다. 부모 프로필과 자식 프로필의 엔드포인트는 다를 수 있으며 다른 중첩된 Traffic Manager 프로필일 수도 있습니다

중첩된 Traffic Manager 프로필
- 중첩된 Traffic Manager 프로필은 여러 프로필을 결합하여 복잡한 트래픽 라우팅 기능을 지원합니다. 이는 조직의 복잡한 요구 사항을 해결하기 위해 라우팅 기능의 혼합이 필요한 대규모 애플리케이션 배포 시나리오에 적합합니다.
- 일반적으로 단일 Traffic Manager 프로필은 단일 트래픽 라우팅 방법을 사용할 수 있습니다. 중첩된 프로필을 사용하면 "상위(parent)" 프로필 내에 "하위(child)" Traffic Manager 프로필을 정의하여 엔드포인트 역할을 할 수 있습니다. 이를 통해 라우팅 정책과 엔드포인트 유형이 서로 다른 여러 프로필이 단일 중첩 프로필에서 함께 작동하여 복잡한 라우팅 요구 사항을 해결할 수 있습니다.
- 그림은 성능 트래픽 라우팅 방법을 사용하도록 상위 프로필을 설정하는 방법(잠시 설명)과 끝점 중 하나가 가중치 트래픽 라우팅 방법을 사용하도록 설정된 하위 프로필인 방법(다시 설명)을 보여줍니다. 잠시 후) 및 자체 엔드포인트 세트를 제공합니다. 이 빌드를 사용하면 트래픽의 작은 하위 집합을 "평가판(trial)" 엔드포인트로 라우팅하여 대부분의 환경에 영향을 주지 않고 애플리케이션 업그레이드나 패치를 테스트할 수 있습니다.

<img src="https://drive.google.com/uc?id=1ab2qTKh1EgCYqX-rll0qT83hnvIgynFj">

트래픽 라우팅 방법
- Traffic Manager의 가장 중요한 측면 중 하나는 Traffic Manager가 제공하는 다양한 트래픽 라우팅 방법과 알고리즘을 이해하는 것입니다. 다양하고 복잡한 요구 사항을 해결하기 위해 개별적으로 사용하거나 중첩된 프로필에 결합할 수 있는 다양한 기능을 갖춘 다양한 라우팅 방법이 있습니다. 그 중 4가지 방법은 다음과 같습니다.
    - 우선순위(Priority) 트래픽 라우팅
    - 가중치 기반(Weighted) 트래픽 라우팅
    - 성능(Performance) 트래픽 라우팅
    - 지리적(Geographic) 트래픽 라우팅
- 이러한 각 방법에는 프로필 구성에 따라 사용 가능한 다음 엔드포인트를 모니터링하고 자동으로 장애 조치하는 기능이 포함되어 있습니다.
- Traffic Manager 프로필의 일부로 이러한 트래픽 라우팅 방법을 구성하고 엔드포인트 집합에 적용할 수 있습니다. 설정한 라우팅 방법은 언제든지 교체할 수 있으며 다운타임 없이 변경 사항이 적용됩니다. 그러나 언급한 대로 더 복잡한 시나리오를 해결하기 위해 Traffic Manager 프로필을 중첩하여 여러 라우팅 방법을 조합하여 적용할 수 있습니다.

다중 값 및 서브넷 기반 트래픽 라우팅
- 우선 순위, 가중치, 성능 및 지리적 트래픽 라우팅 외에도 Traffic Manager는 다중 값 트래픽 라우팅과 서브넷 기반 트래픽 라우팅이라는 두 가지 다른 유형을 지원합니다.
- 모든 활성(active) 엔드포인트 주소를 최종 클라이언트에 반환해야 하는 시나리오에서는 다중 값 트래픽 라우팅을 사용하여 모든 다른 IPv4/IPv6 엔드포인트를 정의할 수 있습니다. 기본적으로 두 개의 활성 엔드포인트가 응답의 일부로 반환되지만 필요한 경우 이 수를 늘릴 수 있습니다. 엔드포인트가 이중 홈인 경우(즉, IPv4 및 IPv6 주소를 모두 사용하는 경우) 다중 값 트래픽 라우팅은 최종 클라이언트에 두 주소를 모두 제공하므로 최종 클라이언트는 연결을 시작할 때 어느 주소를 사용할지 결정할 수 있습니다.
0 반면, 서브넷 기반 트래픽 라우팅은 다양한 클라이언트 서브넷을 다양한 애플리케이션 엔드포인트에 매핑합니다. 특정 서브넷에서 시작된 요청은 해당 서브넷과 연결된 엔드포인트 맵을 기반으로 라우팅됩니다.

우선순위 트래픽 라우팅
- 조직에서 단일 기본 서버가 애플리케이션을 실행하고 기본 서버에 장애가 발생할 경우 하나 이상의 백업 서버가 애플리케이션 트래픽을 처리하도록 애플리케이션을 설계했다고 가정해 보겠습니다. 이는 애플리케이션 제한으로 인해 한 번에 둘 이상의 활성 서버를 지원할 수 없기 때문일 수 있습니다. 또는 기본 엔드포인트가 오프라인이 될 때까지 보조 엔드포인트를 사용할 수 없는 재해 복구 시나리오를 해결하기 위한 것일 수도 있습니다.
- 이러한 경우 가장 효과적인 트래픽 라우팅 방법은 우선순위 방법입니다. 우선순위 트래픽 라우팅은 클라이언트 트래픽을 라우팅할 기본 엔드포인트와 문제 발생 시 장애 조치할 우선순위별로 구성된 하나 이상의 백업 엔드포인트를 정의합니다. 우선 순위가 가장 높은 끝점은 사용할 수 없게 될 때까지 트래픽을 수신하며, 이 단계에서 트래픽은 두 번째로 높은 우선 순위 끝점으로 리디렉션됩니다.

<img src="https://drive.google.com/uc?id=16M0IuTBSnIq_2iw_NP91VEUnN31tQ3sF">

- 이 방법을 사용하면 모든 엔드포인트에 고유한 우선순위가 있습니다. 즉, 두 엔드포인트가 동일한 우선순위를 가질 수 없습니다. 예를 들어 유지 관리 목적으로 엔드포인트가 오프라인 상태가 되거나 비활성화되거나 중단이 발생하지 않는 한, 바로 위에 우선 순위가 지정된 엔드포인트에 문제가 발생하면 자동으로 트래픽을 수신하게 됩니다. 엔드포인트에 대해 정의된 우선순위가 없으면 서비스에 추가된 순서에 따라 자동으로 할당됩니다.

가중치 기반 트래픽 라우팅
- 트래픽을 엔드포인트 집합에 균등하게 분산해야 하는 시나리오에서는 가중치 기반 트래픽 라우팅이 가장 적합한 방법인 경우가 많습니다. 이 방법을 사용하면 각 애플리케이션 엔드포인트에 대한 가중치를 정의할 수 있습니다. 가중치가 높은 엔드포인트는 더 많은 트래픽을 수신합니다. 다르게 말하면 엔드포인트의 가중치가 높을수록 우선순위도 높아집니다.

<img src="https://drive.google.com/uc?id=1GdAMO28dCACrEg9sciNA1e8rueoN9uvb">

- 엔드포인트에 가중치가 할당되지 않은 경우 Traffic Manager는 기본적으로 가중치 1을 할당합니다.
- 여러 엔드포인트에 동일한 가중치를 할당하여 트래픽을 균등하게 분산할 수 있습니다. 이 접근 방식은 트래픽을 먼저 기본 위치의 여러 활성 끝점으로 라우팅하고 두 번째로 장애 복구 또는 재해 복구 사이트의 여러 활성 끝점으로 라우팅해야 하는 시나리오에서 효과적입니다.
- DNS 응답은 최종 클라이언트와 해당 클라이언트에 서비스를 제공하는 재귀 DNS 서버에 의해 캐시됩니다. DNS 캐싱 동작을 가능한 모든 액세스 포인트에 걸쳐 중앙에서 제어할 수 없기 때문에 이로 인해 트래픽이 고르지 않게 분산될 수 있습니다. 이것이 사용자 환경에 적합한 라우팅 방법인지 결정할 때 이를 고려해야 합니다.

성능 트래픽 라우팅
- 성능 트래픽 라우팅을 사용하면 Traffic Manager는 가장 짧은 대기 시간을 제공하는 엔드포인트를 기준으로 트래픽을 라우팅합니다. 때때로 이는 클라이언트 IP 주소에 가장 가까운 엔드포인트가 되지만 항상 그런 것은 아닙니다. 다른 엔드포인트가 더 짧은 대기 시간을 제공할 수 있는지 확인하기 위해 Traffic Manager는 원본 IP 범위와 다양한 Azure 지역 간의 왕복 시간을 추적하여 생성 및 유지 관리하는 인터넷 대기 시간 테이블을 참조합니다. Traffic Manager가 가장 짧은 대기 시간을 제공하는 것으로 식별한 Azure 지역에 여러 활성 엔드포인트가 포함되어 있는 경우 Traffic Manager는 사용 가능한 모든 엔드포인트에 걸쳐 해당 지역에 트래픽을 균등하게 자동 배포합니다.

<img src="https://drive.google.com/uc?id=1GXK1m9jT_52e6M4Eb_V7ZLWS_00DHRYF">

- Traffic Manager는 가장 낮은 대기 시간을 제공하는지 확인하기 위해 엔드포인트 자체의 실제 성능이나 가용성을 모니터링하지 않습니다. 인터넷 대기 시간 표만을 기준으로 대기 시간 성능을 평가합니다. 이 대기 시간 표는 글로벌 인터넷 라우팅 인프라 또는 성능의 변경 또는 온라인으로 제공되는 새로운 Azure 지역으로 인해 업데이트될 수 있습니다.
- 성능 트래픽 라우팅은 Azure 외부에서 호스팅되는 외부 엔드포인트와 중첩 엔드포인트의 사용을 지원합니다. 이러한 경우 해당 엔드포인트에 가장 가까운 Azure 지역을 선택하여 엔드포인트의 위치를 정의해야 합니다. 가장 가까운 Azure 지역의 엔드포인트가 오프라인이거나 성능이 저하된 경우 Traffic Manager는 다음으로 가까운 Azure 지역의 활성 엔드포인트로 트래픽을 이동합니다.
- DNS 쿼리를 수행하는 엔드포인트의 소스 IP도 대기 시간을 측정하는 데 도움이 됩니다. 대부분의 경우 이는 재귀적 DNS 서버입니다. 따라서 DNS 응답에 반환된 Azure 지역은 DNS 서버에 가장 가까운 지역이 됩니다. 조직이 데이터 센터에서 호스팅되는 모든 클라이언트에 대해 중앙 집중식 DNS 서버를 사용하는 경우 출장 중인 직원은 지구 반대편에서 연결하더라도 조직의 데이터 센터에 가장 가까운 Azure 지역에 연결해야 할 수 있습니다. 사용할 트래픽 라우팅 방법을 선택할 때 이 점을 고려해야 합니다.

지리적 트래픽 라우팅
- 지리적 트래픽 라우팅은 요청 원본을 기반으로 트래픽을 라우팅해야 하는 엔드포인트를 정의합니다. 예를 들어 데이터 주권, 콘텐츠 현지화 또는 규정 준수 요구 사항에 따라 다양한 로케일의 트래픽을 다양한 엔드포인트로 라우팅할 수 있습니다.
- Azure에서 호스팅되는 특정 외부 또는 중첩 엔드포인트로 리디렉션하여 다양한 지역의 트래픽을 처리하도록 여러 엔드포인트를 정의할 수 있습니다. Traffic Manager가 DNS 요청의 원본 지역을 결정한 후 트래픽을 라우팅해야 하는 방법을 이해할 수 있도록 각 엔드포인트에 지리적 지역 집합을 할당해야 합니다. 다양한 세부 수준을 사용하여 지리적 지역을 정의할 수 있습니다.
    - **세계(World)**: 모든 지역.
    - **지역(Region)**: 특정 지역(예: 아시아, 아프리카, 북미, 호주/태평양 등)입니다.
    - **국가(Country)**: 특정 국가(예: 인도, 프랑스, 미국, 캐나다 등)입니다.
    - **주/지방(State/Province)**: 특정 주 또는 지방(예: 호주-빅토리아, 캐나다-빅토리아, 캐나다-온타리오, 미국-플로리다 등)(현재는 호주, 캐나다 및 미국에만 적용 가능)
- 엔드포인트와 연결된 지역에 따라 트래픽은 해당 지역에 있는 엔드포인트로만 라우팅됩니다. 라우팅은 엔드포인트 구성에 따라 다음 순서로 발생합니다.
    1. State/Province
    2. Country
    3. Region
    4. World

<img src="https://drive.google.com/uc?id=18F92GsJT0gPM8B_bhwUVJ3joc-AEQ4cq">

- 각 지리적 지역은 하나의 엔드포인트에만 연결될 수 있습니다.
- Traffic Manager는 엔드포인트의 상태를 확인하지 않습니다. 엔드포인트가 비정상 상태인 경우에도 해당 엔드포인트를 응답으로 반환합니다.
- 요청이 여러 엔드포인트의 지리적 매핑과 일치하는 경우 요청 지역에 가장 가까운 세분성으로 정의된 엔드포인트가 반환됩니다.
- 중첩된 엔드포인트에 여러 엔드포인트를 정의할 수 있으므로 알 수 없는 소스 또는 엔드포인트가 오프라인인 시나리오를 처리하기 위해 지리적 매핑을 정의하려면 중첩된 엔드포인트를 사용하는 것이 좋습니다.
- 알 수 없는 모든 트래픽 소스를 처리하도록 여러 엔드포인트를 구성할 수 있도록 중첩된 Traffic Manager 프로필과 함께 지리적 트래픽 라우팅을 사용하는 것이 가장 좋습니다.
- 비활성화된 엔드포인트는 모든 응답에서 제외됩니다.

엔드포인트 모니터링
- Traffic Manager의 가장 중요한 기능 중 하나는 작동하지 않는 엔드포인트에서 자동으로 트래픽을 장애 조치하는 기능입니다. 이를 위해서는 모든 활성 엔드포인트의 상태에 대한 정보가 최신인지 확인하기 위한 지속적인 모니터링이 필요합니다. 엔드포인트를 오프라인, 비활성화 또는 비활성화로 식별하는 상태 변경은 라우팅 방법 및 엔드포인트 구성을 기반으로 한 작업으로 이어집니다. 다행히 Azure Traffic Manager에는 엔드포인트 상태를 모니터링하고 다른 활성 또는 수동 엔드포인트에 대한 자동화된 장애 조치(failover)를 수행하도록 설정할 수 있는 기본 제공 엔드포인트 모니터링 기능이 있습니다. 여기에는 모니터링 프로토콜 및 기타 중요한 설정을 선택하는 작업이 포함됩니다.

엔드포인트 장애 조치 및 복구
- Traffic Manager는 비정상 엔드포인트를 포함하여 모든 엔드포인트의 상태를 주기적으로 확인합니다. Traffic Manager는 이전에 비정상이었던 엔드포인트가 정상이 되는 시기를 감지하고 이를 다시 순환으로 가져옵니다. 다음 시나리오에서는 엔드포인트가 비정상으로 간주됩니다.
    - 모니터링 프로토콜이 HTTP 또는 HTTPS인 경우 200이 아닌 응답 또는 예상 상태 코드 범위 설정에 지정된 상태 범위를 포함하지 않는 응답이 수신됩니다. (여기에는 다른 2XX코드 또는 301/302 리디렉션이 포함됩니다.)
    - 모니터링 프로토콜이 TCP인 경우 연결 설정을 시도하기 위해 Traffic Manager가 보낸 SYN 요청에 대한 응답으로 ACK 또는 SYN-ACK 이외의 응답이 수신됩니다.
    - 시간 초과 다른 연결 문제로 인해 엔드포인트에 연결할 수 없게 됩니다.
- 이러한 시나리오가 발생하면 트래픽은 Traffic Manager 프로필에 정의된 라우팅 정책에 따라 나머지 온라인 엔드포인트로 장애 조치됩니다.

<img src="">

<img src="">

##모범 사례
- **RBAC를 사용하여 액세스 제어**: Traffic Manager에 대한 액세스를 필수 관리자로 제한합니다. 서비스를 무단으로 변경하면 서비스가 중단될 수 있습니다. 일반적으로 Traffic Manager는 높은 수준의 중복성 및 가용성이 필요한 애플리케이션에 사용됩니다. 따라서 서비스에 대한 액세스를 제한하는 것이 중요합니다. 구독 소유자 또는 기타 확장 액세스 권한을 제공하는 대신 Traffic Manager 구성을 관리하기 위해 액세스 권한이 필요한 관리자를 Azure의 Traffic Manager 기여자 역할에 추가할 수 있습니다. 이 역할은 프로필 관리에 대한 액세스를 제한합니다.
- **실제 사용자 측정 설정**: 성능 기반 라우팅 알고리즘을 사용하는 경우 Traffic Manager는 들어오는 클라이언트 엔드포인트와 애플리케이션이 호스팅되고 온라인인 다른 Azure 지역 간의 대기 시간을 기반으로 트래픽을 전달해야 합니다. 이를 달성하기 위해 Traffic Manager는 해당 애플리케이션에 대한 활성 Azure 지역에 대한 다양한 클라이언트 네트워크 간의 대기 시간을 모니터링하고 기록하는 인터넷 대기 시간 테이블을 유지 관리합니다. 실제 사용자 측정이라는 기능을 활성화하면 애플리케이션 수준에서 보다 정확한 측정을 통해 이 논리를 미세 조정할 수 있습니다. 이 기능은 최종 사용자 장치에서 해당 장치에서 응용 프로그램을 호스팅하는 다양한 활성 Azure 지역까지의 대기 시간을 테스트하는 데 사용되는 코드 조각을 응용 프로그램에 포함합니다. 그런 다음 이 정보는 웹 애플리케이션과 공유되어 Traffic Manager로 전달됩니다. 이 정보는 반복해서 수집되므로 Traffic Manager가 해당 네트워크의 대기 시간을 심층적으로 분석하고 들어오는 트래픽을 더 정확하게 리디렉션하는 데 도움이 됩니다.
- **트래픽 보기(Traffic View) 사용**: 트래픽 보기는 Traffic Manager 서비스에 대한 트래픽을 모니터링하고 더 깊은 통찰력을 얻을 수 있는 Traffic Manager의 추가 기능 서비스입니다. 트래픽 보기를 사용하면 다음 사항을 더 잘 이해할 수 있습니다.
    - 애플리케이션의 소스 트래픽이 생성되는 위치
    - 다양한 소스 클라이언트 지역의 트래픽 양
    - 다양한 소스 클라이언트 지역의 사용자가 경험한 지연 시간
    - 원본 클라이언트 지역과 해당 엔드포인트를 호스팅하는 Azure 지역 간의 트래픽 패턴
    - 이러한 통찰력은 지연 시간이나 성능 문제를 해결하기 위해 확장할 지역이나 현재 생성되는 트래픽 양을 기반으로 성장을 위해 추가 투자할 지역에 대해 더 나은 결정을 내리는 데 도움이 될 수 있습니다.
- **Azure 활동(Activity) 및 Azure Monitor를 사용하여 보안 로그를 중앙 집중화**: Azure 활동 로그는 제어 평면 수준의 Traffic Manager 리소스에서 수행되는 모든 작업과 관련된 모든 정보를 캡처합니다. 서비스의 활동 로그 섹션에서 이러한 로그를 모니터링하거나 데이터 집계 및 분석을 위해 Azure Monitor를 통해 중앙 리포지토리로 수집할 수 있습니다.
- **위협 감지(Threat detection) 활성화**: 모든 Traffic Manager 로그는 Azure Sentinel과 같은 SIEM 또는 타사 SIEM 솔루션을 사용하여 전달되고 중앙 집중화될 수 있습니다. 이를 사용하여 로그에 기록된 위협 및 침해에 대한 분석을 수행하고 작업을 자동화할 수 있습니다.
- **Azure Policy를 사용하여 구성 표준화**: Azure Policy를 사용하여 Traffic Manager 리소스의 구성을 모니터링하여 조직 표준을 준수하는지 확인할 수 있습니다. Azure Policy는 보안 및 규정 준수를 위해 제어 평면의 모든 작업이 기록되고 중앙에 저장되도록 Traffic Manager 리소스 로깅이 활성화되어 있는지 여부를 감지할 수 있습니다.
- **Azure Monitor를 사용하여 모니터링 및 경고 활성화**: Traffic Manager는 Azure Monitor를 사용하여 모니터링하고 경고를 생성할 수 있는 몇 가지 주요 서비스별 메트릭을 제공합니다.
    - **엔드포인트별 엔드포인트 상태**: 이 메트릭은 Traffic Manager 프로필에 있는 모든 엔드포인트의 상태를 모니터링하고 확인합니다. 엔드포인트가 작동 중인지 작동 중지 상태인지 기록하고, Azure Monitor에서 값을 모니터링하여 필요에 따라 경고를 발생시킬 수 있습니다.
    - **반환된 엔드포인트별 쿼리**: 이 메트릭은 특정 기간 동안 Traffic Manager 프로필 및 개별 엔드포인트에서 수신한 쿼리 수를 기반으로 다양한 엔드포인트의 부하를 모니터링합니다. 쿼리 분포에 불균형이 있을 때 플래그를 지정하도록 경고를 설정할 수 있으며, 지정된 기간 동안 경고가 지속되는 경우 애플리케이션 용량을 해결할 수 있습니다.

#제 8장 Azure Front Door

##개요
- Azure Front Door는 모든 웹 애플리케이션에 대한 보안 프런트 엔드를 제공하는 확장 가능한 완전 관리형 글로벌 서비스입니다. 이는 Microsoft의 글로벌 에지 네트워크를 사용하여 액세스 속도를 향상시키고 소비자 대상 또는 내부 웹 애플리케이션에 대해 더 나은 보안과 향상된 확장성을 제공합니다.
- 웹 애플리케이션에 대한 전 세계 고객을 보유하고 있는 조직은 웹 애플리케이션이 최종 사용자의 지역에 근접해 있다는 이점을 누릴 수 있습니다. 이러한 청중에게 일관된 경험을 제공하기 위해 조직은 CDN(콘텐츠 전송 네트워크)을 사용할 수 있습니다. Azure Front Door 서비스는 WAF(웹 애플리케이션 방화벽) 및 Azure Traffic Manager 서비스의 일부인 보안 및 라우팅 기능과 함께 CDN 기능을 제공합니다.
- Front Door 서비스는 OSI 모델의 계층 7(애플리케이션 계층)에서 작동합니다. 이는 분할 TCP와 함께 애니캐스트 프로토콜을 사용합니다. 이는 기존 CDN뿐만 아니라 DDoS(분산 서비스 거부) 보호와 같은 보안 기능도 제공합니다. Front Door 서비스의 트래픽 라우팅 기능은 Azure 내부 또는 외부에서 호스팅되는 모든 공용 서비스에 글로벌 부하 분산 및 자동화된 장애 조치(failover) 기능을 제공합니다. 지역별 오류 처리 기능이 서비스에 내장되어 재해 시나리오에서도 온라인 상태를 유지합니다.

##주요 특징들
- **향상된 애플리케이션 성능**: Front Door 서비스는 분할 TCP 기반 애니캐스트 프로토콜을 사용하여 애플리케이션 성능을 가속화합니다.
- **글로벌 확장성**: Front Door 서비스는 사용자가 가장 가까운 엣지 위치를 통해 액세스할 수 있도록 웹 애플리케이션에 대한 글로벌 확장성을 제공합니다.
- **지능형 트래픽 라우팅**: Front Door 서비스는 Azure 내부 또는 외부에서 호스팅되는 백 엔드 서비스에 대한 지능형 트래픽 라우팅을 수행할 수 있습니다. 다양한 라우팅 알고리즘은 복잡한 라우팅 요구 사항을 지원합니다.
- **모니터링 및 자동화된 장애 조치(failover)**: Front Door는 백 엔드 리소스를 모니터링하고 자동화된 장애 조치(failover) 작업을 트리거하는 상태 프로브를 제공합니다.
- **WAF 기능**: Front Door 서비스는 URL 기반 라우팅, URL 다시 쓰기, 세션 선호도, SSL 오프로딩, 사용자 지정 도메인 및 인증서 관리, 애플리케이션 보안 등 WAF에서 제공하는 모든 기능을 제공합니다.
- **다중 웹 사이트 호스팅**: Front Door 서비스는 동시에 여러 웹 사이트를 지원하므로 응용 프로그램 인프라를 효율적으로 사용할 수 있습니다.
- **고급 기능에 대한 기본 지원**: Front Door 서비스는 기본적으로 DSA(동적 사이트 가속), TLS/SSL 오프로딩, 종단 간 IPv6 연결 및 HTTP/2 프로토콜을 지원합니다.
- 그림은 Front Door 서비스가 다음을 포함하여 다양한 시나리오를 지원할 수 있는 방법을 보여줍니다.
    - Azure 지역 간 장애 조치(failover)
    - 트래픽 라우팅 기반 URL 경로
    - 다양한 백엔드 호스트 유형

<img src="https://drive.google.com/uc?id=1uRiiKwHqLR69MBbD0sprspFNFIGRXbrb">

##설계 개념 및 배포 고려 사항
백엔드
- 백엔드는 Azure 내부 또는 외부에 배포된 웹 기반 애플리케이션입니다. 백엔드는 애플리케이션 프런트 엔드를 호스팅하는 서버 또는 서비스를 나타냅니다. Front Door 서비스는 온-프레미스 인프라나 호스팅 또는 클라우드 인프라 공급자에서 호스팅되는 애플리케이션을 지원합니다. 백엔드는 호스트 이름이나 공용 IP 주소를 사용하여 참조할 수 있습니다.
- Front Door 서비스는 다음을 포함하여 백엔드로 사용할 다양한 Azure 서비스를 지원합니다.
    - App Service
    - Cloud Service
    - Azure 스토리지
    - 공용 IP 주소
- 다른 Azure 또는 Azure가 아닌 서비스의 경우 사용자 지정 호스트를 정의할 수 있습니다.
- 백 엔드에는 동일하거나 다른 Azure 지역 또는 하이브리드 설정에서 호스팅되는 동일한 웹 애플리케이션의 여러 인스턴스가 포함될 수 있습니다. 다양한 백엔드 엔드포인트에 우선순위와 가중치를 할당하여 기본 엔드포인트로 사용해야 할 엔드포인트와 백업으로 사용해야 할 엔드포인트를 정의할 수 있습니다.

백엔드 풀
- 여러 백엔드 엔드포인트를 웹 애플리케이션에 대한 트래픽을 수신하는 백엔드 풀로 결합할 수 있습니다. 이러한 끝점은 동일하거나 다른 Azure 지역에서 호스팅되거나 온-프레미스, Azure 및 기타 클라우드 호스팅 서비스 간의 하이브리드 설정에서 호스팅되는 웹 애플리케이션을 제공할 수 있습니다.
- Front Door 서비스의 백 엔드 풀은 앱에 대해 유사한 트래픽을 수신하는 백 엔드 집합을 설명합니다. 즉, 동일한 트래픽을 수신하고 예상되는 동작으로 응답하는 전 세계 앱 인스턴스의 논리적 그룹입니다. 이러한 백엔드는 여러 지역에 걸쳐 또는 동일한 지역 내에 배포됩니다. 모든 백엔드는 활성/활성 배포 모드 또는 활성/수동 구성일 수 있습니다.
- 백엔드 풀에서 백엔드 엔드포인트에 대한 모니터링 및 부하 분산을 구성합니다.

상태 프로브
- Front Door 서비스는 상태 프로브를 사용하여 백 엔드 엔드포인트의 상태를 모니터링할 수 있습니다. 상태 프로브는 Front Door 서비스가 들어오는 클라이언트 요청을 처리하는 데 현재 사용할 수 있는 백 엔드를 식별하는 데 도움이 됩니다. 상태 프로브는 구성 단계에서 정의된 HTTP/HTTPS를 통해 Front Door 서비스에서 각 백 엔드에 대한 합성 요청입니다. 엔드포인트의 응답은 Front Door 서비스가 들어오는 트래픽을 라우팅하는 데 가장 적합한 백 엔드를 결정하는 데 도움이 됩니다.
- 서비스는 다양한 매개변수를 고려하여 특정 요청에 가장 적합한 백엔드를 결정합니다. 여기에는 다음이 포함됩니다.
    - 활성화된 엔드포인트 식별 및 비활성화된 엔드포인트 무시
    - 기존 상태 프로브 오류가 없는 엔드포인트를 식별하고 오류가 있는 엔드포인트를 무시합니다.
    - 계산 시 각 정상 백엔드의 대기 시간을 고려합니다.
- Front Door 서비스는 모든 백 엔드가 오프라인이라고 판단하는 경우 모두 정상이라고 가정하고 하나 이상의 정상 백 엔드가 다시 온라인이 될 때까지 모든 백 엔드 간에 지속적으로 트래픽을 라우팅합니다.

로드 밸런싱
- 백엔드 풀은 웹 애플리케이션의 부하 분산 정책에 대한 구성을 보유합니다. 이러한 설정은 다음 매개 변수를 기반으로 백엔드가 정상인지 여부를 확인하기 위해 상태 프로브 응답을 평가하는 방법을 정의합니다.
    - **샘플 크기(Sample size)**: 상태 평가를 위해 고려해야 하는 상태 프로브 샘플 수를 설정합니다.
    - **성공적인 샘플 크기(Successful sample size)**: 샘플 크기를 기준으로 수집된 샘플 중에서 엔드포인트가 정상으로 간주되는 데 적합한 성공적인 샘플 수를 정의합니다.
    - **대기 시간 민감도(Latency sensitivity)**: 라우팅 결정을 내릴 때 엔드포인트의 대기 시간이 어떻게 고려되는지 정의합니다.

트래픽 라우팅
- Front Door 서비스는 들어오는 애플리케이션 트래픽에 가장 적합한 백 엔드 엔드포인트를 식별하는 방법을 정의하는 다양한 트래픽 라우팅 알고리즘을 지원합니다. Front Door 서비스가 호스트 헤더와 일치하는 HTTP/HTTPS 트래픽을 받으면 트래픽 라우팅 알고리즘은 연결된 활성 엔드포인트를 기반으로 연결할 가장 적절한 백 엔드 엔드포인트를 식별하는 데 도움이 됩니다. 모든 방법은 자동 모니터링 및 활성 엔드포인트에 대한 장애 조치를 지원하지만 엔드포인트 선택 기준은 각각 다릅니다.
- **지연 시간(Latency-based) 기반 라우팅**: 최종 사용자에 대한 지연 시간이 가장 짧은 엔드포인트를 식별하고 사용할 수 있는 경우 해당 엔드포인트로 트래픽을 라우팅합니다.
- **우선순위 기반(Priority-based) 라우팅**: 기본 엔드포인트가 오프라인인 경우 애플리케이션 트래픽과 백업 엔드포인트를 수신해야 하는 기본 엔드포인트를 식별합니다.
- **가중치 기반(Weight-based) 라우팅**: 트래픽 분산을 위해 각 끝점에 대해 서로 다른 가중치를 식별합니다. 트래픽은 가장 높은 가중치를 공유하는 모든 엔드포인트에 고르게 분산됩니다. 해당 백엔드를 사용할 수 없는 경우 트래픽은 자동으로 다음 엔드포인트 세트로 라우팅됩니다. 풀에 대해 정의된 허용 가능한 대기 시간 범위에 따라 엔드포인트가 허용 가능한 한도 내에 있는 것으로 간주되면 트래픽이 균등하게 분산됩니다.
- **세션 선호도(Session affinity)**: 동일한 최종 클라이언트에서 들어오는 클라이언트 요청이 동일한 백엔드 인스턴스로 전송됩니다. 이는 올바르게 작동하기 위해 세션 선호도가 필요한 애플리케이션에 유용합니다.

URL 재작성(rewrite)
- URL 재작성을 사용하면 요청을 백엔드로 라우팅하는 URL 요청을 구성할 때 사용자 지정 전달 규칙을 설정할 수 있습니다. 이는 페이지 변경이나 마스킹으로 인해 특정 수신 요청에 대해 트래픽을 사용자 지정 경로로 라우팅해야 하는 시나리오에 도움이 됩니다.
- 애플리케이션에 대한 사용자 지정 전달 경로를 정의하지 않으면 트래픽은 항상 수신 요청에 정의된 경로로 라우팅됩니다.
- 그림에 표시된 예에서 `/path1`에 대한 요청은 해당 경로 아래의 모든 세그먼트에 적용된다는 것을 나타내기 위해 끝에 와일드카드를 사용하여 사용자 정의 경로 `/path2`로 전달됩니다. 이로 인해 path1에 대한 모든 수신 요청이 path2로 리디렉션됩니다.

<img src="https://drive.google.com/uc?id=1lOnqrjWfeDvtHYmBBKRwmnbrHPFeM4z4">

URL 리디렉션
- Front Door 서비스는 URL 리디렉션을 지원합니다. 이를 통해 프로토콜, 앱 호스트 이름, 앱 경로 및 쿼리 문자열을 기반으로 트래픽 리디렉션에 대한 규칙을 정의할 수 있습니다. 이 리디렉션은 세분화되어 경로 수준에서도 작동하므로 개별 마이크로서비스는 물론 글로벌 리디렉션에 대해서도 구성하여 서비스 사용을 최적화할 수 있습니다.

<img src="https://drive.google.com/uc?id=1sotV1nt4NAEfRCK5aEHg8EY9Fh2vO6yI">

- **Route Type(경로 유형)**: 리디렉션 구성 옵션을 사용할 수 있도록 하려면 이를 Redirect로 설정합니다.
- **Redirect Type(리디렉션 유형)**: 리디렉션의 목적을 나타내며 최종 클라이언트가 서비스의 응답을 올바르게 해석하는 데 도움이 됩니다.
- **Redirect Protocol(리디렉션 프로토콜)**: 트래픽이 HTTP 또는 HTTPS를 통해서만 허용되는지 아니면 그대로 유지되는지를 나타냅니다.
- **Destination host(대상 호스트)**: 대상 호스트는 들어오는 요청에 표시된 이름이 아닌 다른 호스트 이름으로 트래픽을 리디렉션해야 하는지 여부를 나타냅니다. 이는 트래픽을 내부 URL로 리디렉션하는 데 도움이 될 수 있습니다. 예를 들어 `https://www.fabrikam.com/*`에 대한 트래픽은 `https://www.contoso.com/*`로 리디렉션되도록 설정할 수 있습니다.
- **Destination Path(대상 경로)**: URL의 경로 세그먼트를 다른 경로로 바꿔야 하는 경우 이를 바꾸기로 설정하십시오. 예를 들어 `https://www.fabrikam.com/*`에 대한 트래픽은 `https://www.fabrikam.com/redirected-path`로 리디렉션되도록 설정할 수 있습니다.
- **Query String(쿼리 문자열)**: 리디렉션된 URL의 쿼리 문자열 매개 변수를 바꾸려면 이것을 바꾸기로 설정합니다.
- **Destination Fragment(대상 조각)**: 리디렉션할 URL 조각을 나타냅니다. 이 조각은 브라우저가 웹 페이지의 특정 섹션으로 이동하는 데 도움이 되는 `#` 문자 뒤의 URL의 일부입니다. 이 설정을 사용하면 대상 조각을 사용하도록 리디렉션된 URL을 설정할 수 있습니다.

와일드카드 도메인
- Front Door 서비스는 프로필에서 프런트 엔드 엔드포인트를 매핑하기 위해 와일드카드 도메인 사용을 지원합니다. 와일드카드 도메인을 사용하면 다음과 같은 여러 가지 이점을 얻을 수 있습니다.
    - Front Door 서비스 프로필에서 개별 하위 도메인을 설정할 필요성이 줄어들고 각 도메인에 대한 HTTPS 인증서 바인딩이 용이해집니다.
    - 단일 라우팅 규칙을 사용하여 여러 하위 도메인에 대한 트래픽 라우팅 동작을 단순화할 수 있습니다. 예를 들어 `*.domain.com`에 대한 단일 규칙을 사용하여 `subdomain1.domain.com`, `subdomain2.domain.com`, `subdomain3.domain.com` 등에 대한 라우팅 정책을 정의할 수 있습니다.
    - Front Door 서비스 구성을 변경하지 않고도 새 하위 도메인을 온라인으로 쉽게 가져올 수 있습니다. 이미 정의된 정책은 새 하위 도메인에 자동으로 적용됩니다.

규칙 엔진(Rules Engine)
- Front Door 서비스와 함께 제공되는 규칙 엔진은 규칙을 정의하고 들어오는 HTTP 및 HTTPS 요청이 에지에서 처리되는 방식을 제어하는 기능을 제공합니다. 이 기능을 사용하면 다음과 같은 다양한 요구 사항을 해결할 수 있습니다.
    - 모든 최종 사용자 트래픽이 보안 연결을 통해서만 발생하도록 HTTP-HTTPS 리디렉션을 시행합니다.
    - 크로스 오리진 리소스 공유(CORS) 시나리오의 HTTP Strict-Transport-Security(HSTS), X-XSS-Protection, Content-Security-Policy, X-Frame-Options 및 Access-Control-Allow-Origin 헤더의 브라우저 기반 취약성을 방지합니다. 또한 쿠키를 사용하여 보안 기반 특성을 정의할 수 있습니다.
    - 요청 헤더 콘텐츠, 쿠키 또는 쿼리 문자열의 패턴을 기반으로 애플리케이션의 모바일 또는 데스크톱 버전으로 요청을 라우팅합니다.
    - 리디렉션 기능을 사용하여 301, 302, 307 및 308 리디렉션을 클라이언트에 반환하여 새 호스트 이름, 경로 또는 프로토콜로 연결합니다.
    - 들어오는 요청에 따라 경로의 캐싱 구성을 동적으로 수정합니다.
    - 요청 URL 경로를 다시 작성하고 구성된 백엔드 풀의 적절한 백엔드로 요청을 전달합니다.

캐싱
- Front Door 서비스에는 CDN에서 제공하는 것과 유사한 캐싱 기능이 있습니다. 단, Front Door 서비스는 동적 사이트 가속 및 부하 분산 기능도 제공합니다. 캐싱 기능은 서비스에 대한 높은 수요나 DDoS 공격으로 생성된 트래픽 등으로 인해 백엔드의 로드를 줄이는 데 도움이 됩니다. 이러한 경우 캐싱을 통해 Front Door 서비스 에지 노드는 공격을 방지하거나 요청이 백 엔드 노드에 도달하는 것을 방지하기 위해 클라이언트 요청에 응답합니다.
- **대용량 파일 청크 지원**: Front Door 서비스는 백 엔드에서 수집하는 동안 대용량 파일을 더 작은(8MB) 청크로 분할하여 캐시하고 전달할 수 있습니다. 한 청크가 캐시되어 사용자에게 전달되면 Front Door 서비스는 즉시 다음 청크 검색을 시작합니다. 그래야 이전 청크의 전달이 완료되면 전달이 가능해집니다. 이는 전체 파일이 전달되거나 클라이언트 연결이 종료될 때까지 계속됩니다.
    - 백엔드는 대용량 파일 청크가 작동하려면 바이트 범위 요청을 지원해야 합니다.
- **동적 콘텐츠 압축**: Front Door 서비스는 파일 크기를 줄이기 위해 에지 노드에서 동적 콘텐츠 압축을 지원합니다. 결과적으로 최종 고객에게 더 빠르게 전달할 수 있습니다. 압축이 작동하려면 콘텐츠가 지원되는 특정 MIME 유형이어야 하며, 현재 지원되는 파일 크기는 1KB에서 8MB 사이입니다. 압축은 Brotli 또는 gzip 기반 압축 방법을 사용하여 수행되며, 둘 다 지원되는 경우 Brotli가 gzip보다 선호됩니다.
- **쿼리 문자열 동작(behavior)**: Front Door 서비스는 웹 요청에 포함된 쿼리 문자열을 기반으로 캐싱 동작을 관리할 수 있습니다. 쿼리 문자열은 요청 문자열에서 물음표(`?`) 뒤에 오는 웹 요청 섹션입니다. 관리 옵션은 다음과 같습니다.
    - **쿼리 문자열 무시**: 이렇게 하면 Front Door 서비스가 초기 요청의 쿼리 문자열을 백 엔드에 전달하고 검색된 콘텐츠를 캐시합니다. 후속 요청에서는 쿼리 문자열이 무시되고 캐시된 콘텐츠가 해당 콘텐츠가 만료될 때까지 요청자에게 반환됩니다.
    - **모든 고유 URL을 캐시**: 이 경우 Front Door 서비스는 쿼리 문자열을 포함하여 모든 고유 URL과 연결된 콘텐츠를 캐시합니다. 모든 콘텐츠는 캐시에 보관되며 요청 시 만료될 때까지 반환됩니다.
- **캐시 제거(Purge)**: Front Door 서비스 에지 노드에 캐시된 모든 파일에는 연결된 TTL(Time-To-Live) 값이 있습니다. 이 값은 파일이 만료된 후 Front Door 서비스가 캐시에서 해당 파일을 제거하는 시기를 나타냅니다. Front Door 서비스가 해당 파일 또는 콘텐츠에 대한 후속 요청을 받으면 백 엔드에서 다시 검색하여 새 TTL 값으로 캐시합니다. 제공되는 콘텐츠와 필요한 새로 고침 빈도에 따라 파일 또는 콘텐츠를 버전 번호 및 새 URL로 게시하여 다음 요청 시 업데이트를 강제할 수 있습니다. 필요한 경우 캐시된 콘텐츠를 모두 제거할 수도 있습니다.
- **캐시 만료(Expiration)**: 요청에 대한 응답 헤더를 사용하여 캐시된 파일의 만료 기간을 설정할 수 있습니다. 특히, Cache-Control 응답 헤더를 설정하여 콘텐츠가 캐시에 저장되어야 하는 기간을 나타낼 수 있습니다. 이 헤더가 누락되면 콘텐츠가 1~3일 사이에 무작위로 캐시됩니다.
- **요청(Request) 헤더**: 캐싱이 활성화되면 백엔드 노드로 전달되지 않는 두 개의 요청 헤더(Content-Length 및 Transfer-Encoding)가 있습니다.
- **캐시 기간(Duration)**: 콘텐츠가 캐시에 보관되는 최소 시간입니다. 이는 Front Door Designer 또는 규칙 엔진을 사용하여 설정할 수 있습니다. Front Door Designer를 사용하여 캐시 기간을 설정하는 경우 최소 캐시 기간은 전역 수준에서 정의됩니다. 캐시 제어 헤더에 더 높은 캐시 기간이 포함되어 있지 않으면 이것이 최소 TTL 값이 됩니다. 그러나 규칙 엔진을 사용하여 캐시 기간을 설정하면 캐시 제어 헤더의 값보다 높거나 낮더라도 실제 캐시 값으로 허용됩니다.

##Azure DDoS 보호 기본
- Front Door 서비스는 기본적으로 Azure DDoS Protection Basic과 통합되어 있습니다. 즉, 서비스는 트래픽 볼륨이 높은 공용 엔드포인트에 대한 계층 3 및 계층 4 공격과 같이 일반적으로 발생하는 DDoS 공격으로부터 자동으로 보호됩니다. 쿼리 수. Microsoft는 Azure Front Door를 사용하여 Office365, Dynamics365 등과 같은 여러 공개 소비자 서비스를 보호함으로써 이러한 공격에 대해 이 서비스의 강점을 입증합니다.
- Azure DDoS Protection Basic은 모든 Front Door 서비스 사용자에게 무료로 제공됩니다.

원치 않는 프로토콜로부터 보호
- Front Door 서비스는 알려진 호스트 헤더가 있는 요청에 대해 HTTP 및 HTTPS에서만 트래픽을 허용합니다. 이는 DNS 증폭 공격, TCP 포이즈닝 공격, 대량 공격 등 알려진 여러 DDoS 공격 유형을 방지하는 데 도움이 됩니다. 이는 Front Door 서비스의 기본 제공 기능이므로 이 보안 수준을 달성하기 위해 추가 구성이 필요하지 않습니다.

대용량 트래픽 처리
- Microsoft는 전 세계 수백만 클라이언트의 트래픽을 처리하는 소비자 대상 클라우드 서비스에 Front Door 서비스를 사용합니다. Front Door 서비스에 내장된 글로벌 크기 조정, 캐싱 및 보안 기능은 문제 없이 대량의 트래픽과 공격을 처리하는 데 도움이 됩니다.

WAF 보안 기능
- Front Door 서비스에는 Azure WAF 서비스와 겹치는 다양한 보안 기능이 있습니다.
- 지역 필터링(Geo-filtering)을 사용하여 소스 지역을 기반으로 트래픽을 필터링하거나 리디렉션할 수 있습니다. 이는 원치 않는 로케일에서 애플리케이션으로의 트래픽을 제한하는 데 도움이 됩니다.
- 알려진 악성 공용 IP 주소 및 IP 범위가 연결되지 않도록 방지할 수 있습니다.
- 일반적이고 알려진 공격 벡터로부터 보호하기 위해 규칙 세트를 정의할 수 있습니다.
- 각 IP 주소에서 허용되는 연결 수에 속도 제한을 적용하여 DDoS 공격을 방지할 수 있습니다.

##모범 사례
- **Azure Monitor를 사용하여 모니터링 및 경고**: Azure Front Door 서비스를 Azure Monitor와 통합하여 주요 Front Door 메트릭을 모니터링할 수 있습니다. 여기에는 다음과 같은 Front Door 성능 카운터가 포함됩니다.
    - RequestCount(요청수)
    - RequestSize(요청 크기)
    - ResponseSize(응답 크기)
    - TotalLatency(총 지연 시간)
    - BackendRequestCount(백엔드 요청 수)
    - BackendRequestLatency(백엔드 요청 지연 시간)
    - BackendHealthPercentage(백엔드 상태백분율)
    - WebApplicationFirewallRequestCount(웹애플리케이션방화벽요청수)
- **활동 및 진단 로그 사용**: 활동 로그를 사용하여 Front Door 서비스에서 수행되는 모든 관리 작업을 식별하고 모니터링하고 경고할 수 있습니다. 진단 로그를 사용하여 Front Door 서비스에서 수행하는 작업을 모니터링, 분석 및 경고할 수 있습니다.
- **해당하는 경우 지역 필터링(geo-filtering)을 사용**: 지역 필터링을 사용하면 지정된 지역의 트래픽만 허용하거나 원치 않는 지역의 트래픽을 차단할 수 있습니다. 해당하는 경우 애플리케이션의 공격 표면을 제한하기 위해 해당 위치와 사용할 것으로 예상되는 국가를 기반으로 클라이언트 환경에 지역 필터링을 사용합니다.
- **가상 네트워크 서비스 태그**: 사용 가상 네트워크 서비스 태그는 백 엔드 리소스에 적용되는 NSG(네트워크 보안 그룹)에 대한 네트워크 액세스 제어를 정의합니다. 보안 규칙에서 특정 IP 주소를 사용하는 것보다 이러한 서비스 태그를 사용, 관리, 유지하는 것이 더 쉽습니다.
- **관리 액세스 제한**: Azure RBAC(역할 기반 액세스 제어)를 사용하여 필요한 관리 계정으로만 Front Door 서비스에 대한 액세스를 제한할 수 있습니다. 필요에 따라 이 액세스를 제한하고 정기적으로 검토하여 원치 않는 액세스를 가능한 한 빨리 방지하도록 하십시오.
- **전송 중 중요한 정보 암호화**: Front Door 서비스는 서비스와 백엔드 간의 통신을 위해 TLS 및 HTTPS 프로토콜을 지원합니다. 해당 환경에서 트래픽 스누핑 위험을 제한하려면 가능한 경우 암호화를 사용하십시오.
- **Azure Policy를 사용하여 Azure 서비스 사용량 제한**: Azure 정책은 환경에서 Azure 서비스 사용량을 감사하고 제한하는 데 도움이 됩니다. Azure Policy를 사용하여 필수 관리자에게만 Front Door 서비스 배포를 제한합니다. Azure Monitor를 사용하여 편차가 감지되면 경고를 트리거할 수 있습니다.
- **네트워크 트래픽 로깅 사용**: 네트워크 흐름 로그를 설정하여 Front Door 서비스를 통과하는 네트워크 트래픽을 모니터링할 수 있습니다. 조직의 장기 보존 및 감사 요구 사항에 따라 Azure Storage 계정에 이러한 로그를 보존할 수 있습니다.
- **Front Door를 통해서만 백 엔드에 대한 액세스 제한**: Front Door 서비스의 트래픽만 허용하도록 백 엔드 리소스를 설정하여 이러한 서비스에 대한 공격 표면을 제한할 수 있습니다. Front Door 서비스에서 발생하는 트래픽을 식별하기 위해 들어오는 트래픽의 X-Azure-FDID 헤더 값을 모니터링하도록 백 엔드 서비스에 규칙을 설정할 수도 있습니다.
- **HTTPS를 전달 프로토콜로 사용**: Front Door 서비스와 백엔드 간의 연결은 공용 IP를 통해 발생합니다. 따라서 트래픽을 백 엔드로 전달하는 데에만 HTTPS를 사용하도록 Front Door 서비스를 구성하는 것이 좋습니다. 이렇게 하면 트래픽이 가로채는 경우 악의적인 활동이 제한됩니다.
