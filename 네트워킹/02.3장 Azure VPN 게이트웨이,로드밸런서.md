#제 3장 Azure VPN 게이트웨이

##개요
- VPN(가상 사설망) 게이트웨이는 보안 통신을 위해 인터넷을 통해 다양한 네트워크를 연결하는 데 사용할 수 있는 장치입니다. 여기에는 vNET(Azure 가상 네트워크)에 연결된 온-프레미스 네트워크 또는 다른 Azure vNET에 연결된 하나의 Azure vNET이 포함될 수 있습니다. IPSec/IKEv2는 네트워크 간 트래픽을 암호화하는 데 사용됩니다. Azure에서는 VPN 게이트웨이를 만드는 서비스를 가상 네트워크 게이트웨이 서비스라고 합니다.

##Azure VPN 게이트웨이 기능
- **관리형 게이트웨이**: VPN 게이트웨이가 Azure vNET에 배포되면 Azure 서비스는 게이트웨이 서브넷이라는 연결된 서브넷에 두 개 이상의 VM을 프로비전합니다. 이러한 VM은 게이트웨이 라우팅 서비스, VPN 터널 구성을 기반으로 하는 경로 테이블, 게이트웨이가 프로비전되는 Azure vNET으로 설정됩니다. Azure 서비스 자체는 이러한 VM을 설정하고 관리합니다. 사용자가 직접 수정하거나 관리할 수 없습니다.
- **고가용성**: 각 Azure vNET은 VPN 게이트웨이 하나만 사용하도록 지원합니다. 고가용성을 위해 게이트웨이를 활성-활성 아키텍처로 설정하고 동시에 여러 원격 게이트웨이에 연결할 수 있습니다. VPN 게이트웨이에서 사용할 수 있는 총 대역폭은 해당 SKU에 따라 다르며 모든 활성 연결에서 공유됩니다.
- **ExpressRoute 게이트웨이와의 공존**: Azure는 VPN 게이트웨이와 ExpressRoute 게이트웨이라는 두 가지 유형의 게이트웨이를 지원합니다. ExpressRoute 게이트웨이를 사용하면 프라이빗 연결을 통해 온-프레미스 네트워크에 안전하게 연결할 수 있습니다. 반면에 VPN 게이트웨이는 공용 인터넷을 사용하여 네트워크를 연결합니다. VPN 게이트웨이를 사용하여 두 사이트 간에 IPsec/IKE VPN 터널을 설정하면 Azure는 VPN 구성에 정의된 서브넷을 기반으로 경로 테이블에 경로를 생성하거나 연결이 설정될 때 자동으로 전파됩니다.
    - vNET에는 VPN 게이트웨이 하나와 ExpressRoute 게이트웨이 하나가 동시에 있을 수 있습니다.
- **지점 및 사이트 간 VPN 연결을 사용한 원격 작업 시나리오 지원**: S2S(사이트 간) VPN 연결 외에도 VPN 게이트웨이를 사용하면 P2S(지점 및 사이트 간) VPN 연결을 생성할 수 있습니다. OpenVPN, IKEv2 또는 SSTP. 이를 통해 홈 또는 원격 네트워크를 통해 직접 vNET에 연결하여 개인 내부 IP를 사용하여 리소스에 액세스할 수 있습니다.
- **가용성 영역 지원**: Azure VPN 게이트웨이는 가용성 영역에서의 배포를 지원하여 가용성 영역과 관련된 확장성, 복원력 및 중복성 기능을 VPN 게이트웨이에 제공합니다. VPN 게이트웨이가 가용성 영역에 배포되면 지역 내에서 물리적, 논리적으로 분리되어 영역 오류로부터 서비스를 보호합니다.
- **Azure PowerShell, Azure CLI 및 ARM 템플릿 지원**: Azure Portal을 사용하여 VPN 게이트웨이를 관리하는 것 외에도 Azure PowerShell, Azure CLI 및 ARM 템플릿을 사용할 수 있습니다.
    - Azure VPN 게이트웨이 서비스는 Azure Blob Storage를 사용하여 시스템 메타데이터를 자동으로 복제하고 미사용 암호화 기능을 사용하여 안전하게 저장합니다.

##설계 개념 및 배포 고려 사항
- VPN 게이트웨이를 설정하기 전에 연결에 대한 모든 요구 사항을 확인하는 것이 중요합니다. 여기에는 범위 내 최종 클라이언트, 필요한 처리량, 지원되는 프로토콜, 사용 가능한 온프레미스 방화벽 또는 VPN 장치, 필요한 지원, 복원력, 중복성 및 인증 메커니즘이 포함됩니다.
- 이러한 요구 사항을 확인한 후에는 다음 표를 사용하여 VPN 연결 유형(P2S 또는 S2S), 게이트웨이 SKU, 배포 모델, 프로토콜 등을 포함하여 최상의 솔루션이 무엇인지 식별할 수 있습니다.

||Point-to-Site|Site-to-Site|
|-|-|-|
|Azure 지원 서비스|클라우드 서비스 및 VM|클라우드 서비스 및 VM|
|일반적인 대역폭|게이트웨이 SKU 기반|일반적으로 < 1Gbps 집계|
|지원되는 프로토콜|SSTP(Secure Sockets Tunneling Protocol), <br>OpenVPN 및 IPsec(인터넷 프로토콜 보안)|IPsec|
|라우팅|경로 기반(동적 라우팅)|정책 기반(정적 라우팅) 및 경로 기반(동적 라우팅)|
|연결 복원력|액티브-패시브|액티브-패시브 및 액티브-액티브|
|일반적인 사용 사례|원격 사용자를 위한 Azure vNET에 대한 보안 액세스|클라우드 서비스 및 VM을 위한 개발, 테스트, <br>랩(lab) 시나리오와 중소 규모 프로덕션 워크로드|

VPN 유형
- Azure는 경로 기반과 정책 기반이라는 두 가지 유형의 VPN을 지원합니다. 선택하는 VPN 유형은 VPN 연결 요구 사항에 따라 달라집니다. P2S 연결은 경로 기반 VPN만 지원하는 반면, S2S 연결은 경로 기반 VPN과 정책 기반 VPN을 모두 지원합니다.
- 정책 기반 VPN은 VPN 터널을 하나만 지원하고 기본 SKU를 사용해야 하므로 사용 사례가 적습니다. 이와 대조적으로 경로 기반 VPN은 P2S 및 S2S 연결을 동시에 지원하지만 사용 가능한 다른 기능과 터널은 게이트웨이 SKU에 따라 다릅니다.
- 이러한 VPN 유형 간에 한 가지 더 중요한 차이점이 있습니다. 정책 기반 VPN에서는 정적 라우팅이 액세스 목록을 사용하여 정의되는 반면, 경로 기반 VPN에서는 연결이 설정(established)(또는 종료)되면 경로가 경로 테이블에서 동적으로 추가(또는 제거)됩니다.

게이트웨이 SKU
- VPN 게이트웨이에 사용할 수 있는 다양한 SKU가 있습니다. 귀하가 선택하는 것은 조직의 처리량, 기능 및 SLA 요구 사항을 기반으로 합니다.
- 테스트 및 개발 워크로드에는 기본 SKU가 권장됩니다. VPNGw1로 시작하는 다른 SKU는 프로덕션 환경에 권장됩니다. 어떤 SKU를 선택하느냐는 필요한 기능 세트에 따라 달라집니다. 예를 들어 VpnGw1AZ SKU는 가용성 영역을 지원하지만 VpnGw2 SKU는 지원하지 않습니다. 그러나 VpnGw2 SKU는 더 높은 처리량을 허용합니다(650Mbps에 비해 1Gbps).
- 동일한 세대의 SKU 간에 전환할 수 있습니다. 예를 들어 VpnGw1 게이트웨이에서 VpnGw2 게이트웨이로 전환할 수 있습니다. 그러나 VpnGw1 게이트웨이에서 VpnGw2AZ 게이트웨이로 전환할 수는 없습니다.
- 레거시 기본 게이트웨이를 VPNGw1 게이트웨이로 업그레이드할 수 있지만 기본 게이트웨이를 삭제한 다음 새 VPNGw SKU 게이트웨이를 만들어야 합니다.

연결 유형
- VPN 게이트웨이 장치는 다음과 같은 네 가지 연결 유형을 지원합니다.
- **IPsec**: 이를 사용하여 온프레미스 게이트웨이 장치와의 S2S 연결을 설정합니다.
- **Vnet2Vnet**: VPN 게이트웨이를 사용하여 두 개의 Azure vNET을 상호 연결하는 데 사용합니다.
- **ExpressRoute**: 보안 개인 네트워크와 Azure 간의 연결을 설정하기 위해 게이트웨이 유형이 ExpressRoute로 설정된 경우 이를 사용합니다.
- **VPNClient**: 이를 사용하여 클라이언트 장치와 VPN 게이트웨이 장치 간에 P2S 연결을 설정합니다.

게이트웨이 서브넷
- VPN 게이트웨이를 프로비저닝하기 전에 게이트웨이 서브넷이라는 특수 서브넷을 생성하여 호스팅해야 합니다. 게이트웨이 서브넷은 Azure vNET 주소 공간의 일부로 설정됩니다. /29만큼 작은 서브넷일 수 있지만 중복성을 처리하기 위해 추가 VM을 배포해야 하는 활성-활성 구성 시나리오를 처리하려면 일반적으로 /26 또는 /27로 크기를 조정하는 것이 좋습니다.

BGP(경계 게이트웨이 프로토콜)
- BGP(Border Gateway Protocol)는 BGP 피어 또는 이웃이라고 하는 연결된 네트워크 간의 경로 교환을 지원하는 표준 라우팅 프로토콜입니다. 이를 위해서는 BGP를 지원하기 위해 연결의 양쪽 끝이 필요합니다. Azure VPN 게이트웨이와의 사용은 선택 사항입니다.
- **동적 라우팅**: BGP를 사용하면 Azure VPN 게이트웨이가 동적 라우팅을 지원할 수 있습니다. 그런 다음 네트워크 변경이나 중단으로 인해 라우팅 경로가 수정되는 경우 연결의 한쪽 끝을 업데이트하기 위해 경로 교환이 발생할 수 있습니다.
- **네트워크 액세스 BGP를 더 잘 제어**: 온프레미스 또는 애저 네트워크의 전체 IP 주소 접두사에 대한 액세스를 여는 대신 액세스할 IP 주소 접두사만 선언할 수 있습니다. 이를 통해 두 사이트 간의 트래픽을 더 잘 제어할 수 있습니다.
- **다중 활성 터널 지원**: 온프레미스 네트워크에서 BGP를 설정한 후 온프레미스 네트워크 또는 애저 네트워크에 대한 다중 활성 또는 활성 대기 연결을 설정하여 두 환경 모두에서 중복성과 복원력을 높일 수 있습니다. 트래픽은 양쪽 끝에 있는 활성 터널을 통해 자동으로 라우팅됩니다.
- **전송(Transit) 라우팅 지원**: 네트워크가 직접적으로 또는 간접적으로 서로 연결되어 있는지 여부에 관계없이 BGP를 사용하면 게이트웨이가 IP 주소 접두사를 자동으로 학습하여 모든 네트워크에 전파할 수 있습니다. 이를 통해 Azure VPN과 온-프레미스 네트워크 및 기타 상호 연결된 네트워크 간의 전송 라우팅을 설정할 수 있습니다.

로컬 네트워크 게이트웨이
- 로컬 네트워크 게이트웨이는 온-프레미스 게이트웨이 디바이스 및 해당 네트워크를 나타내는 Azure에 설정된 게이트웨이입니다. 이는 VPN 터널을 설정할 때 게이트웨이 구성에서 참조됩니다. 일반적으로 온프레미스 VPN 게이트웨이의 공용 IP 주소, 연결에 사용할 공유 비밀, 온프레미스 네트워크에서 허용할 IP 주소 접두사만 정의하면 됩니다.
- 그러나 BGP를 사용하는 경우에는 추가 구성이 필요합니다. 특히 BGP 피어 IP 주소와 ASN(자치 시스템 번호)을 정의해야 합니다. 그러나 온프레미스 네트워크에 있는 IP 주소 접두사를 정의할 필요는 없습니다. BGP를 사용하면 이러한 IP 범위를 Azure의 경로 테이블에 자동으로 추가할 수 있습니다.

VPN 게이트웨이 중복성
- active-active 구성 없이 Azure VPN 게이트웨이를 배포하는 경우에도 서비스는 활성 인스턴스의 기능을 방해할 수 있는 계획되거나 계획되지 않은 이벤트를 용이하게 하기 위해 활성-대기 구성으로 두 개의 VPN 인스턴스를 배포합니다.
- 대기 인스턴스로의 전환은 자동으로 이루어지지만 모든 S2S VPN 터널이 다시 설정되므로 서비스가 잠시 중단됩니다. 계획된 유지 관리 시나리오에서는 최대 15초가 걸릴 수 있지만 중단이 계획되지 않은 경우에는 더 길어질 수 있습니다. 이 시나리오에서는 VPN 서비스를 다시 온라인으로 전환하는 데 최대 3분이 걸릴 수 있습니다.
- 이러한 이벤트가 발생하면 활성 P2S 연결이 끊어지며 자동으로 다시 설정되지 않습니다. 오히려 최종 클라이언트가 연결 재설정을 시작해야 합니다.

###배포 모델
사이트 간(Site-to-site) VPN 게이트웨이 연결
- 온-프레미스 게이트웨이 장치를 Azure VPN 게이트웨이 장치에 연결하려면 IPsec/IKE를 통해 사이트 간(S2S) VPN 게이트웨이 연결을 설정합니다. 온-프레미스 게이트웨이 장치와 Azure 게이트웨이 장치는 모두 공용 IP 주소와 연결되어야 합니다. 중복성 요구 사항 및 비용 제한에 따라 active-standby 모드 또는 active-active 모드로 Azure VPN 게이트웨이를 구성할 수 있습니다.

단일 사이트(Single-site) active-standby 모드
- active-standby 구성에서는 두 터널 모두 온라인으로 구성되지만 하나의 터널만 활성화됩니다. 다른 하나는 대기 모드에 있습니다. 활성 터널이 다운되면 대기 터널이 활성화되어 트래픽을 라우팅하는 데 사용됩니다.

<img src="https://drive.google.com/uc?id=1tzaQc1L2takiq1Lhc6n-r7CyunqfazAT">

다중 사이트 active-active 모드
- S2S VPN 게이트웨이 연결의 변형은 Azure의 단일 활성 VPN 게이트웨이가 서로 다른 사이트의 여러 온-프레미스 장치에 연결되는 다중 사이트 VPN 연결입니다. 이를 위해서는 경로 기반 VPN 유형을 사용해야 하므로 기본 VPN 게이트웨이 SKU에서는 작동하지 않습니다. SKU를 기반으로 하는 게이트웨이 장치에 사용할 수 있는 전체 처리량은 설정된 모든 연결에서 공유됩니다.

<img src="https://drive.google.com/uc?id=1JZb6xO3XC8z4t68zXesdtC3DZfVbxval">

Active-standby 모드의 고가용성(HA)
- 이 시나리오에서 Azure VPN 게이트웨이는 동일한 온-프레미스 위치에 있는 두 개의 VPN 장치에 동시에 연결됩니다. 동일한 경로가 두 연결을 통해 전파되고 트래픽은 온프레미스 네트워크에 대한 처리량을 높이기 위해 두 연결을 모두 사용하여 온프레미스 네트워크로 라우팅됩니다. (두 온-프레미스 장치 모두 BGP 사용을 지원해야 합니다.) Azure 끝의 처리량은 선택한 게이트웨이 SKU에 따라 제한됩니다.

<img src="https://drive.google.com/uc?id=16jz3j3HJyP_2dH6bHs__PtECemC7OhiC">

Active-active 모드
- 활성-활성 모드를 설정하려면 Azure VPN 게이트웨이를 활성-활성 모드로 설정합니다. 이로 인해 각 온-프레미스 위치에서 Azure VPN 게이트웨이에 대한 여러 활성 연결이 발생하고 트래픽은 모든 연결을 통해 라우팅됩니다. (그림 3-4 참조) 터널이 오프라인 상태가 되면 트래픽은 자동으로 아직 활성 상태인 터널로 전환됩니다. 비활성 터널과 관련된 경로가 자동으로 전환되고 제거되도록 Azure 끝과 온-프레미스 끝 모두에서 설정해야 합니다. (경로 전파를 위해 Azure 게이트웨이와 온-프레미스 게이트웨이 모두에 BGP가 필요합니다.) 이 모드는 Azure 끝의 중복성과 복원성을 높이고 Azure에서 계획되거나 계획되지 않은 유지 관리 활동 중에 서비스가 중단되지 않도록 보장합니다.

<img src="https://drive.google.com/uc?id=1ztGz2e5Gj9IpOIVimREnl6dsAivKENCD">

Active-active 모드의 HA
- 이 "풀 메시" 모드를 사용하면 두 개의 Azure 게이트웨이가 두 개의 온-프레미스 게이트웨이에 연결됩니다. 양쪽 끝에 있는 장치에 오류가 발생하면 여전히 활성 상태인 장치를 통해 트래픽이 자동으로 라우팅됩니다. (경로 전파에는 BGP가 필요합니다.) 그림 에 표시된 시나리오에서는 4개의 S2S 터널이 사용됩니다. 게이트웨이 SKU 및 각각과 관련된 제한을 선택할 때 이 점을 고려하는 것이 중요합니다.

<img src="https://drive.google.com/uc?id=1qyGpwBe-VkEQ8dBvtKsRV6bLiSAhGDq_">

지점 및 사이트 간(Point-to-site) VPN 게이트웨이 연결
- P2S VPN 게이트웨이 연결은 조직이 직원이 Azure 또는 상호 연결된 온-프레미스 네트워크에 호스팅된 내부 리소스에 안전하게 연결하고 액세스할 수 있어야 하는 재택 근무 또는 원격 근무 시나리오를 해결하는 데 도움이 됩니다. P2S 연결을 사용하면 장치를 공용 IP를 통해 직접 연결할 필요가 없습니다. 클라이언트 장치에는 활성 인터넷 연결과 SSL을 통해 Azure 끝점에 연결하는 기능이 필요합니다.
- 지원되는 프로토콜
    - OpenVPN 프로토콜 OpenVPN 프로토콜은 포트 443(대부분의 방화벽은 열려 있음)만 필요하므로 대부분의 방화벽에서 작동하는 SSL/TLS 기반 VPN 프로토콜입니다. OpenVPN 프로토콜을 사용하여 Android, iOS(버전 11.0 이상), Windows, Linux 및 Mac 장치(macOS 버전 10.13 이상)에서 연결할 수 있습니다.
    - SSTP(Secure Socket Tunneling Protocol) SSTP는 독점 TLS 기반 VPN 프로토콜입니다. OpenVPN 프로토콜과 마찬가지로 SSTP는 포트 443만 필요하므로 대부분의 방화벽에서 작동합니다. 차이점: Windows 장치만 SSTP를 사용합니다. Azure는 SSTP가 있고 TLS 1.2(Windows 8.1 이상)를 지원하는 모든 버전의 Windows를 지원합니다.
    - IKEv2 VPN IKEv2 VPN은 Windows, Android, iOS 및 Mac 장치(macOS 버전 10.11 이상)에서 연결하는 데 사용할 수 있는 표준 기반 IPsec VPN 프로토콜입니다.

Authentication
- P2S VPN 게이트웨이 연결은 세 가지 유형의 인증 메커니즘을 지원합니다.
    - **원격 인증 다이얼 인 사용자 서비스 (RADIUS) 인증**: 이를 위해서는 RADIUS 서버와의 통합이 필요합니다.
    - **기본 Azure 인증서 인증**: 여기에는 연결 요청의 일부로 사용하기 위해 Azure 장치 및 다양한 최종 클라이언트에 배포되는 엔터프라이즈 인증서 또는 자체 서명 인증서 생성이 포함됩니다.
    - **기본 Azure AD 인증**: 이를 위해서는 OpenVPN 프로토콜, Windows 10 및 Windows 11 기반 클라이언트, Azure VPN 클라이언트를 사용해야 합니다.

<img src="https://drive.google.com/uc?id=1-BHaEGCRYVK1UwlD9jTWBbM8IS9ORfvc">

vNET-vNET 연결(IPSec/IKE VPN 터널)
- 양쪽 끝에 있는 VPN 게이트웨이를 사용하여 두 개의 Azure vNET을 연결하면 vNET과 vNET이 연결됩니다. 이는 온프레미스 네트워크 게이트웨이 장치에 Azure VPN 게이트웨이를 연결하는 것과 유사하지만 동일하거나 다른 지역, 동일하거나 다른 구독, 동일하거나 다른 배포 모델(클래식 및 ARM)에 있는 Azure vNET을 연결할 수 있습니다.

<img src="https://drive.google.com/uc?id=1qHPzJQiA6gryfo-JRkLwIxY7skeeJdh6">

고가용성 vNET-vNET
- 활성-활성 모드의 전체 메시 S2S HA와 유사하게 vNET-vNET 설계는 두 vNET 간의 활성-활성 게이트웨이를 지원합니다. 이를 통해 2개의 vNET에 연결된 2개의 VPN 게이트웨이 사이에 4개의 터널을 설정하여 더 높은 가용성과 복원력을 제공할 수 있습니다. (전송 라우팅이 필요하지 않은 한 이 설정에서는 BGP가 선택 사항입니다.)

<img src="https://drive.google.com/uc?id=1DFaX-kW7SKg8pGQEF1P62trK63yK7fGo">

ExpressRoute
- ExpressRoute를 사용하면 연결 공급자의 도움을 받아 개인 연결을 통해 Microsoft 클라우드로 직접 온-프레미스 네트워크를 확장할 수 있습니다.
- Microsoft 클라우드 서비스에 대한 연결은 Microsoft Azure에만 국한되지 않습니다. Microsoft 365 및 Dynamics 365와 같은 다른 Microsoft 서비스에 대한 연결도 허용됩니다.
- ExpressRoute를 사용하면 모든 연결이 가장 엄격한 SLA가 적용되는 개인 네트워크를 통해 이루어집니다. 이를 통해 ExpressRoute 연결은 S2S VPN 연결보다 더 안전하고 안정적입니다. 또한 ExpressRoute는 더 높은 처리량과 더 낮은 대기 시간을 제공하므로 대규모 조직과 보안 및 규정 준수 요구 사항에 따라 사용해야 하는 조직에 이상적입니다.
- ExpressRoute 및 사이트 간 VPN 게이트웨이는 동일한 Azure vNET에 공존할 수 있으며 활성 장애 조치(failover) 설계로 구현될 수 있습니다. 즉, ExpressRoute 문제로 인해 S2S VPN에 대한 자동 장애 복구가 발생합니다. 다른 옵션은 ExpressRoute 연결이 적용되지 않는 사이트에 S2S VPN을 활용하는 것입니다. 비즈니스에 안정성과 중복성이 중요한 대규모 환경을 설계할 때 이를 고려할 수 있도록 이러한 호환성을 알고 있는 것이 중요합니다.

영역 및 영역 중복(Zonal and zone-redundant) VPN 게이트웨이
- Azure VPN 게이트웨이 장치는 Azure 가용성 영역에서의 배포를 지원합니다. 이는 가용성 영역의 모든 중복성, 확장성 및 가용성 기능을 vNET 게이트웨이 장치로 확장합니다. 게이트웨이 장치가 Azure 가용성 영역에 배포되면 영역 수준 오류로부터 보호하기 위해 Azure 지역 내에서 물리적 및 논리적으로 분리됩니다.
- 가용성 영역에는 두 가지 옵션이 있습니다.
    - **영역(Zonal) 게이트웨이**: VPN 게이트웨이가 가용성 영역에 배포되고 가용성 영역 구성이 지정되면 게이트웨이의 모든 인스턴스가 동일한 가용성 영역에 배포됩니다. 이를 영역 게이트웨이라고 합니다.
    - **영역 중복(Zone-redundant) 게이트웨이**: 가용성 영역 구성이 자동으로 설정된 경우 VPN 게이트웨이가 가용성 영역 전체에 배포되어 더 높은 복원력을 제공하기 위해 영역 중복이 됩니다.
- 2개의 VPN 게이트웨이 인스턴스는 지역의 3개 가용성 영역 중 2개에 배포됩니다.

##모범 사례
- **VPN 게이트웨이 라우팅 활동에 대한 로깅 활성화**: VPN 게이트웨이는 고객을 위해 처리하는 모든 네트워크 트래픽을 기록합니다. 그러나 더 나은 가시성과 관리를 위해 NSG 흐름 로깅을 활성화하여 이 트래픽을 캡처하고 모니터링해야 합니다.
- **리소스 로깅 설정**: Azure Security Center 및 Azure Monitor를 사용하여 VPN 게이트웨이에 대한 모든 활동 로그를 캡처하여 필요한 경우 조사를 지원합니다.
- **Azure Policy로 표준화**: Azure Policy는 워크로드 배포 및 유지 관리에 대한 회사 정책 및 표준과 일치하도록 Azure 환경을 표준화하는 데 도움이 됩니다. Azure Policy를 사용하여 VPN 게이트웨이가 해당 표준에 따라 배포되었는지 확인하세요.
- **침투 테스트 수행**: VPN 게이트웨이에 대해 정기적인 침투 테스트 공격을 수행하여 약점이나 가능한 허점을 식별합니다. 이러한 통제된 시뮬레이션은 약점을 사전에 식별 및 해결하고 침해 및 공격으로부터 회사를 보호하는 데 도움이 될 수 있습니다.
- **장기 로그 보존을 위해 Log Analytics와 통합**: Azure VPN 게이트웨이 장치를 Azure Log Analytics 작업 영역과 통합하여 VPN 게이트웨이 로그를 장기간 저장함으로써 네트워크 패턴, 추세 및 계획에 대한 기록 분석을 용이하게 합니다.
- **보안 모니터링을 위해 SIEM과 통합**: Azure VPN 게이트웨이에는 보안을 모니터링하거나 관리하는 기본 제공 기능이 없습니다. 보안 침해 및 위협에 대한 VPN 게이트웨이 트래픽 로그를 모니터링하려면 해당 로그를 Azure Sentinel 또는 타사 공급자와 같은 SIEM(보안 정보 및 이벤트 관리) 솔루션에 전달해야 합니다.

#제4장 Azure 로드 밸런서
- 공용 로드 밸런서 공용 로드 밸런서는 백엔드 서비스나 가상 머신(VM)을 직접 노출하지 않고도 내부 애플리케이션, 웹 서버 또는 서비스를 인터넷 기반 클라이언트에 안전하게 게시하는 데 도움이 됩니다. 클라이언트는 공용 로드 밸런서에 연결하고 로드 밸런서에 정의된 로드 밸런싱 알고리즘을 기반으로 트래픽이 적절한 백엔드 서비스로 라우팅됩니다.
- 내부 로드 밸런서 내부 로드 밸런서는 내부 전용 클라이언트에 내부 애플리케이션, 웹 서버 또는 서비스에 대한 보안 액세스를 제공하는 데 도움이 됩니다. 클라이언트는 Azure의 가상 네트워크(vNET)에 직접 연결하거나 S2S(사이트 간) VPN, P2S(지점 간) VPN 또는 ExpressRoute와 같은 하이브리드 연결 솔루션을 통해 연결할 수 있습니다. 로드 밸런서에 대한 직접적인 공개 액세스는 불가능합니다.

##Azure 로드 밸런서 기능
- **공용 및 내부 부하 분산 옵션 모두 지원**: Azure Load Balancer는 공용 및 내부 전용 부하 분산 옵션을 모두 지원하므로 공개 노출이 필요할 수도 있고 필요하지 않을 수도 있는 다양한 애플리케이션 시나리오를 처리할 수 있습니다.
- **확장성이 뛰어남**: Azure Load Balancer는 확장성이 뛰어납니다. 백엔드 서비스에 대한 연결 요청이 증가하면 서비스가 자동으로 확장됩니다.
- **가용성 영역 지원**: 표준 Azure Load Balancer는 서비스의 복원력과 가용성을 향상시키기 위해 가용성 영역 사용을 지원합니다.
- **기본적으로 보안 액세스**: 표준 Azure Load Balancer는 NSG(네트워크 보안 그룹)를 사용하여 트래픽이 명시적으로 허용되지 않는 한 기본적으로 들어오는 모든 트래픽을 차단하도록 설계되었습니다. 반면 기본 Azure Load Balancer는 기본적으로 공용 네트워크에 개방되어 있으며 들어오는 트래픽을 차단하도록 구성해야 합니다.
- **아웃바운드 트래픽 관리**: Azure Load Balancer를 사용하여 VM의 모든 아웃바운드 트래픽 송신을 관리하고 해당 트래픽을 더 효과적으로 제어할 수 있습니다.
- **여러 로드 밸런싱 알고리즘 지원**: 애플리케이션에 가장 적합한 라우팅 방법을 정의하는 데 사용할 수 있는 여러 로드 밸런싱 알고리즘이 있습니다. 애플리케이션의 요구 사항이 발전함에 따라 하나의 로드 밸런싱 알고리즘에서 다른 알고리즘으로 전환할 수 있습니다.
- **IPv6 지원**: Azure Load Balancer는 IPv6 연결 가용성을 지원합니다. 따라서 클라이언트 연결을 위해 IPv6가 필요한 애플리케이션을 수용하도록 Azure Load Balancer를 설정할 수 있습니다.
- **여러 포트 및 IP 주소 지원**: Azure Load Balancer는 여러 애플리케이션 백엔드에 대한 트래픽 부하를 분산하기 위해 여러 IP 주소 및 포트 사용을 지원합니다.
- **TCP 및 UDP 흐름 지원** Azure Load Balancer는 TCP 및 UDP 트래픽 부하 분산을 모두 지원합니다.

##설계 개념 및 배포 고려 사항
프런트엔드 IP 주소
- Azure Load Balancer는 공용 액세스와 내부 전용 액세스 모두에서 작동합니다. 이러한 시나리오를 지원하기 위해 공용 IP 주소 또는 개인 IP 주소를 사용하여 로드 밸런서를 설정할 수 있습니다. 할당하는 IP 주소는 로드 밸런서가 공용인지 내부 로드 밸런서인지를 결정합니다. 이는 클라이언트가 애플리케이션이나 서비스에 연결하는 수신 지점이기 때문입니다.
- 기본 및 표준 로드 밸런서 모두 공용 또는 개인 IP 주소 사용을 지원합니다. 애플리케이션의 요구 사항에 따라 어느 것이 작동할지 결정합니다.
- 여러 프런트 엔드
    - 부하 분산 장치는 여러 프런트 엔드를 지원할 수 있지만 모두 동일한 유형이어야 합니다. 예를 들어 로드 밸런서가 내부 로드 밸런서로 설정된 경우 이에 할당되는 추가 IP 주소도 내부여야 합니다. 공용 로드 밸런서에도 동일하게 적용됩니다. 들어오는 트래픽은 정의된 부하 분산 규칙에 따라 라우팅됩니다. 즉, 로드 밸런서는 들어오는 트래픽의 소스, 프로토콜, 포트 및 대상 요구 사항을 식별하여 적절한 백엔드를 선택합니다.

백엔드 풀
- 백 엔드 풀은 트래픽을 라우팅하려는 웹 서비스 또는 애플리케이션을 호스팅하는 VMSS(VM 확장 집합)를 나타냅니다. 백엔드 풀에 더 많은 VM 인스턴스를 추가하면 부하 분산 장치는 이를 자동으로 알고리즘에 통합하고 규칙에 정의된 라우팅 논리에 따라 트래픽을 새 인스턴스로 라우팅합니다.
- VMSS의 경우 VMSS가 인스턴스를 동적으로 추가하거나 제거하므로 라우팅 재계산이 자동으로 수행됩니다. VM을 사용하면 백 엔드 풀에서 VM을 추가하거나 제거할 때 재계산이 발생합니다.

상태 프로브
- 상태 프로브는 Azure Load Balancer가 백 엔드 풀에 있는 인스턴스의 상태를 확인하는 데 사용해야 하는 매개 변수를 정의합니다. 프로비전된 부하 분산 장치 유형에 따라 지원되는 상태 프로브 유형은 다음과 같습니다.
    - 표준 로드 밸런서 TCP, HTTP 및 HTTPS
    - 기본 로드 밸런서 TCP 및 HTTP
- 상태 프로브 매개 변수에는 부하 분산 장치가 백엔드 인스턴스가 비정상인 시기를 결정하는 데 도움이 되는 빈도, 예상 응답 및 임계값이 포함됩니다. 이러한 경우 로드 밸런서는 후속 상태 프로브에서 인스턴스가 다시 한 번 정상 상태임을 확인할 때까지 비정상 인스턴스로의 새 트래픽 라우팅을 중지합니다.
- 표준 로드 밸런서를 사용하면 흐름이 끊어지거나 종료되거나 시간 초과될 때까지 이미 존재하는 모든 연결이 비정상 인스턴스로 계속 라우팅됩니다. 그러나 기본 로드 밸런서를 사용하면 인스턴스가 비정상으로 간주되면 연결 상태에 관계없이 TCP 흐름의 연결이 끊어집니다.

부하 분산 규칙
- 부하 분산 규칙은 연결 흐름의 소스 IP, 소스 포트, 대상 IP, 대상 포트 및 IP 프로토콜 세부 정보를 기반으로 수신 트래픽이 관리되는 방식을 지정합니다. 이 규칙은 공용 또는 개인용 프런트 엔드 IP 주소와 포트를 여러 백엔드 IP 주소 및 포트에 연결합니다. 선택된 로드 밸런싱 알고리즘은 이후 트래픽을 백엔드 풀로 라우팅하는 데 사용됩니다. 모든 부하 분산 장치 프런트 엔드 및 백 엔드 끝점은 동일한 Azure vNET에 있어야 합니다. vNET 스패닝은 지원되지 않습니다.
- ICMP는 지원되는 프로토콜이 아닙니다.

고가용성 포트 부하 분산 규칙
- HA 포트 부하 분산 규칙은 포트 번호에 관계없이 모든 포트의 모든 프로토콜에 대한 모든 트래픽이 부하 분산 방식으로 라우팅되어야 함을 Azure 서비스에 지시합니다. 이 규칙은 프로토콜이 all로 설정되고 프런트엔드 및 백엔드 포트가 0으로 설정된 경우 구성됩니다. 이 규칙을 사용하면 다음을 포함하는 5튜플 연결 논리를 기반으로 흐름별로 로드 밸런싱 결정이 내려집니다. 소스 IP 주소, 소스 포트, 대상 IP 주소, 대상 포트 및 프로토콜.

<img src="https://drive.google.com/uc?id=1TZ3yvRQlDUjOdP7wuVHkXD5V_kls9DKY">

인바운드 네트워크 주소 변환(NAT) 규칙
- 프런트 엔드 IP 주소와 포트의 조합을 기반으로 들어오는 트래픽을 특정 백 엔드 VM으로 전달하도록 인바운드 NAT(네트워크 주소 변환) 규칙을 설정할 수 있습니다. 트래픽은 NAT 풀 설정의 일부로 VMSS에 있는 하나 이상의 VM으로 라우팅될 수 있습니다.

<img src="https://drive.google.com/uc?id=1LDvDxGiu6Uwt1KCeiBBgE29MevjhF_qw">

아웃바운드 소스 네트워크 주소 변환(SNAT) 규칙
- 인터넷 바인딩 송신 트래픽은 물론 다른 엔드포인트에 대한 트래픽에 대한 모든 백엔드 VM 또는 VMSS 리소스에 대한 아웃바운드 소스 네트워크 주소 변환(SNAT) 규칙을 사용하여 표준 공용 로드 밸런서를 설정할 수 있습니다. 이는 백엔드 인스턴스 자체와 연결된 IP 주소 정보를 노출하지 않고 로드 밸런서의 퍼블릭 IP를 외부 엔드포인트에 제공하는 데 도움이 됩니다.

<img src="https://drive.google.com/uc?id=1H9nezDPHI94nDUKr-xThY5ZxXkaMgVtJ">

- 공용 IP 접두사를 설정하여 로드 밸런서에 공용 IP 풀을 제공할 수 있습니다. 그런 다음 이를 사용하여 모든 IP 및 포트에서 아웃바운드 연결 수를 확장할 수 있습니다. 또한 백엔드 리소스를 개별 공용 IP 주소에 매핑하거나 풀의 IP 주소를 사용하도록 설정하여 포트 고갈을 방지할 수도 있습니다. 이를 통해 중복성과 확장성이 향상됩니다.
- 기본 부하 분산 장치는 아웃바운드 SNAT 규칙을 지원하지 않습니다. 표준 내부 부하 분산 장치는 인터넷 라우팅에 대한 아웃바운드 SNAT 규칙을 지원하지 않습니다.

부하 분산 알고리즘
- **해시 기반**: 이 알고리즘은 소스 IP, 소스 포트, 대상 IP, 대상 포트 및 프로토콜 유형의 조합을 기반으로 고유한 해시를 생성합니다. 다른 소스 포트를 사용하여 동일한 소스 IP에서 동일한 애플리케이션 백엔드로 연결하면 새로운 해시가 생성되어 매번 다른 백엔드 엔드포인트로 트래픽을 라우팅할 수 있습니다. 이러한 유형의 라우팅은 애플리케이션이 특정 클라이언트에서 시작되는 모든 세션에 대해 고정성을 요구하지 않는 시나리오에서 유용합니다. 또한 적은 수의 소스 클라이언트에서 더 많은 수의 세션이 백엔드 풀에 고르게 분산되므로 응답성을 향상시키는 데 도움이 될 수 있습니다.
- **소스 IP 선호도(Affinity)**: 이 알고리즘을 사용하면 동일한 프로토콜 유형을 사용하여 동일한 소스 IP에서 동일한 대상 IP로의 트래픽이 매번 동일한 엔드포인트로 라우팅됩니다. 이는 이미 활성 클라이언트 세션을 관리하고 있는 백엔드 엔드포인트가 동일한 소스 IP, 대상 IP 및 프로토콜을 사용하여 추가로 들어오는 클라이언트 세션에 응답하도록 보장하는 데 도움이 됩니다. 연결이 라우팅되어야 하는 백엔드 인스턴스를 결정하기 전에 소스 IP 선호도 알고리즘을 설정하여 수신 요청의 소스 IP 및 대상 IP를 확인하거나 소스 IP, 대상 IP 및 프로토콜 유형을 확인할 수 있습니다.
- 소스 IP 선호도 알고리즘에는 다양한 사용 사례가 있습니다. 하나는 Azure Load Balancer를 사용하여 원격 데스크톱 게이트웨이 서버에 대한 들어오는 클라이언트 연결을 처리하는 경우입니다. 또 다른 경우는 클라이언트 애플리케이션이 세션 기간 동안 모든 클라이언트 트래픽을 단일 백엔드 엔드포인트로 전달하도록 요구하는 경우입니다.

가용성 영역
- **영역 중복(Zone redundant)**: Azure Load Balancer가 배포된 Azure 지역이 가용성 영역을 지원하는 경우 프런트 엔드 IP 주소를 영역 중복으로 설정할 수 있습니다. 이렇게 하면 영역 내에 오류가 발생하더라도 IP 주소는 계속 유지되며 새로 들어오는 요청을 백엔드 풀로 라우팅합니다. (물론 이는 유사한 영역 중복 방식으로 설정되고 영역 오류가 발생할 경우 온라인 상태인 리소스가 백 엔드 풀에 있다고 가정합니다.) 영역 중복 Azure Load Balancer를 사용하는 것이 좋습니다. 생산 워크로드를 위한 것입니다.
- **영역(Zonal)**: 영역 중복성을 사용하면 로드 밸런서는 단일 영역 내에서 중복됩니다. 해당 영역에 오류가 발생하면 로드 밸런서는 다른 영역으로 장애 조치를 수행하지 않습니다. 영역이 중단되는 동안 오프라인 상태로 유지됩니다. 애플리케이션을 노출하고 Azure Traffic Manager와 같은 트래픽 관리 서비스를 사용하기 위해 지역 내의 여러 영역에 서로 다른 IP 주소가 설정되는 시나리오에서 영역 중복성을 사용할 수 있습니다. 이 경우 트래픽은 가용성에 따라 모든 영역에 걸쳐 라우팅됩니다. 이를 통해 영역의 각 프런트 엔드에는 고유한 공용 IP가 있으므로 각 영역의 상태와 가용성을 독립적으로 모니터링할 수 있습니다.
- **비영역(Non-zonal)**: 여기서 로드 밸런서는 중복성이 전혀 없는 "영역 없음" 프런트 엔드 구성으로 설정됩니다.
- 기본에서 표준으로 업그레이드된 공용 IP 주소는 기본적으로 비영역입니다. 이러한 업그레이드를 수행하는 경우 이 점을 고려해야 합니다.

##모범 사례
- **표준으로 업그레이드**: 가능한 한 빨리 기본 Azure Load Balancer에서 표준 Azure Load Balancer로 업그레이드하는 것이 좋습니다. 표준 옵션은 기본 옵션에 비해 다양한 이점을 제공합니다. 여기에는 다음이 포함됩니다.
    - 99.99% SLA
    - 여러 인바운드 및 아웃바운드 프런트 엔드 지원
    - 가용성 영역 지원
    - HTTPS 프로토콜에 대한 상태 프로브 지원
    - 다양한 프런트엔드 구성
    - 더 큰 백엔드 풀 크기
- **여러 프런트 엔드 사용**: 여러 프런트 엔드를 사용하면 특정 포트 또는 IP 주소의 부하 분산에 지원되는 연결 수를 확장하는 데 도움이 됩니다. 또한 이 기능은 복원력을 높이기 위해 별도의 영역에 프런트 엔드를 설정함으로써 영역 중복성과 같은 더 많은 이점을 제공합니다.
- **Azure Firewall과 통합**: Azure Load Balancer를 Azure Firewall과 통합할 수 있습니다. 이를 통해 Azure Firewall의 위협 인텔리전스 기능을 사용하여 백 엔드 풀에서 웹 애플리케이션을 보호할 수 있습니다. 웹 애플리케이션을 사용하여 중요한 비즈니스 데이터를 관리하는 경우 알려진 위협과 진화하는 위협으로부터 보호하기 위해 이 기능을 사용하는 것이 좋습니다.
- **Network Watcher 설정**: Network Watcher는 Azure 서비스와 네트워크 수준의 문제를 식별, 분석 및 모니터링할 수 있는 Azure 서비스입니다. 로드 밸런서가 생성된 지역에 Network Watcher를 설정하고 네트워크에서 비정상적인 활동을 표시하도록 경고를 설정하는 것이 좋습니다.
- **NSG 규칙에서 서비스 태그 사용**: NSG 규칙을 사용하여 백 엔드 풀 리소스에 대한 인바운드 트래픽을 차단할 수 있습니다. 단, 로드 밸런서에서 발생하는 인바운드 트래픽은 제외됩니다. 부하 분산 장치는 여전히 백 엔드 풀 리소스와 연결하여 상태를 모니터링하고 트래픽을 라우팅할 수 있습니다. 그러나 해당 규칙이 NSG에서 업데이트되지 않으면 부하 분산 장치의 IP 주소를 변경하면 이 연결이 끊어질 수 있습니다. 이 문제를 해결하려면 서비스 태그를 사용할 수 있습니다. 이러한 Microsoft 관리형 태그에는 Azure 서비스와 연결된 모든 주소 접두사가 포함되어 있습니다. 이 경우 Microsoft는 AzureLoadBalancer 서비스 태그를 관리하고 최신 상태로 유지합니다. 관리 오버헤드를 완화하기 위해 NSG 규칙에서 IP 주소 대신 서비스 태그를 사용하는 것이 좋습니다.
- **Azure 활동 로그를 사용하여 서비스 변경 사항을 식별하고 추적**: Azure 활동 로그는 Azure Load Balancer 구성에 대한 변경 사항을 추적합니다. 로그는 90일 동안 저장됩니다. 중요한 변경 사항을 모니터링하고 변경 사항이 발생할 때 경고하도록 Azure 활동 로그를 설정하는 것이 좋습니다. 이를 통해 계획되지 않았거나 승인되지 않은 변경 사항을 사전에 해결할 수 있습니다.
- **중앙 보안 로그 관리 구성**: Azure 활동 로그를 90일 이상 유지하려면(예: 규정 준수, 분석 또는 참조 목적으로) 이러한 로그를 Azure Monitor와 통합하고 Log Analytics 작업 영역으로 내보내 분석을 수행합니다. 자동화된 분석 및 보안 사고에 대한 경고를 위해 Microsoft Sentinel과 같은 SIEM(보안 정보 및 이벤트 관리) 솔루션과 통합할 수도 있습니다.
- **로드 밸런서 메트릭에 대한 모니터링 및 경고 설정**: 표준 로드 밸런서는 로드 밸런서의 상태를 모니터링하고 상황에 따라 사전 대응이 필요할 때 경고를 설정하는 데 사용할 수 있는 다양한 주요 메트릭을 제공합니다. 일부 주요 지표에는 다음이 포함됩니다.
    - 데이터 경로(Data path) 가용성
    - 상태 프로브 상태
    - SNAT 연결 수
    - 할당된 SNAT 포트
    - 사용된 SNAT 포트
    - 패킷 수
    - 바이트 수
- 시간 경과에 따라 이러한 메트릭을 추적하려면 부하 분산 장치를 Azure Monitor 및 Log Analytics와 통합하는 것이 좋습니다. 이를 통해 서비스 응답 또는 설정과 관련된 문제를 식별할 수 있습니다.
- 부하 분산 장치와 함께 부하 분산 장치에서 사용하는 백 엔드 리소스에 대한 모니터링 및 경고를 설정하면 백 엔드 풀의 모든 서비스 문제를 해결할 수 있습니다.
- Azure는 Load Balancer Insights라는 Azure Load Balancer용 대시보드를 제공합니다. 이 대시보드는 로드 밸런서의 상태와 성능에 대한 자세한 통찰력을 제공합니다. 대시보드는 다음으로 구성됩니다.
    - 기능적 종속성 보기(Functional dependency view)
    - 메트릭 대시보드
    - 개요 탭
    - 프런트엔드 및 백엔드 가용성 탭
    - 데이터 처리량 탭
    - 흐름 분포(Flow distribution)
    - 연결 모니터
    - 메트릭 정의
