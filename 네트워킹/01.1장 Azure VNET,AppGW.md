#제1장 Azure 가상 네트워크


##라우팅
- Azure는 다양한 유형의 라우팅 유형을 지원합니다.
- 기본 시스템 경로 (Default system routes)
- 선택적 시스템 경로 (Optional system routes)
- 사용자 정의 경로 (User-defined routes)

기본 시스템 경로
- 기본 시스템 경로는 자동으로 생성되어 vNET의 모든 서브넷에 할당됩니다. 이러한 경로는 Azure 서비스 자체에서 생성되고 관리됩니다.

|소스|주소 접두사|다음 홉 유형|
|-|-|-|
|기본|vNET에 고유함|vNET|
|기본|0.0.0.0/0|인터넷|
|기본|10.0.0.0/8|없음|
|기본|192.168.0.0/16|없음|
|기본|100.64.0.0/10|없음|

- 기본 시스템 경로를 수동으로 수정, 추가 또는 삭제할 수 없습니다.
- vNET: 주소 공간에 여러 IP 범위 또는 서브넷이 포함된 경우 Azure는 각 서브넷에 대한 개별 경로를 만들고 게이트웨이를 사용할 필요 없이 서브넷 간에 트래픽을 라우팅합니다. 다음 홉 유형이 vNET인 경우 해당 IP 주소 범위에 대한 트래픽은 vNET 자체 내에 포함됩니다.
- 인터넷: 이는 경로 테이블에 정의된 특정 경로가 없는 모든 트래픽을 포함하여 인터넷으로 향하는 모든 트래픽의 기본 경로입니다. 이에 대한 유일한 예외는 대신 Microsoft Azure 백본 네트워크를 사용하여 라우팅되는 Azure 서비스에 대한 트래픽입니다.
- 없음(None): Azure는 다음 세 가지 예약된 주소 접두사에 대한 기본 경로를 자동으로 만듭니다. 다음 홉 유형이 없음이면 트래픽이 삭제되었음을 의미합니다.
    - 10.0.0.0/8 RFC 1918에서 개인용으로 예약되어 있습니다.
    - 192.168.0.0/16 RFC 1918에서 개인용으로 예약되어 있습니다.
    - 100.64.0.0/10 RFC 6598에 예약되어 있습니다.
- vNET 주소 공간에서 이러한 IP 주소 범위가 사용되는 경우 Azure는 해당 네트워크에 대한 트래픽 라우팅이 작동하도록 기본 경로 구성을 없음 대신 vNET으로 변경합니다.
- 트래픽이 서브넷에서 나가면 Azure는 대상 주소 접두사를 해당 주소 접두사에 대해 정의된 기본 경로와 일치시키고 그에 따라 경로를 지정합니다. 동일한 IP 주소 접두사에 대해 여러 경로가 정의되거나 겹치는 IP 접두사가 있는 경우 Azure에는 최선의 작업 과정을 결정하기 위한 미리 정의된 알고리즘과 논리가 있습니다.

선택적 시스템 경로
- 모든 서브넷에 추가되는 기본 경로 외에 특정 Azure 기능을 활성화한 후 선택적 경로가 추가됩니다. Azure는 활성화된 기능에 따라 특정 서브넷 또는 전체 vNET에 이러한 경로를 추가합니다.

|소스|주소 접두사|다음 홉 유형|경로가 추가되는 VNet 내의 서브넷|
|-|-|-|-|
|기본|vNET에 고유함(예: 10.10.10.0/24)|vNET 피어링|모두|
|vNET 게이트웨이|BGP를 통해 온프레미스에서 보급되거나 로컬 네트워크 게이트웨이에 구성된 접두사|vNET 게이트웨이|모두|
|기본|다수의|VirtualNetworkServiceEndpoint|서비스 엔드포인트가 활성화된 서브넷만|

- vNET 게이트웨이: vNET 게이트웨이가 vNET에 추가되면 게이트웨이 구성에 정의된 서브넷이나 BGP를 사용하여 온-프레미스 네트워크 게이트웨이에서 전파된 경로를 기반으로 선택적 경로가 추가됩니다
- 가능하다면 온프레미스 범위를 가장 큰 주소 범위로 통합하세요. 이렇게 하면 Azure 서비스 제한에 도달하지 않도록 가능한 적은 수의 경로를 전파할 수 있습니다.
- vNET 피어링: 피어링을 사용하여 다양한 Azure vNET을 연결할 수 있습니다. 피어링이 설정되면 각 주소 범위에 대한 경로가 경로 테이블에 추가됩니다.
- VirtualNetworkServiceEndpoint: 서비스 엔드포인트를 사용하여 Azure PaaS 서비스를 vNET에 통합하는 경우 Azure는 서비스 엔드포인트에 대한 경로를 경로 테이블에 추가합니다. Azure는 서비스 엔드포인트가 활성화된 서브넷에 대해서만 경로를 추가합니다. Azure는 서브넷 연결이 변경될 때 이 정보를 자동으로 유지 관리합니다.

커스텀 경로 (Custom routes)
- 기본 및 선택적 시스템 생성 경로와 시스템 관리 경로 외에도 요구 사항에 따라 온프레미스 네트워크 또는 기타 서비스로 트래픽을 전달하는 사용자 지정 경로를 설정할 수 있습니다. 이를 수행하는 방법에는 다음과 같은 두 가지가 있습니다.
    - 사용자 정의 경로
    - BGP(경계 게이트웨이 프로토콜) 경로

사용자 정의 경로
- 사용자 정의 경로는 Azure에서 만든 기본 시스템 경로를 재정의하기 위해 정의하거나 규정 준수 또는 모니터링 목적으로 환경의 특정 라우팅 요구 사항을 해결하기 위한 추가 경로로 정의하는 사용자 지정 경로입니다. 사용자 정의 경로를 생성하려면 일련의 라우팅 규칙이 포함된 경로 테이블을 생성합니다. 그런 다음 이 라우팅 테이블을 하나 이상의 서브넷과 연결합니다.
- 동일한 라우팅 테이블이 여러 서브넷과 연결될 수도 있고, 서로 다른 서브넷에 대해 서로 다른 라우팅 테이블이 있을 수도 있습니다. 그러나 단일 서브넷에는 연결된 사용자 정의 경로 테이블이 최대 1개만 있을 수 있습니다.
- 사용자 정의 경로는 시스템 정의 경로를 재정의하거나 함께 작동합니다. 이는 충돌이 발생할 경우 사용자 정의 경로가 시스템 정의 경로보다 우선한다는 것을 의미합니다.
- 사용자 정의 경로는 vNET, 인터넷, 없음 및 vNET 게이트웨이와 같은 기본 및 선택적 시스템 경로와 동일한 다음 홉 유형 중 일부를 지원합니다. 또한 방화벽과 같은 vNET 어플라이언스로 트래픽을 라우팅하는 가상 어플라이언스라는 다음 홉 유형을 지원합니다. 그러나 사용자 정의 경로는 vNET 피어링 VirtualNetworkServiceEndpoint 다음 홉 유형을 지원하지 않습니다.

BGP(경계 게이트웨이 프로토콜) 경로
- BGP 경로는 사용자 정의 경로의 또 다른 유형입니다. 이는 Azure 가상 게이트웨이 S2S VPN 또는 Azure ExpressRoute 연결을 사용하여 온-프레미스 네트워크와의 연결을 설정하는 시나리오에서만 지원됩니다.
- BGP 경로를 사용하면 온-프레미스 게이트웨이와 Azure VPN 게이트웨이 간의 연결이 설정될 때 초기 경로 교환이 발생합니다. 이를 통해 어느 쪽이든 수동 개입 없이 필요한 경로를 자동으로 전파하고 변경 사항이 발생할 때 이를 유지할 수 있습니다.

Azure에서 경로 선택
- 대상 IP 주소에 대해 단일 경로만 정의된 경우 사용 가능한 단일 경로를 사용해야 합니다. 그러나 동일한 대상 IP 주소에 대해 여러 경로가 존재하는 경우 Azure는 대상 IP 주소와 가장 밀접하게 일치하는 경로의 IP 주소 접두사를 식별해야 합니다. 여러 경로에 동일한 주소 접두사가 포함되어 있고 해당 IP 주소 접두사가 대상 IP 주소와 가장 밀접하게 일치하는 경우 Azure는 다음 우선 순위에 따라 순서대로 경로를 선택합니다.
    1. 사용자 정의 경로.
    2. BGP 경로.
    3. 기본 또는 선택적 시스템 경로.

NSG(네트워크 보안 그룹)
- NSG를 사용하여 Azure vNET의 Azure 리소스에 대한 인바운드 및 아웃바운드 트래픽 필터링 규칙을 설정할 수 있습니다. 인바운드 또는 아웃바운드 트래픽을 허용하거나 거부하고 소스 및 대상, 포트, 프로토콜과 같은 기타 매개변수를 식별하도록 각 규칙을 설정할 수 있습니다.
- NSG는 서브넷 수준에 적용되고 다른 NSG는 Azure VM과 같은 리소스 수준에 적용될 수 있습니다. 이러한 시나리오에서는 두 NSG에 구성된 규칙에 따라 트래픽이 평가되고 둘 중 더 제한적인 작업이 적용됩니다.

가용성 영역 지원
- vNET은 정의된 Azure 지역의 모든 가용성 영역에 걸쳐 있습니다. 다양한 가용성 영역에 분산시킬 필요도 없고 가능성도 없습니다. 이것은 의도적으로 설계된 것입니다. 가용성 영역을 사용하도록 설정된 모든 리소스는 추가 구성 없이 동일한 vNET을 사용할 수 있습니다.

vNET 네트워크 주소 변환(NAT)
- NAT는 고정 공용 IP 주소 집합을 사용하여 특정 내부 호스트 간에 인바운드 또는 아웃바운드 트래픽을 라우팅하는 데 도움이 됩니다. Azure vNET NAT의 경우 아웃바운드 인터넷 기반 트래픽은 단일 또는 고정 공용 IP 주소 범위를 통해 라우팅됩니다. 이렇게 하면 고정 아웃바운드 IP가 필요하거나 아웃바운드 트래픽 라우팅을 위해 로드 밸런를 사용하는 각 VM에 공용 IP 주소를 연결할 필요가 없습니다.
- vNET의 단일 또는 다중 서브넷에 대해 NAT를 설정할 수 있습니다. 모든 서브넷은 동일한 NAT를 사용하거나 vNET의 모든 서브넷에 대해 별도의 NAT를 설정할 수 있습니다. 정의되면 NAT가 서브넷의 기본 인터넷 대상으로 설정됩니다.

보안 강화를 위한 통합
- Azure vNET은 Azure PaaS 서비스와의 통합을 지원하여 특정 네트워크 및 엔드포인트에서 서비스에 대한 액세스를 제한합니다. 환경의 액세스 요구 사항에 따라 다음 방법 중 하나를 사용하여 이를 달성할 수 있습니다.
- 전용 vNET 또는 서브넷 분할을 사용한 네트워크 격리: Azure 서비스를 배포할 전용 vNET을 생성하고 조직의 보안 요구 사항에 따라 NSG 또는 Azure 방화벽 서비스를 사용하여 트래픽을 제어할 수 있습니다. 또한 서브넷을 분할하여 자체 서브넷에 서비스를 생성하고 필요에 따라 액세스를 제한하도록 NSG를 설정할 수도 있습니다.
- 프라이빗 엔드포인트 및 프라이빗 링크: 프라이빗 엔드포인트 및 프라이빗 링크 서비스를 사용하면 공용 인터넷 대신 내부 네트워크를 통해 Azure 서비스에 대한 개인 액세스를 활성화할 수 있습니다. 피어링된 Azure 네트워크 및 상호 연결된 온-프레미스 네트워크를 통해 Azure PaaS 서비스에 안전하게 연결할 수 있습니다. 이는 내부 네트워크에서 Azure 서비스로의 단방향 통신이며 PaaS 서비스에서 온-프레미스 리소스로의 아웃바운드 연결을 지원하지 않습니다.
- 서비스 엔드포인트: 서비스 엔드포인을 사용하면 모든 인터넷 기반 끝점에 서비스를 완전히 노출하지 않고도 Azure 백본을 통해 Azure PaaS 서비스에 액세스할 수 있습니다. Azure vNET을 서비스에 연결된 서비스 엔드포인트와 통합할 수 있으므로 고객 환경에서도 서비스에 대한 보안 액세스를 제공할 수 있습니다.

서비스 태그
- 서비스 태그는 다양한 Azure 서비스를 위해 Microsoft에서 만들고 관리하는 사전 정의된 IP 주소 그룹입니다. 예를 들어 AzureActiveDirectory 서비스 태그에는 Azure Active Directory 서비스에서 사용하는 모든 IP 주소 접두사가 포함되어 있습니다. 시간이 지남에 따라 서비스의 IP 주소 접두사가 변경되면 서비스 태그는 네트워크 액세스 제어를 정의하는 데 사용될 때 변경 사항을 자동으로 기록합니다.
- VirtualNetwork 서비스 태그는 vNET, 피어링된 vNET, VPN 또는 ExpressRoute를 통해 연결된 온-프레미스 주소 공간, 기본 및 사용자 정의 경로와 연결된 모든 IP 주소 접두사를 정의합니다.

재해 복구 계획
- 재해로 인해 Azure 지역이 오프라인 상태가 되면 해당 지역의 vNET을 다른 지역에서 자동으로 사용할 수 없습니다. 이러한 시나리오에 직면한 경우 고려해야 할 몇 가지 옵션이 있습니다.
- 다른 Azure 지역에서 동일한 vNET 주소 공간과 서브넷을 미리 구성할 수 있습니다. 그러나 두 지역은 네트워크 주소가 겹쳐서 서로 연결되거나 통신할 수 없습니다.
- 다른 Azure 지역에서 다른 vNET 주소 공간 및 서브넷 구성을 설정하고 필요한 경우 모든 관련 Azure 리소스를 복제, 미리 생성 또는 자동으로 프로비저닝할 수 있습니다. 이러한 시나리오에서는 두 지역이 서로 연결되어 통신할 수 있습니다. 각 워크로드에 대한 중복성을 계획하는 동안 리소스 수준 충돌을 별도로 고려해야 합니다.

#제 2장 Azure 애플리케이션 게이트웨이


##개요
- 내부 전용 Azure 애플리케이션 게이트웨이: 이는 내부 가상 네트워크(vNET)를 통해서만 애플리케이션에 액세스해야 하는 환경에 이상적입니다. 게이트웨이에는 내부 IP 주소가 있으며 이에 대한 DNS 레코드는 클라이언트 연결을 위해 vNET을 통해서만 액세스할 수 있는 내부 또는 사용자 지정 DNS 서버 또는 서비스에 설정됩니다.
- 인터넷 연결 Azure 애플리케이션 게이트웨이: 게이트웨이를 공개적으로 노출하는 공용 IP가 있습니다. 따라서 클라이언트는 인터넷을 통해 공개적으로 백엔드 애플리케이션에 액세스할 수 있습니다. 공용 부하 분산 장치의 DNS 이름은 Azure 서비스에 의해 공용 DNS에 추가됩니다.

##Azure 애플리케이션 게이트웨이 기능
- **WAF(웹 애플리케이션 방화벽)**: Azure Application Gateway는 WAF 역할을 하여 클라이언트에서 들어오는 트래픽을 모니터링하고 악의적인 활동을 가로채서 사용자 환경의 여러 웹 애플리케이션에 대해 잘 알려진 취약성으로부터 중앙 집중식 보호를 제공할 수 있습니다. 아직 웹 서버 자체의 취약점을 패치할 수 없더라도 WAF 뒤에서 애플리케이션을 호스팅할 수 있습니다. WAF를 패치하면 알려진 취약점으로부터 패치가 필요한 애플리케이션이나 대규모 서버 팜을 중앙에서 보호할 수 있습니다. 이는 애플리케이션이나 서버 팜 자체가 업데이트될 때까지 임시 솔루션 역할을 합니다.
    - WAF 규칙은 OWASP(Open Web Application Security Project) 핵심 규칙 세트 3.1(WAF v2), 3.0(WAF v1 및 v2), 2.2.9(WAF v1 및 v2)를 기반으로 합니다.
- **다중 사이트 호스팅**: Azure Application Gateway는 동일한 애플리케이션 게이트웨이에서 여러 호스트, 도메인 또는 하위 도메인 이름의 사용을 지원합니다. 따라서 단일 애플리케이션 게이트웨이를 사용하여 여러 웹 애플리케이션에 대한 웹 트래픽을 처리할 수 있습니다. 이를 통해 각 인스턴스를 최대한 활용하여 서비스에 대한 투자를 극대화할 수 있습니다. 100개가 넘는 웹 애플리케이션을 단일 애플리케이션 게이트웨이에 매핑할 수 있습니다. 또한 다중 사이트 수신기를 사용하면 단일 공용 IP로 전송된 트래픽을 URL 요청 또는 호스트 헤더를 기반으로 다양한 백엔드 서버 풀로 라우팅할 수 있습니다.
- **웹 트래픽 리디렉션**: 한 포트에 대한 웹 트래픽을 다른 포트로 리디렉션하면 웹 애플리케이션 서버에서 내부적으로 사용되는 애플리케이션 포트를 마스킹할 수 있으므로 웹 애플리케이션의 보안이 향상될 수 있습니다. 또한 트래픽 리디렉션을 사용하면 중앙에서 HTTP 트래픽을 HTTPS로 라우팅하여 클라이언트와 웹 서비스 간에 암호화되지 않은 통신이 발생하지 않도록 할 수 있습니다. 웹 트래픽 리디렉션은 다음 시나리오를 지원합니다.
    - **전역 트래픽 리디렉션**: 이 유형의 리디렉션을 사용하면 모든 트래픽을 HTTP에서 사이트의 HTTPS로 리디렉션하거나 웹 응용 프로그램에 필요한 기타 비표준 포트로 리디렉션할 수 있습니다.
    - **경로 기반 리디렉션**: 이 유형의 리디렉션을 사용하면 `/videos/*` 또는 `/checkout/*`에 대한 트래픽과 같은 특정 사이트 영역에서만 HTTP를 HTTPS 또는 기타 비표준 포트로 리디렉션할 수 있습니다.
    - **외부 사이트로 리디렉션**: 이 유형의 리디렉션을 사용하면 트래픽을 외부 사이트로 리디렉션할 수 있습니다.
- **SSL/TLS(Secure Sockets Layer/Transport Layer Security) 종료**: Azure Application Gateway를 사용하여 웹 애플리케이션에 대한 SSL/TLS 처리를 오프로드할 수 있습니다. 이는 SSL/TLS 암호화/암호 해독의 오버헤드와 서버 리소스 소비를 줄이는 데 도움이 됩니다. 애플리케이션 게이트웨이와 그 뒤에 내부적으로 호스팅되는 웹 애플리케이션 간의 트래픽은 암호화되지 않을 수 있습니다. 그러나 일부 시나리오에서는 규정 준수 또는 애플리케이션 설계상의 이유로 백엔드 트래픽을 암호화해야 할 수도 있습니다. Azure Application Gateway는 이러한 유형의 종단 간 암호화 시나리오도 지원합니다.
- **세션 선호도 처리**: 쿠키 기반 세션 선호도를 지원하도록 Azure Application Gateway를 설정하면 중단되거나 삭제된 모든 세션이 이전과 동일한 서버에 다시 연결되도록 할 수 있습니다. 이는 사용자의 세션 상태가 서버에 로컬로 저장되는 일부 애플리케이션의 경우 중요한 요구 사항일 수 있습니다.
- **고정 VIP(가상 IP) 할당**: Azure Application Gateway의 Standard_v2 버전은 고정 VIP 주소 사용을 지원하여 VIP가 애플리케이션 게이트웨이 수명 동안 그대로 유지되도록 합니다.
- **영역 중복성**: 여러 가용성 영역에 걸쳐 Azure Application Gateway를 설정하여 게이트웨이의 SLA 및 복원력을 향상시킬 수 있습니다.
    - 현재 Azure Application Gateway의 Standard_v2 버전만 영역 중복성을 지원합니다.
- **경로 기반 라우팅**: 들어오는 웹 요청에 표시된 경로를 기반으로 트래픽을 분석하고 라우팅할 수 있습니다. 요청에서 찾은 경로를 기반으로 트래픽을 다른 백 엔드 서버 또는 서버 풀로 라우팅하도록 애플리케이션 게이트웨이를 설정할 수 있습니다. 따라서 다양한 URL 경로에 대한 콘텐츠를 다양한 서버 또는 서버 풀에서 호스팅할 수 있으며 콘텐츠 자체를 최적화하여 가능한 최상의 최종 사용자 경험을 제공할 수 있습니다.
- **자동 크기 조정**: Azure Application Gateway를 설정하여 언제든지 트래픽 부하에 따라 자동으로 확장하거나 축소할 수 있습니다. 애플리케이션 게이트웨이를 프로비전할 때 애플리케이션 게이트웨이에 대한 "완벽한" 크기를 선택할 필요는 없습니다. 시간이 지남에 따라 트래픽이 증가함에 따라 게이트웨이가 필요에 따라 확장될 수 있기 때문입니다.
- **WebSocket 및 HTTP/2 트래픽 지원**: Azure Application Gateway는 기본적으로 WebSocket 및 HTTP/2 프로토콜을 지원합니다. WebSocket은 기본적으로 활성화되어 있으며 끌 수 없습니다. 이는 장기 실행 TCP 연결을 통해 웹 애플리케이션 서버와 클라이언트 간의 전이중 통신을 허용하며, 이는 여러 요청 및 응답에 최적화되고 사용될 수 있습니다. HTTP/2 프로토콜은 클라이언트-애플리케이션 게이트웨이 통신에만 사용할 수 있습니다. HTTP/2는 장기 실행 세션을 유지하기 위해 HTTP에 필요한 지속적인 폴링의 필요성을 제거함으로써 HTTP 기반 통신보다 더 효율적으로 작동하도록 설계되었으며, 이는 클라이언트 통신에 대한 애플리케이션 게이트웨이의 오버헤드를 줄입니다. 두 프로토콜 모두 포트 80 및 443에서 작동하도록 설계되었으므로 방화벽을 변경하지 않고도 환경에 쉽게 통합할 수 있습니다.

##모범 사례
- **조직 전체에서 고유한 주소 공간을 식별**: 온-프레미스 또는 기타 연결된 클라우드 환경에서 이미 사용 중인 다른 주소 공간과 중복되지 않는 Azure 주소 공간을 사용해야 합니다. 필요한 경우 동일한 주소 공간을 사용할 수 있지만 라우팅 문제를 방지하려면 신중한 계획, 실행 및 유지 관리가 필요합니다.
- **장기간 사용을 위한 주소 공간 크기 조정**: Azure에서 주소 공간 크기를 조정할 때는 장기적인 목표와 요구 사항을 고려하세요. 나중에 확장할 여지가 없으므로 서브넷의 모든 주소 범위를 즉시 사용하지 마십시오. 나중에 vNET에 더 많은 주소 공간을 추가할 수 있지만 초기 계획 중에 이를 고려하면 향후 문제를 줄일 수 있습니다.
- **더 적은 수의 더 큰 vNET으로 통합**: 여러 vNET을 연결할 수도 있지만 필요한 요구 사항을 충족하는 더 적은 수의 더 큰 vNET을 갖도록 통합하는 것이 더 좋습니다. 이를 통해 환경의 복잡성과 관리 오버헤드가 줄어듭니다.
- **내부 트래픽 보안**: NSG를 사용하여 Azure와 온-프레미스 네트워크 간의 내부 트래픽을 보호함으로써 서로 통신할 수 있는 네트워크만 필요한 네트워크인지 확인합니다. 자체 서브넷 또는 vNET에서 중요한 네트워크를 격리하고 해당 서브넷 또는 vNET에 대한 액세스가 필요한 원본 및 대상 끝점, 프로토콜 및 포트로만 제한되도록 합니다. 마지막으로 모든 내부 통신이 완전한 개인 네트워크를 통해 라우팅되어야 하는 경우 S2S VPN 대신 Azure ExpressRoute를 사용하세요.
- **DDoS 공격으로부터 보호**: Azure Firewall 및 Azure Security Center를 사용하여 알려진 악성 IP 범위에서 DDoS(분산 서비스 거부) 공격을 탐지하고 방지합니다. 이러한 위협이 감지되면 자동으로 대응하도록 환경을 설정하거나 간단히 경고하여 수동으로 조치를 취할 수 있습니다.
- **Log Analytics를 사용하여 vNET 흐름 로그를 분석**: vNET 보안 및 라우팅 설정에 대해 더 나은 결정을 내릴 수 있도록 Log Analytics 통합을 설정하면 vNET의 트래픽에 대한 심층적인 가시성을 얻을 수 있습니다.
- **Azure Firewall의 위협 인텔리전스 기능 사용**: Azure Firewall은 Microsoft 위협 인텔리전스 피드에 연결되어 있으며, 전 세계적으로 진행 중인 새로운 위협 벡터와 관련하여 다양한 소스에서 지속적으로 업데이트됩니다. Azure vNET에 연결된 방화벽 인스턴스에 대해 이 기능을 활성화하면 인터넷에서 알려진 악의적인 행위자로부터 환경을 더 잘 보호할 수 있습니다.
- **서비스 태그를 사용하여 네트워크 보안 규칙의 복잡성을 줄이기**: 서비스 태그는 Azure 서비스와 관련된 트래픽 규칙을 관리하는 좋은 방법입니다. vNET 내 통신에 잠재적으로 영향을 줄 수 있는 서비스 변경 사항을 추적하고 유지 관리하는 관리 오버헤드를 줄이려면 가능하면 서비스 태그를 사용하십시오.
- **태그를 사용하여 vNET 구성 문서화**: 다양한 구성 요소와 vNET 보안 규칙에 레이블을 지정하여 필요에 따라 쉽게 식별하거나 필터링할 수 있습니다.
- **Azure Policy를 사용하여 vNET 구성 표준화**: Azure 정책은 정책 요구 사항, 정책 설명서 등을 포함한 vNET 보안 표준을 적용하여 조직 전체의 모든 vNET이 동일한 지침 집합으로 생성되도록 하는 데 도움이 됩니다.
- **자동화된 로깅 및 모니터링 사용**: Azure 활동 로그 및 Azure Monitor를 사용하여 구성 변경과 같은 Azure vNET의 이벤트를 추적하고 경고할 수 있습니다. 환경에 해로운 영향을 미칠 수 있는 중요한 이벤트에 대한 경고를 설정하는 것이 좋습니다. 또한 Azure Log Analytics를 통합하여 기록 보고 및 비교를 위해 장기간 로그를 저장할 수도 있습니다.

##설계 개념 및 배포 고려 사항
- Azure Application Gateway 서비스의 주요 구성 요소는 다음과 같습니다
    - Front-end IP addresses
    - Back-end pools
    - Listeners
    - Request routing rules
    - HTTP settings
    - Health probes

<img src="https://drive.google.com/uc?id=1pJlZohLQIB28JPumSzNCbQStVghVxi4e">

프런트엔드 IP 주소
- 프런트 엔드 IP 주소는 애플리케이션 게이트웨이가 웹 애플리케이션 트래픽을 수신하는 수신 지점입니다. 이는 내부 및/또는 공용 DNS에서 참조되며 애플리케이션 트래픽을 라우팅하는 데 사용됩니다. 프런트 엔드 IP 주소는 내부 개인 IP 주소, 공용 IP 주소 또는 둘 다일 수 있습니다.
- 개인 IP 주소를 사용하려면 게이트웨이가 연결된 vNET과 동일한 지역에 배포되어야 합니다. 마찬가지로 애플리케이션 게이트웨이와 동일한 지역에 프런트 엔드 IP 주소로 연결되어야 하는 공용 IP를 만들어야 합니다.

백엔드 풀
- 백엔드 풀은 클라이언트의 웹 트래픽 요청이 라우팅되는 백엔드 서버 또는 서비스입니다. 애플리케이션 게이트웨이를 통해 필요한 애플리케이션 응답으로 클라이언트 요청을 제공합니다.
- 백엔드 풀은 다음 유형의 서비스를 지원합니다.
    - 가상 네트워크 인터페이스
    - VMSS(가상 머신 확장 집합)
    - Azure VM(가상 머신) 또는 서비스와 연결된 공용 IP 주소
    - Azure 또는 온-프레미스 서버 또는 서비스와 연결된 내부 IP 주소
    - FQDN(정규화된 도메인 이름)
    - App Service와 같은 Azure 서비스
- 백 엔드 풀은 Azure 지역, 다양한 클러스터 또는 클라이언트 또는 타사 데이터 센터의 Azure 외부에 위치할 수 있습니다. 애플리케이션 게이트웨이가 TCP/IP를 통해 백 엔드 엔드포인트에 도달할 수 있는 한 해당 웹 애플리케이션에 대한 프런트 엔드 역할을 할 수 있습니다.
- 온프레미스 서버와 통신하려면 VPN 게이트웨이 또는 Azure ExpressRoute 연결이 필요합니다. 개인 내부 IP를 통해 Azure VM 및 서비스와 통신하려면 vNET 피어링 또는 VPN 게이트웨이 통합이 필요합니다.

수신기
- 모든 애플리케이션 게이트웨이에는 최소한 하나의 수신기가 필요하며 여러 수신기를 포함할 수 있습니다. 수신기는 백엔드 풀과 통신할 수 있는 프로토콜, 포트, 호스트 이름 및 소스 IP 주소를 정의하는 데 도움이 됩니다. 애플리케이션 게이트웨이에 정의된 수신기 구성에 따라 트래픽이 통과되거나 삭제됩니다. 수신기가 트래픽 통과를 허용하는 경우 게이트웨이는 트래픽을 올바른 백엔드 풀로 라우팅하도록 구성된 라우팅 규칙에 대해 이를 평가합니다.
- 수신기에는 두 가지 유형이 있습니다.
    - 기본: 기본 리스너는 단일 도메인에 대한 요청만 수신할 수 있습니다.
    - 다중 사이트 :다중 사이트 수신기는 여러 호스트 이름이나 도메인 이름에 대한 요청을 수신할 수 있습니다. 이 유형의 수신기는 100개 이상의 웹 사이트를 지원할 수 있으며 이를 자체 백엔드 풀로 라우팅할 수 있습니다.
- 다음 프로토콜을 지원합니다.
    - HTTP
    - HTTPS
    - HTTP/2
    - 웹소켓
- WebSocket 프로토콜 지원은 기본적으로 활성화되어 있으며 끌 수 없습니다.
- HTTP/2 프로토콜 지원은 기본적으로 비활성화되어 있으며 수동으로 활성화해야 합니다.
- HTTP/2 프로토콜 지원은 클라이언트 및 애플리케이션 게이트웨이 통신으로 제한됩니다. 모든 백엔드 통신은 HTTP/1.1을 통해 발생합니다.

요청 라우팅 규칙
- 요청 라우팅 규칙은 애플리케이션 게이트웨이에서 수신한 트래픽을 라우팅하는 방법을 정의합니다. 요청에서 모니터링하기 위해 정의된 HTTP 설정을 기반으로 리스너를 백엔드 서버 풀에 바인딩합니다. 하나의 리스너는 하나의 규칙에만 연결할 수 있습니다.
- 백 엔드 풀로의 라우팅은 어떤 백 엔드 풀이 어떤 URL 또는 URL 경로에 바인딩되는지 정의하는 규칙 구성에 따라 달라집니다. 또한 라우팅 규칙은 요청이 백 엔드 풀로 라우팅되기 전에 다시 작성되어야 하는지 여부도 지정합니다.
- 요청 라우팅 규칙에는 두 가지 유형이 있습니다.
    - 기본: 기본 요청 라우팅 규칙은 규칙과 연결된 HTTP 설정을 기반으로 모든 트래픽을 연결된 백 엔드 풀로 전달합니다.
    - 경로 기반: 경로 기반 요청 라우팅 규칙은 요청의 URL 경로를 분석하여 요청을 라우팅할 백엔드 풀을 식별합니다. 규칙에는 다양한 백엔드 풀로 라우팅하도록 설정된 다양한 URL 경로가 포함되어 있습니다. 들어오는 요청이 규칙과 일치하지 않는 경우 트래픽은 연결된 HTTP 설정에 따라 기본 백엔드 풀로 라우팅됩니다.
- 요청 라우팅 규칙은 해당 규칙에 할당된 우선순위에 따라 평가됩니다. 기본적으로 우선순위는 규칙 생성 순서에 따라 자동으로 할당됩니다(규칙 생성 시 특정 우선순위가 제공되거나 나중에 설정되지 않는 한).
- `*.fabrikam.com` 및 `blogs.fabrikam.com`과 같이 중복되는 도메인을 포함하는 규칙이 있는 경우 우선 순위를 고려하는 것이 중요합니다. 이러한 경우 개별 도메인 규칙이 와일드카드 규칙보다 먼저 평가되도록 와일드카드 규칙의 우선 순위를 낮춰야 합니다. 그렇지 않으면 요청이 와일드카드 도메인과 연결된 백엔드 풀로만 라우팅됩니다.

리디렉션 지원
- 트래픽을 백엔드 풀로 라우팅하는 것 외에도 요청 라우팅 규칙을 설정하여 모든 포트에서 리디렉션 대상으로 트래픽을 리디렉션할 수 있습니다. 리디렉션은 다른 수신기나 외부 사이트로 이루어질 수 있습니다. 리디렉션 라우팅은 HTTP 트래픽을 HTTPS로 리디렉션하거나 표준 웹 포트(예: 80)에서 비표준 포트로 트래픽을 리디렉션하는 데 도움이 됩니다.
- Azure Application Gateway는 다양한 유형의 리디렉션을 지원합니다.
    - 310 영구(Permanent 리디렉션
    - 302 Found
    - 303 See Other
    - 307 임시(Temporary) 리디렉션

HTTP 헤더 및 URL 재작성
- Azure 애플리케이션 게이트웨이를 사용하면 패킷이 백 엔드 풀로 전송되기 전에 HTTP 요청 및 응답 헤더를 수정할 수 있습니다. 따라서 XFF(X-Forwarded-For) 헤더의 포트 정보와 같은 중요한 헤더 정보를 제거하여 사용자 정의 보안 헤더 필드로 URL을 다시 작성할 수 있습니다. 이 기능은 특정 조건이 충족되는 경우에만 이러한 변경 사항을 적용할 수 있으므로 필요에 따라 복잡한 시나리오를 해결하기 위해 재작성을 대상으로 할 수 있습니다.

HTTP 설정
- HTTP 설정은 백엔드 서버의 포트 번호, 프로토콜, 암호화 설정 및 기타 세부 정보를 정의합니다. 애플리케이션 게이트웨이는 일치하는 요청을 받을 때 이러한 설정을 사용하여 트래픽을 백 엔드 서버로 라우팅합니다.
- HTTP 설정은 다음과 같은 다른 설정을 정의하는 데에도 사용됩니다.
    - 쿠키 기반 세션 선호도: 이 설정은 선호도를 사용하여 항상 동일한 클라이언트의 요청을 동일한 호스트로 라우팅하도록 게이트웨이에 지시합니다(호스트가 온라인이라고 가정).
    - 연결 드레이닝: 이 설정은 유지 관리를 위해 연결이 중단될 수 있으므로 애플리케이션 게이트웨이에 백 엔드 서버의 연결을 정상적으로 드레이닝하도록 지시합니다.
    - 사용자 지정 상태 프로브: 이 설정은 게이트웨이가 백 엔드 풀 상태의 유효성을 검사하는 방법을 이해하는 데 도움이 됩니다.

상태 프로브
- 백엔드 풀 인스턴스의 상태를 모니터링하는 것은 중요한 기능입니다. 이는 서비스가 상태가 양호하고 요청 라우팅에 사용할 수 있는 백엔드 풀 인스턴스와 애플리케이션 중단을 방지하기 위해 서비스를 중단해야 하는 인스턴스를 결정하는 데 도움이 됩니다. 상태 프로브는 비정상 백 엔드 풀 인스턴스를 식별하는 데 도움이 되는 호스트 이름, URL 경로, 프로브 간격 및 실패한 응답 제한을 애플리케이션 게이트웨이에 제공합니다. 애플리케이션 게이트웨이는 기본적으로 상태 모니터링을 수행합니다. 그러나 사용자 지정 상태 프로브는 게이트웨이가 인스턴스 상태를 평가하기 위해 올바른 매개 변수를 대상으로 지정하는 데 도움이 됩니다. 따라서 각 개별 백엔드 풀에 대해 사용자 지정 상태 프로브를 정의하는 것이 좋습니다.

TLS 정책
- Azure Application Gateway를 사용하면 SSL/TLS를 오프로드할 수 있습니다. 이러한 방식으로 클라이언트의 SSL 연결은 애플리케이션 게이트웨이에서 종료되고, 애플리케이션 백엔드와의 내부 통신은 암호화되거나 암호화 해제될 수 있습니다(따라서 애플리케이션 인스턴스의 오버헤드가 줄어듭니다). 암호화되지 않은 방식으로 애플리케이션 게이트웨이와 통신하도록 백 엔드 인스턴스가 설정된 경우 애플리케이션 인증서는 애플리케이션 게이트웨이에서만 배포 및 관리될 수 있습니다. 이를 통해 추적, 유지 관리 및 업데이트가 더 쉬워집니다.
- TLS 정책은 TLS 핸드셰이크 중에 사용할 다양한 TLS 프로토콜 버전과 암호 제품군을 정의합니다. 암호 순서는 핸드셰이크 시 평가되는 순서를 지정합니다. 이를 제어하는 두 가지 메커니즘이 있습니다.
    - 미리 정의된 TLS 정책 사용 모든 응용 프로그램 게이트웨이 인터페이스에는 세 가지 미리 정의된 TLS 정책이 포함되어 있습니다. 각 정책은 서로 다른 TLS 프로토콜 버전과 암호화 제품군을 지원하도록 정의되어 있습니다. 정책 이름은 정책이 도입된 날짜를 나타냅니다. 최신 버전을 사용하는 것이 좋습니다.
    - 사용자 정의 TLS 정책 사용 사전 정의된 정책이 요구 사항을 충족하지 않는 경우 필요에 따라 TLS 프로토콜 및 암호 제품군(및 우선 순위)을 포함하도록 정책을 사용자 정의할 수 있습니다.
- 사전 정의된 TLS 정책과 사용자 정의된 TLS 정책을 모두 사용하면 SSL 2.0 및 3.0이 비활성화되도록 설정되며 이를 재정의할 수 없습니다. 그러나 사용자 정의 정책을 사용하면 세 가지 TLS 프로토콜 버전(v1_0, v1_1 또는 v1_2) 중 하나를 최소 필수 버전으로 설정할 수 있습니다. 필요한 경우 최소 요구 사항 없이 이 세 가지를 모두 설정할 수도 있습니다.

##모범 사례
- **리소스 부족을 방지하기 위해 인스턴스 수를 모니터링하고 계획**: Azure Application Gateway v2는 자동 크기 조정을 지원하지만 Azure Application Gateway v1을 사용하는 경우 수동으로 크기를 조정해야 합니다. v1 SKU는 최대 32개의 인스턴스 확장을 지원합니다. 올바른 인스턴스 수를 식별하려면 최소 한 달 동안 애플리케이션 게이트웨이에 대한 CPU 사용률을 모니터링하고 최대 CPU 사용량을 식별합니다. 그런 다음 예상치 못한 급증 및 증가를 처리하기 위해 15%~20%의 버퍼를 추가합니다. 마지막으로 이 크기에 따라 인스턴스 수를 선택합니다.
- **가능한 한 빨리 v2 SKU로 업그레이드**: Azure Application Gateway v1은 수동 크기 조정만 지원합니다. 이는 게이트웨이 인스턴스를 관리하는 가장 효율적이거나 비용 효과적인 방법이 아닙니다. 자동 크기 조정 외에도 v2 SKU는 SSL/TLS 오프로딩, 향상된 배포 성능, 영역 중복성 등을 포함한 기타 성능 이점을 제공합니다. 가능한 한 빨리 v2 SKU로 업그레이드해야 이러한 모든 기능과 기타 기능을 활용할 수 있습니다.
- **v2 SKU에서 최대 인스턴스 수 설정**: v2 SKU는 자동 크기 조정을 지원하고 사용된 단위 수에 따라 요금이 부과되므로 최대 인스턴스 수를 설정할 때 예산 요구 사항을 고려하는 것이 중요합니다. v2 SKU는 최대 125개의 인스턴스를 지원합니다. 즉, 계획되지 않은 급증으로 인해 예산보다 더 많은 인스턴스가 활성화될 수 있습니다.
- **향후 확장성을 고려하여 게이트웨이 서브넷 크기 조정**: 향후 확장성 요구 사항을 고려하여 애플리케이션 게이트웨이 인스턴스를 호스팅할 서브넷 크기를 조정합니다. 서브넷 구성 변경은 현재 지원되지 않으며 서비스를 다시 배포해야 하므로 중단될 수 있습니다.
- **v2 SKU에 대한 최소 인스턴스 수를 설정**: Auto Scaling에 시간(보통 6~7분)이 걸릴 때 트래픽을 수용하기 위해 추가 인스턴스를 온라인으로 가져옵니다. 이 기간 동안 예상치 못한 급증이 발생하면 트래픽이 감소하거나 응답 지연 시간이 길어질 수 있습니다. 최소 한 달 동안 CPU 사용량을 모니터링하여 필요한 최소 인스턴스를 파악하고, 예상치 못한 급증을 허용하려면 15 ~ 20%의 버퍼를 유지해야 합니다.
- **모니터링 및 경고**: 다양한 게이트웨이 지표에 대한 경고를 설정하여 CPU 사용량, 인스턴스 확장 및 네트워크 사용률을 모니터링하면 잠재적인 중단을 유발할 수 있는 이상 현상에 대한 알림을 받을 수 있습니다. 경고의 예로는 일정 기간 동안 75%~80%까지 급증하는 평균 CPU 사용량, 실패한 요청이 너무 많음, 게이트웨이가 응답하지 않음, 수많은 4xx 또는 5xx 오류(응답 문제를 나타냄)가 포함된 로그, 비정상 백엔드 호스트가 너무 많을 수 있습니다.
- **원하지 않는 국가/지역을 차단하도록 지역 필터링을 설정**: v2 SKU는 지역 필터링을 지원하므로 특정 국가 또는 지역의 트래픽을 허용하거나 차단할 수 있습니다. 공격 표면을 줄이기 위해 특정 로캘의 트래픽이 웹 애플리케이션에 연결되는 것을 방지(또는 허용)하려면 이 기능을 사용하는 것이 좋습니다.
- **공격 방지를 위한 봇 보호 설정**: v2 SKU에는 알려진 봇 네트워크의 트래픽을 방지하는 기능이 있습니다. 알려진 악성 트래픽이 웹 애플리케이션에 도달하기 전에 차단하려면 이 기능을 활성화하십시오.
- **진단 로깅 및 장기 보존 설정**: 애플리케이션 게이트웨이 인스턴스에 대한 방화벽, 성능 및 액세스 로그를 수집하고 Azure Storage, Log Analytics 또는 이벤트 스트림에 저장합니다. 이러한 로그는 잠재적인 문제를 식별하고 사전 조치를 취하는 데 도움이 될 수 있습니다. 조직의 과거 데이터 스토리지 비교 및 규정 준수 요구 사항을 기반으로 보존 정책을 설정하세요.
- **추가 보안을 위해 최신 TLS 정책 버전을 설정**: 최신 TLS 정책 버전(현재 AppGwSslPolicy20170401S)을 사용하여 TLS 1.2 및 더 강력한 암호를 적용합니다.
